#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import asyncio
import logging
import random
import json
import os
from typing import List, Dict, Any
from datetime import datetime

import telegram
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, LabeledPrice
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, CallbackContext, PreCheckoutQueryHandler
from telegram.constants import ParseMode

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ä–æ–ª–µ–π
ROLE_MAFIA_DON = "–î–æ–Ω –ú–∞—Ñ–∏–∏"
ROLE_MAFIA = "–ú–∞—Ñ–∏–æ–∑–∏"  
ROLE_DOCTOR = "–î–æ–∫—Ç–æ—Ä"
ROLE_COMMISSIONER = "–ö–æ–º–∏—Å—Å–∞—Ä"
ROLE_MANIAC = "–ú–∞–Ω—å—è–∫"
ROLE_PROSTITUTE = "–ü—É—Ç–∞–Ω–∞"
ROLE_PEACEFUL = "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏–≥—Ä—ã
STATE_NIGHT = "night"
STATE_DAY = "day"
STATE_FINISHED = "finished"
STATE_ROLES_DISTRIBUTED = "roles_distributed"
STATE_TIMER_WAITING = "timer_waiting"

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–≥—Ä–æ–∫–æ–≤
STATUS_ACTIVE = "active"
STATUS_ELIMINATED = "eliminated"
STATUS_LEFT = "left"

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∫–ª—é—á–µ–π
STATE_KEY = "state"
STATUS_KEY = "status"
HOST_ID_KEY = "host_id"
USER_ID_KEY = "user_id"
ROLE_KEY = "role"

# –í—Å–µ —Ä–æ–ª–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
ALL_CONFIGURABLE_ROLES = [
    "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", 
    "–ú–∞—Ñ–∏–æ–∑–∏", 
    "–î–æ–Ω –ú–∞—Ñ–∏–∏", 
    "–ö–æ–º–∏—Å—Å–∞—Ä", 
    "–î–æ–∫—Ç–æ—Ä", 
    "–ú–∞–Ω—å—è–∫", 
    "–ü—É—Ç–∞–Ω–∞"
]

# –†–æ–ª–∏, —Å–ø–æ—Å–æ–±–Ω—ã–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–æ—á—å—é
NIGHT_ROLES = [ROLE_MAFIA_DON, ROLE_MAFIA, ROLE_DOCTOR, ROLE_COMMISSIONER, ROLE_MANIAC, ROLE_PROSTITUTE]

# –ü–∞—Å—Å–∏–≤–Ω—ã–µ —Ä–æ–ª–∏ (–±–µ–∑ –Ω–æ—á–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π)
PASSIVE_ROLES = [ROLE_PEACEFUL]

def get_minute_word(minutes: int) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É —Å–ª–æ–≤–∞ '–º–∏–Ω—É—Ç–∞' –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–∏—Å–ª–∞"""
    if minutes % 10 == 1 and minutes % 100 != 11:
        return "–º–∏–Ω—É—Ç–∞"
    elif minutes % 10 in [2, 3, 4] and minutes % 100 not in [12, 13, 14]:
        return "–º–∏–Ω—É—Ç—ã"
    else:
        return "–º–∏–Ω—É—Ç"

def build_game_summary_text(game_data: dict) -> str:
    """–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã (—Ñ–∞–∑–∞, –∂–∏–≤—ã–µ –∏ –≤—ã–±—ã–≤—à–∏–µ)"""
    state = game_data.get("state")
    if state == STATE_NIGHT:
        phase = f"üåô –§–∞–∑–∞: –ù–æ—á—å #{game_data.get('current_night_number', 1)}"
    elif state == STATE_DAY:
        phase = f"üåû –§–∞–∑–∞: –î–µ–Ω—å #{game_data.get('current_day_number', 1)}"
    elif state == STATE_FINISHED:
        phase = "üèÅ –§–∞–∑–∞: –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    else:
        phase = "üéÆ –§–∞–∑–∞: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞"

    alive = []
    dead = []
    for slot in game_data.get("players_slots", []):
        name = get_player_display_name(slot)
        if slot.get("status") == STATUS_ACTIVE:
            alive.append(name)
        elif slot.get("status") == STATUS_ELIMINATED:
            dead.append(name)

    alive_line = "üë• –ñ–∏–≤—ã: " + (", ".join(alive) if alive else "‚Äî")
    dead_line = "üíÄ –í—ã–±—ã–ª–∏: " + (", ".join(dead) if dead else "‚Äî")

    return "üìã –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –∏–≥—Ä—ã\n" + phase + "\n" + alive_line + "\n" + dead_line

async def send_game_summary_to_players(game_id: str, game_data: dict, context: CallbackContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É –∏–≥—Ä—ã –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º"""
    summary_text = build_game_summary_text(game_data)
    for slot in game_data.get("players_slots", []):
        user_id = slot.get("user_id")
        if not user_id:
            continue
        try:
            await context.bot.send_message(user_id, summary_text)
        except Exception as e:
            logger.error(f"Error sending game summary to player {user_id} in game {game_id}: {e}")

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
TOKEN = "7639730661:AAEUaFtNCjbZAA4AzT6Vm8pqmjYuL2TRBG0"

# –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–≥—Ä
games = {}

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_math_state = {}

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
PREMIUM_PRICE_RUBLES = 299  # –¶–µ–Ω–∞ –≤ —Ä—É–±–ª—è—Ö
PREMIUM_PRICE_KOPECKS = PREMIUM_PRICE_RUBLES * 100  # Telegram —Ç—Ä–µ–±—É–µ—Ç —Ü–µ–Ω—É –≤ –∫–æ–ø–µ–π–∫–∞—Ö

# –¢–æ–∫–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ÆKassa (–ø–æ–ª—É—á–∏—Ç–µ –≤ @BotFather)
PAYMENT_PROVIDER_TOKEN = "390540012:LIVE:71581"  # –ë–æ–µ–≤–æ–π —Ç–æ–∫–µ–Ω –ÆKassa

# –î–∞–Ω–Ω—ã–µ —Ä–æ–ª–µ–π —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º
ROLES_DATA = {
    "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å": {
        "description": "–û–±—ã—á–Ω—ã–π –∂–∏—Ç–µ–ª—å –≥–æ—Ä–æ–¥–∞. –ù–µ –∏–º–µ–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π.",
        "goal": "–ù–∞–π—Ç–∏ –∏ –∏—Å–∫–ª—é—á–∏—Ç—å –≤—Å–µ—Ö –º–∞—Ñ–∏–æ–∑–∏ –ø—É—Ç–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¥–Ω–µ–º.",
        "actions": "–£—á–∞—Å—Ç–≤—É–µ—Ç –≤ –¥–Ω–µ–≤–Ω—ã—Ö –æ–±—Å—É–∂–¥–µ–Ω–∏—è—Ö –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è—Ö."
    },
    "–ú–∞—Ñ–∏–æ–∑–∏": {
        "description": "–ß–ª–µ–Ω –º–∞—Ñ–∏–∏. –ó–Ω–∞–µ—Ç –≤—Å–µ—Ö —á–ª–µ–Ω–æ–≤ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã.",
        "goal": "–ó–∞—Ö–≤–∞—Ç–∏—Ç—å –≥–æ—Ä–æ–¥, —É–Ω–∏—á—Ç–æ–∂–∏–≤ –≤—Å–µ—Ö –º–∏—Ä–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π.",
        "actions": "–ù–æ—á—å—é —Å–æ–≤–µ—â–∞–µ—Ç—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –º–∞—Ñ–∏–æ–∑–∏ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –∂–µ—Ä—Ç–≤—É –¥–ª—è —É–±–∏–π—Å—Ç–≤–∞."
    },
    "–î–æ–Ω –ú–∞—Ñ–∏–∏": {
        "description": "–ì–ª–∞–≤–∞ –º–∞—Ñ–∏–∏. –ò–º–µ–µ—Ç —Ä–µ—à–∞—é—â–∏–π –≥–æ–ª–æ—Å –ø—Ä–∏ —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏—è—Ö –≤ –º–∞—Ñ–∏–∏.",
        "goal": "–ó–∞—Ö–≤–∞—Ç–∏—Ç—å –≥–æ—Ä–æ–¥, —Ä—É–∫–æ–≤–æ–¥—è –º–∞—Ñ–∏–µ–π.",
        "actions": "–ù–æ—á—å—é —Ä—É–∫–æ–≤–æ–¥–∏—Ç –≤—ã–±–æ—Ä–æ–º –∂–µ—Ä—Ç–≤—ã, –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Ä–æ–ª—å –ö–æ–º–∏—Å—Å–∞—Ä–∞."
    },
    "–ö–æ–º–∏—Å—Å–∞—Ä": {
        "description": "–°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª–∏—Ü–∏–∏. –ú–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –º–∞—Ñ–∏–∏.",
        "goal": "–ù–∞–π—Ç–∏ –∏ –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞ —á–∏—Å—Ç—É—é –≤–æ–¥—É –≤—Å–µ—Ö –º–∞—Ñ–∏–æ–∑–∏.",
        "actions": "–ö–∞–∂–¥—É—é –Ω–æ—á—å –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ - –º–∞—Ñ–∏–æ–∑–∏ –∏–ª–∏ –Ω–µ—Ç."
    },
    "–î–æ–∫—Ç–æ—Ä": {
        "description": "–í—Ä–∞—á. –ú–æ–∂–µ—Ç —Å–ø–∞—Å–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤ –æ—Ç —Å–º–µ—Ä—Ç–∏.",
        "goal": "–ó–∞—â–∏—Ç–∏—Ç—å –º–∏—Ä–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π –æ—Ç –º–∞—Ñ–∏–∏.",
        "actions": "–ö–∞–∂–¥—É—é –Ω–æ—á—å –º–æ–∂–µ—Ç —Å–ø–∞—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –æ—Ç —É–±–∏–π—Å—Ç–≤–∞ (–≤–∫–ª—é—á–∞—è —Å–µ–±—è)."
    },
    "–ú–∞–Ω—å—è–∫": {
        "description": "–û–¥–∏–Ω–æ–∫–∏–π —É–±–∏–π—Ü–∞. –ò–≥—Ä–∞–µ—Ç —Å–∞–º –∑–∞ —Å–µ–±—è –ø—Ä–æ—Ç–∏–≤ –≤—Å–µ—Ö.",
        "goal": "–û—Å—Ç–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º –≤—ã–∂–∏–≤—à–∏–º –≤ –≥–æ—Ä–æ–¥–µ.",
        "actions": "–ö–∞–∂–¥—É—é –Ω–æ—á—å —É–±–∏–≤–∞–µ—Ç –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞. –ü–æ–±–µ–∂–¥–∞–µ—Ç, –µ—Å–ª–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –æ–¥–∏–Ω."
    },
    "–ü—É—Ç–∞–Ω–∞": {
        "description": "–ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤.",
        "goal": "–ü–æ–º–æ—á—å –º–∏—Ä–Ω—ã–º –∂–∏—Ç–µ–ª—è–º –ø–æ–±–µ–¥–∏—Ç—å –º–∞—Ñ–∏—é.",
        "actions": "–ö–∞–∂–¥—É—é –Ω–æ—á—å –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞."
    }
}

# –°–ø–∏—Å–æ–∫ –∫—Ä—É—Ç—ã—Ö –≤—ã–º—ã—à–ª–µ–Ω–Ω—ã—Ö –∏–º–µ–Ω –∏–∑ –ø–æ–ø-–∫—É–ª—å—Ç—É—Ä—ã (150+ –∏–º–µ–Ω)
fictional_names_list = [
    # –ò–∑ –≤–∏–¥–µ–æ–∏–≥—Ä
    "–ì–µ—Ä–∞–ª—å—Ç –†–∏–≤–∏–π—Å–∫–∏–π", "–õ–∞—Ä–∞ –ö—Ä–æ—Ñ—Ç", "–ú–∞—Å—Ç–µ—Ä –ß–∏—Ñ", "–ê–ª–µ–∫—Å –í—ç–Ω—Å", "–î–∂–æ–Ω-117",
    "–≠–ª–ª–∏ –£–∏–ª—å—è–º—Å", "–ê—ç—Ä–∏—Å –ì–µ–π–Ω—Å–±–æ—Ä–æ", "–ö–ª–∞—É–¥ –°—Ç—Ä–∞–π—Ñ", "–°—ç–º –§–∏—à–µ—Ä", "–î–∂–∏–ª–ª –í–∞–ª–µ–Ω—Ç–∞–π–Ω",
    "–ö—Ä–µ–π—Ç–æ—Å", "–ê–ª–æ–π", "–ê—Ä—Ç—É—Ä –ú–æ—Ä–≥–∞–Ω", "–°–∞—Ä–∞ –ö–µ—Ä—Ä–∏–≥–∞–Ω", "–ì–æ—Ä–¥–æ–Ω –§—Ä–∏–º–µ–Ω",
    "–î—É–º –°–ª–µ–π–µ—Ä", "–î–∞–Ω—Ç–µ –°–ø–∞—Ä–¥–∞", "–í–µ—Ä–≥–∏–ª–∏–π", "–ù–∏–∫–æ –†–æ–±–∏–Ω", "–°–æ–Ω–∏–∫ –•–µ–¥–∂—Ö–æ–≥",
    "–ú–∞—Ä–∏–æ –ú–∞—Ä–∏–æ", "–ü—Ä–∏–Ω—Ü–µ—Å—Å–∞ –ü–∏—á", "–õ–∏–Ω–∫ –•–∞–π—Ä—É–ª", "–ó–µ–ª—å–¥–∞", "–ì–∞–Ω–¥–æ—Ä—Ñ",
    "–ö—Ä–∞—Ç–æ—Å –°–ø–∞—Ä—Ç–∞–Ω", "–ê—Ç—Ä–µ–π", "–ù–µ–π—Ç–∞–Ω –î—Ä–µ–π–∫", "–ï–ª–µ–Ω–∞ –§–∏—à–µ—Ä", "–í–∏–∫—Ç–æ—Ä –°–∞–ª–ª–∏–≤–∞–Ω",
    "–ö–∞—Å—Å –ö—ç–π–Ω", "–≠—Ü–∏–æ –ê—É–¥–∏—Ç–æ—Ä–µ", "–ê–ª—å—Ç–∞–∏—Ä –ò–±–Ω-–õ–∞'–ê—Ö–∞–¥", "–ö–æ–Ω–Ω–æ—Ä –ö–µ–Ω—É—ç–π", "–ê—Ä–Ω–æ –î–æ—Ä–∏–∞–Ω",
    "–≠–≤–∏–µ –§—Ä–∞–π", "–î–∂–µ–π–∫–æ–± –§—Ä–∞–π", "–ë–∞–µ–∫ –°–∏–≤–∞", "–ê–π—è –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∏—è", "–ö–∞—Å—Å–∞–Ω–¥—Ä–∞",
    "–ê–ª–µ–∫—Å–∏–æ—Å", "–†—ç–π–¥–µ–Ω", "–°–∫–æ—Ä–ø–∏–æ–Ω", "–°–∞–±-–ó–∏—Ä–æ", "–°–æ–Ω—è –ë–ª–µ–π–¥", "–õ—é –ö–∞–Ω",
    
    # –ò–∑ Marvel/DC
    "–¢–æ–Ω–∏ –°—Ç–∞—Ä–∫", "–ù–∞—Ç–∞—à–∞ –†–æ–º–∞–Ω–æ—Ñ—Ñ", "–°—Ç–∏–≤ –†–æ–¥–∂–µ—Ä—Å", "–ë—Ä—é—Å –£—ç–π–Ω", "–î–∏–∞–Ω–∞ –ü—Ä–∏–Ω—Å",
    "–ü–∏—Ç–µ—Ä –ü–∞—Ä–∫–µ—Ä", "–í–∞–Ω–¥–∞ –ú–∞–∫—Å–∏–º–æ—Ñ—Ñ", "–°–∫–æ—Ç—Ç –õ—ç–Ω–≥", "–ö—ç—Ä–æ–ª –î—ç–Ω–≤–µ—Ä—Å", "–°—Ç–∏–≤–µ–Ω –°—Ç—Ä—ç–Ω–¥–∂",
    "–ë–∞—Ä—Ä–∏ –ê–ª–ª–µ–Ω", "–•—ç–ª –î–∂–æ—Ä–¥–∞–Ω", "–ö–ª–∞—Ä–∫ –ö–µ–Ω—Ç", "–õ–æ–∏—Å –õ–µ–π–Ω", "–°–µ–ª–∏–Ω–∞ –ö–∞–π–ª",
    "–•–∞—Ä–ª–∏ –ö–≤–∏–Ω–Ω", "–î—ç–¥–ø—É–ª", "–†–æ—Å–æ–º–∞—Ö–∞", "–®—Ç–æ—Ä–º", "–î–∂–∏–Ω –ì—Ä–µ–π", "–°–∫–æ—Ç—Ç –°–∞–º–º–µ—Ä—Å",
    "–ö—É—Ä—Ç –í–∞–≥–Ω–µ—Ä", "–õ–æ–≥–∞–Ω –•–æ—É–ª–µ—Ç—Ç", "–†–µ–π–≤–µ–Ω –î–∞—Ä–∫", "–ú–∏—Å—Ç–∏–∫", "–ú–∞–≥–Ω–µ—Ç–æ",
    "–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ò–∫—Å", "–ù–æ—á–Ω–æ–π –ó–º–µ–π", "–ö—Ä–∞—Å–Ω–∞—è –í–µ–¥—å–º–∞", "–°–æ–∫–æ–ª–∏–Ω—ã–π –ì–ª–∞–∑", "–ß–µ—Ä–Ω–∞—è –ü–∞–Ω—Ç–µ—Ä–∞",
    
    # –ò–∑ —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤
    "–î–∂–æ–Ω –£–∏–∫", "–°–∞—Ä–∞ –ö–æ–Ω–Ω–æ—Ä", "–≠–ª–ª–µ–Ω –†–∏–ø–ª–∏", "–•–∞–Ω –°–æ–ª–æ", "–õ–µ—è –û—Ä–≥–∞–Ω–∞",
    "–ù–µ–æ –ê–Ω–¥–µ—Ä—Å–æ–Ω", "–¢—Ä–∏–Ω–∏—Ç–∏", "–î–∂–µ–π–º—Å –ë–æ–Ω–¥", "–ò—Ç–∞–Ω –•–∞–Ω—Ç", "–ë–µ–∞—Ç—Ä–∏–∫—Å –ö–∏–¥–æ",
    "–î–æ–º–∏–Ω–∏–∫ –¢–æ—Ä–µ—Ç—Ç–æ", "–õ–µ—Ç—Ç–∏ –û—Ä—Ç–∏–∑", "–•–æ–±–±—Å", "–®–æ—É", "–†—ç–º–∑–∏",
    "–î–∂–æ–Ω –°–Ω–æ—É", "–î–µ–π–µ–Ω–µ—Ä–∏—Å –¢–∞—Ä–≥–∞—Ä–∏–µ–Ω", "–ê—Ä—å—è –°—Ç–∞—Ä–∫", "–¢–∏—Ä–∏–æ–Ω –õ–∞–Ω–Ω–∏—Å—Ç–µ—Ä", "–°–µ—Ä—Å–µ—è –õ–∞–Ω–Ω–∏—Å—Ç–µ—Ä",
    "–î–∂–µ–π–º–µ –õ–∞–Ω–Ω–∏—Å—Ç–µ—Ä", "–°–∞–Ω—Å–∞ –°—Ç–∞—Ä–∫", "–ë—Ä–∞–Ω –°—Ç–∞—Ä–∫", "–î–∂–æ–Ω –ö–æ–Ω–Ω–æ—Ä", "–ö–∞–π–ª –†–∏–∑",
    "–†–∏–∫ –ì—Ä–∞–π–º—Å", "–î—ç—Ä–∏–ª –î–∏–∫—Å–æ–Ω", "–ú–∏—à–æ–Ω", "–ö—ç—Ä–æ–ª –ü–µ–ª–µ—Ç—å–µ—Ä", "–ì–ª–µ–Ω–Ω –†–∏",
    "–ú–∞–≥–≥–∏ –ì—Ä–∏–Ω", "–ù–µ–≥–∞–Ω", "–≠–π–±—Ä–∞—Ö–∞–º –§–æ—Ä–¥", "–Æ–¥–∂–∏–Ω –ü–æ—Ä—Ç–µ—Ä", "–†–æ–∑–∏—Ç–∞ –≠—Å–ø–∏–Ω–æ–∑–∞",
    
    # –ú—É–∑—ã–∫–∞–Ω—Ç—ã –∏ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç–∏
    "–§—Ä–µ–¥–¥–∏ –ú–µ—Ä–∫—å—é—Ä–∏", "–î—ç–≤–∏–¥ –ë–æ—É–∏", "–ú–∞–π–∫–ª –î–∂–µ–∫—Å–æ–Ω", "–ú–∞–¥–æ–Ω–Ω–∞", "–ü—Ä–∏–Ω—Å –†–æ–¥–∂–µ—Ä—Å",
    "–î–∂–æ–Ω –õ–µ–Ω–Ω–æ–Ω", "–ü–æ–ª –ú–∞–∫–∫–∞—Ä—Ç–Ω–∏", "–ê–¥–µ–ª—å –ê—Ç–∫–∏–Ω—Å", "–ë–µ–π–æ–Ω—Å–µ –ù–æ—É–ª–∑", "–≠–º–∏–Ω–µ–º",
    "–ê—Ä–∏–∞–Ω–∞ –ì—Ä–∞–Ω–¥–µ", "–¢–µ–π–ª–æ—Ä –°–≤–∏—Ñ—Ç", "–õ–µ–¥–∏ –ì–∞–≥–∞", "–ë—Ä—É–Ω–æ –ú–∞—Ä—Å", "–≠–¥ –®–∏—Ä–∞–Ω",
    "–ë–∏–ª–ª–∏ –ê–π–ª–∏—à", "–î–∂–∞—Å—Ç–∏–Ω –¢–∏–º–±–µ—Ä–ª–µ–π–∫", "–†–∏–∞–Ω–∞", "–ö–∞–Ω—å–µ –£—ç—Å—Ç", "–î—Ä–µ–π–∫",
    "–î–∂–µ–π-–ó–∏", "–ù–∞—Ç–∞–ª–∏ –ü–æ—Ä—Ç–º–∞–Ω", "–õ–µ–æ–Ω–∞—Ä–¥–æ –î–∏–ö–∞–ø—Ä–∏–æ", "–ë—Ä—ç–¥ –ü–∏—Ç—Ç", "–ê–Ω–¥–∂–µ–ª–∏–Ω–∞ –î–∂–æ–ª–∏",
    
    # –ò–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤ –∏ —Å–µ—Ä–∏–∞–ª–æ–≤
    "–î–∂–µ–∫ –°–ø—ç—Ä—Ä–æ—É", "–≠–ª–∏–∑–∞–±–µ—Ç –°—É–æ–Ω–Ω", "–£–∏–ª–ª –¢–µ—Ä–Ω–µ—Ä", "–ö–∞–ø–∏—Ç–∞–Ω –ë–∞—Ä–±–æ—Å—Å–∞", "–î—ç–≤–∏ –î–∂–æ–Ω—Å",
    "–ò–Ω–¥–∏–∞–Ω–∞ –î–∂–æ–Ω—Å", "–ú—ç—Ä–∏–æ–Ω –†—ç–π–≤–µ–Ω–≤—É–¥", "–ì–µ–Ω—Ä–∏ –î–∂–æ–Ω—Å", "–ö–æ—Ä–æ—Ç–∫–∏–π –†–∞—É–Ω–¥", "–í–∏–ª–ª–∏ –°–∫–æ—Ç—Ç",
    "–§–æ—Ä–µ—Å—Ç –ì–∞–º–ø", "–î–∂–µ–Ω–Ω–∏ –ö–∞—Ä—Ä–µ–Ω", "–õ–µ–π—Ç–µ–Ω–∞–Ω—Ç –î—ç–Ω", "–ë—É–±–±–∞ –ë–ª—é", "–ú–∞–º–∞ –ì–∞–º–ø",
    "–í—É–¥–∏", "–ë–∞–∑–∑ –õ–∞–π—Ç–µ—Ä", "–î–∂–µ—Å—Å–∏", "–ë–æ –ü–∏–ø", "–†–µ–∫—Å –î–∏–Ω–æ–∑–∞–≤—Ä",
    "–®—Ä–µ–∫", "–§–∏–æ–Ω–∞", "–û—Å–µ–ª", "–ö–æ—Ç –≤ –°–∞–ø–æ–≥–∞—Ö", "–õ–æ—Ä–¥ –§–∞—Ä–∫—É–∞–¥",
    "–≠–ª—å–∑–∞", "–ê–Ω–Ω–∞", "–û–ª–∞—Ñ", "–ö—Ä–∏—Å—Ç–æ—Ñ—Ñ", "–°–≤–µ–Ω –û–ª–µ–Ω—å",
    "–ú–æ–∞–Ω–∞", "–ú–∞—É–∏", "–ë–∞–±—É—à–∫–∞ –¢–∞–ª–∞", "–•–µ–π-–•–µ–π", "–ü—É–∞",
    
    # –ò–∑ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã –∏ –º–∏—Ñ–æ–ª–æ–≥–∏–∏
    "–®–µ—Ä–ª–æ–∫ –•–æ–ª–º—Å", "–î–∂–æ–Ω –í–∞—Ç—Å–æ–Ω", "–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä", "–•–µ—Ä–º–∏–æ–Ω–∞ –ì—Ä–µ–π–Ω–¥–∂–µ—Ä", "–†–æ–Ω –£–∏–∑–ª–∏",
    "–ì—ç–Ω–¥–∞–ª—å—Ñ –°–µ—Ä—ã–π", "–ê—Ä–∞–≥–æ—Ä–Ω", "–õ–µ–≥–æ–ª–∞—Å", "–ì–∏–º–ª–∏", "–§—Ä–æ–¥–æ –ë—ç–≥–≥–∏–Ω—Å",
    "–°—ç–º –ì—ç–º–¥–∂–∏", "–ë–æ—Ä–æ–º–∏—Ä", "–§–∞—Ä–∞–º–∏—Ä", "–ì–∞–ª–∞–¥—Ä–∏—ç–ª—å", "–≠–ª—Ä–æ–Ω–¥",
    "–ê—Ä—Ç–µ–º–∏–¥–∞", "–ê–ø–æ–ª–ª–æ–Ω", "–ê—Ñ–∏–Ω–∞", "–ê—Ä–µ—Å", "–ì–µ—Ä–º–µ—Å", "–ü–æ—Å–µ–π–¥–æ–Ω", "–ì–µ—Ä–∞",
    "–¢–æ—Ä –û–¥–∏–Ω—Å–æ–Ω", "–õ–æ–∫–∏ –õ–∞—Ñ–µ–π—Å–æ–Ω", "–§—Ä–µ–π—è", "–û–¥–∏–Ω", "–ë–∞–ª—å–¥—Ä", "–•–µ–π–º–¥–∞–ª–ª—å",
    
    # –ò–∑ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤ –∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Å–∏–∫–∞
    "–†–æ–∫–∫–∏ –ë–∞–ª—å–±–æ–∞", "–≠–¥—Ä–∏–∞–Ω –ü–µ–Ω–Ω–∏–Ω–æ", "–ê–ø–æ–ª–ª–æ –ö—Ä–∏–¥", "–ò–≤–∞–Ω –î—Ä–∞–≥–æ", "–ö–ª–∞–±–µ—Ä –õ—ç–Ω–≥",
    "–†—ç–º–±–æ", "–î–∂–æ–Ω –ú–∞–∫–ª–µ–π–Ω", "–•–æ–ª–ª–∏ –î–∂–µ–Ω–Ω–∞—Ä–æ", "–•–∞–Ω—Å—ã –ì—Ä—É–±–µ—Ä", "–≠–ª –ü–∞—É—ç–ª–ª",
    "–¢–µ—Ä–º–∏–Ω–∞—Ç–æ—Ä", "–ö–∞–π–ª –†–∏–∑", "–°–∞—Ä–∞ –ö–æ–Ω–Ω–æ—Ä", "–î–∂–æ–Ω –ö–æ–Ω–Ω–æ—Ä", "–¢-1000",
    "–ö–æ–ª–æ–º–±–æ", "–®–µ—Ä–ª–æ–∫ –•–æ–ª–º—Å", "–î–æ–∫—Ç–æ—Ä –í–∞—Ç—Å–æ–Ω", "–≠—Ä–∫—é–ª—å –ü—É–∞—Ä–æ", "–ú–∏—Å—Å –ú–∞—Ä–ø–ª",
    "–î–∂–µ–π–º—Å –ë–æ–Ω–¥", "–ú", "–ö—å—é", "–ú–∞–Ω–∏ –ü–µ–Ω–Ω–∏", "–§–µ–ª–∏–∫—Å –õ–µ–π—Ç–µ—Ä",
    "–ò–Ω–¥–∏–∞–Ω–∞ –î–∂–æ–Ω—Å", "–ú—ç—Ä–∏–æ–Ω –†—ç–π–≤–µ–Ω–≤—É–¥", "–ì–µ–Ω—Ä–∏ –î–∂–æ–Ω—Å", "–°–∞–ª–ª–∞", "–ë—Ä—ç–¥–∏",
    
    # –ó–≤–µ–∑–¥–Ω—ã–µ –≤–æ–π–Ω—ã (–ø—Ä–æ—Å—Ç—ã–µ –∏–º–µ–Ω–∞)
    "–õ—é–∫ –°–∫–∞–π—É–æ–∫–µ—Ä", "–õ–µ—è –û—Ä–≥–∞–Ω–∞", "–•–∞–Ω –°–æ–ª–æ", "–ß—É–±–∞–∫–∫–∞", "–õ—ç–Ω–¥–æ –ö–∞–ª—Ä–∏—Å—Å–∏–∞–Ω",
    "–û–±–∏-–í–∞–Ω –ö–µ–Ω–æ–±–∏", "–ô–æ–¥–∞", "–î–∞—Ä—Ç –í–µ–π–¥–µ—Ä", "–ü–∞–ª–ø–∞—Ç–∏–Ω", "–î–∂–∞–±–±–∞ –•–∞—Ç—Ç"
]

# –°–ø–∏—Å–æ–∫ –ª–∏—á–Ω—ã—Ö –¥–µ–ª (250+ –¥–µ–ª)
personal_cases = [
    # –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ —Ä–∞–±–æ—Ç–∞
    "–Ø —Ä–∞–±–æ—Ç–∞—é —É—á–∏—Ç–µ–ª–µ–º –≤ –º–µ—Å—Ç–Ω–æ–π —à–∫–æ–ª–µ –∏ –æ—á–µ–Ω—å –ª—é–±–ª—é –¥–µ—Ç–µ–π.",
    "–í–ª–∞–¥–µ—é –Ω–µ–±–æ–ª—å—à–∏–º –º–∞–≥–∞–∑–∏–Ω–æ–º –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π —É–ª–∏—Ü–µ –≥–æ—Ä–æ–¥–∞.",
    "–†–∞–±–æ—Ç–∞—é –≤—Ä–∞—á–æ–º –≤ –≥–æ—Ä–æ–¥—Å–∫–æ–π –±–æ–ª—å–Ω–∏—Ü–µ —É–∂–µ 15 –ª–µ—Ç.",
    "–Ø –º–µ—Ö–∞–Ω–∏–∫ –≤ –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å–µ –∏ –∑–Ω–∞—é –≤—Å–µ –æ –º–∞—à–∏–Ω–∞—Ö.",
    "–†–∞–±–æ—Ç–∞—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ä–µ–º –∏ —á–∏—Ç–∞—é –ø–æ —Ç—Ä–∏ –∫–Ω–∏–≥–∏ –≤ –Ω–µ–¥–µ–ª—é.",
    "–Ø –ø–æ–≤–∞—Ä –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –∏ –≥–æ—Ç–æ–≤–ª—é –ª—É—á—à—É—é –ø–∏—Ü—Ü—É –≤ –≥–æ—Ä–æ–¥–µ.",
    "–†–∞–±–æ—Ç–∞—é —Ç–∞–∫—Å–∏—Å—Ç–æ–º –∏ –∑–Ω–∞—é –∫–∞–∂–¥—É—é —É–ª–æ—á–∫—É –Ω–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞.",
    "–Ø –ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä –∏ –¥–µ–ª–∞—é —Å–∞–º—ã–µ –º–æ–¥–Ω—ã–µ —Å—Ç—Ä–∏–∂–∫–∏.",
    "–†–∞–±–æ—Ç–∞—é –ø–æ—á—Ç–∞–ª—å–æ–Ω–æ–º –∏ —Ä–∞–∑–Ω–æ—à—É –ø–∏—Å—å–º–∞ –ø–æ –≤—Å–µ–º—É —Ä–∞–π–æ–Ω—É.",
    "–Ø –ø—Ä–æ–¥–∞–≤–µ—Ü –≤ —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç–µ –∏ –≤—Å–µ–≥–¥–∞ —É–ª—ã–±–∞—é—Å—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è–º.",
    "–†–∞–±–æ—Ç–∞—é —Å—Ç—Ä–æ–∏—Ç–µ–ª–µ–º –∏ —Å—Ç—Ä–æ—é –¥–æ–º–∞ –¥–ª—è –ª—é–¥–µ–π.",
    "–Ø —Ö—É–¥–æ–∂–Ω–∏–∫ –∏ —Ä–∏—Å—É—é –ø–æ—Ä—Ç—Ä–µ—Ç—ã –Ω–∞ –∑–∞–∫–∞–∑.",
    "–†–∞–±–æ—Ç–∞—é –≤ –±–∞–Ω–∫–µ –∫–∞—Å—Å–∏—Ä–æ–º —É–∂–µ 10 –ª–µ—Ç.",
    "–Ø –≤–µ—Ç–µ—Ä–∏–Ω–∞—Ä –∏ –ª–µ—á—É –∂–∏–≤–æ—Ç–Ω—ã—Ö –≤ –Ω–∞—à–µ–º –≥–æ—Ä–æ–¥–µ.",
    "–†–∞–±–æ—Ç–∞—é –ø–æ–∂–∞—Ä–Ω—ã–º –∏ —Å–ø–∞—Å–∞—é –ª—é–¥–µ–π –æ—Ç –æ–≥–Ω—è.",
    "–Ø —Ñ–µ—Ä–º–µ—Ä –∏ –≤—ã—Ä–∞—â–∏–≤–∞—é —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —á–∏—Å—Ç—ã–µ –æ–≤–æ—â–∏.",
    "–†–∞–±–æ—Ç–∞—é –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–æ–º –≤ –º–µ—Å—Ç–Ω–æ–π –≥–∞–∑–µ—Ç–µ.",
    "–Ø –º—É–∑—ã–∫–∞–Ω—Ç –∏ –∏–≥—Ä–∞—é –≤ –≥–æ—Ä–æ–¥—Å–∫–æ–º –æ—Ä–∫–µ—Å—Ç—Ä–µ.",
    "–†–∞–±–æ—Ç–∞—é –æ—Ö—Ä–∞–Ω–Ω–∏–∫–æ–º –≤ —Ç–æ—Ä–≥–æ–≤–æ–º —Ü–µ–Ω—Ç—Ä–µ.",
    "–Ø —à–≤–µ—è –∏ —à—å—é –∫—Ä–∞—Å–∏–≤—É—é –æ–¥–µ–∂–¥—É –Ω–∞ –∑–∞–∫–∞–∑.",
    "–†–∞–±–æ—Ç–∞—é —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–º –∏ —á–∏–Ω—é –ø—Ä–æ–≤–æ–¥–∫—É –≤ –¥–æ–º–∞—Ö.",
    "–Ø —Å–∞–¥–æ–≤–Ω–∏–∫ –∏ —É—Ö–∞–∂–∏–≤–∞—é –∑–∞ –≥–æ—Ä–æ–¥—Å–∫–∏–º –ø–∞—Ä–∫–æ–º.",
    "–†–∞–±–æ—Ç–∞—é –≤ —Ç–µ–∞—Ç—Ä–µ –∞–∫—Ç–µ—Ä–æ–º —É–∂–µ 8 –ª–µ—Ç.",
    "–Ø —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ –∏ —Å–Ω–∏–º–∞—é —Å–≤–∞–¥—å–±—ã –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏.",
    "–†–∞–±–æ—Ç–∞—é —Å–ª–µ—Å–∞—Ä–µ–º –∏ —Ä–µ–º–æ–Ω—Ç–∏—Ä—É—é —Ç—Ä—É–±—ã.",
    "–Ø –∫–æ–Ω–¥–∏—Ç–µ—Ä –∏ –ø–µ–∫—É —Ç–æ—Ä—Ç—ã –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è.",
    "–†–∞–±–æ—Ç–∞—é –¥–≤–æ—Ä–Ω–∏–∫–æ–º –∏ —É–±–∏—Ä–∞—é –Ω–∞—à —Ä–∞–π–æ–Ω.",
    "–Ø –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –∏ —Å–æ–∑–¥–∞—é –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã.",
    "–†–∞–±–æ—Ç–∞—é –≤ –¥–µ—Ç—Å–∫–æ–º —Å–∞–¥—É –≤–æ—Å–ø–∏—Ç–∞—Ç–µ–ª–µ–º.",
    "–Ø —Å—Ç–æ–ª—è—Ä –∏ –¥–µ–ª–∞—é –º–µ–±–µ–ª—å –∏–∑ –¥–µ—Ä–µ–≤–∞.",
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
    "–Ø –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä—É—é –∫—Ä–∞—Å–∏–≤—ã–µ –∑–¥–∞–Ω–∏—è –¥–ª—è –Ω–∞—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞.",
    "–†–∞–±–æ—Ç–∞—é –º–∞—Å—Å–∞–∂–∏—Å—Ç–æ–º –≤ —Å–ø–∞-—Å–∞–ª–æ–Ω–µ –∏ –ø–æ–º–æ–≥–∞—é –ª—é–¥—è–º —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.",
    "–Ø –¥–∏–∑–∞–π–Ω–µ—Ä –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤ –∏ –¥–µ–ª–∞—é –¥–æ–º–∞ —É—é—Ç–Ω—ã–º–∏.",
    "–†–∞–±–æ—Ç–∞—é –∑–≤—É–∫–æ—Ä–µ–∂–∏—Å—Å–µ—Ä–æ–º –Ω–∞ —Ä–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏–∏.",
    "–Ø –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫ –∏ –∑–Ω–∞—é 5 –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤.",
    "–†–∞–±–æ—Ç–∞—é —Ç—Ä–µ–Ω–µ—Ä–æ–º –≤ —Ñ–∏—Ç–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä–µ –∏ –ø–æ–º–æ–≥–∞—é –ª—é–¥—è–º –±—ã—Ç—å –∑–¥–æ—Ä–æ–≤—ã–º–∏.",
    "–Ø –ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É—é –ª—é–¥–µ–π –≤ —Ç—Ä—É–¥–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.",
    "–†–∞–±–æ—Ç–∞—é –≥–µ–æ–ª–æ–≥–æ–º –∏ –∏–∑—É—á–∞—é –º–∏–Ω–µ—Ä–∞–ª—ã –≤ –≥–æ—Ä–∞—Ö.",
    "–Ø –∞—Å—Ç—Ä–æ–Ω–æ–º –∏ –Ω–∞–±–ª—é–¥–∞—é –∑–∞ –∑–≤–µ–∑–¥–∞–º–∏ –∫–∞–∂–¥—É—é –Ω–æ—á—å.",
    "–†–∞–±–æ—Ç–∞—é –∞—Ä—Ö–µ–æ–ª–æ–≥–æ–º –∏ —Ä–∞—Å–∫–∞–ø—ã–≤–∞—é –¥—Ä–µ–≤–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã.",
    "–Ø —Ö–∏–º–∏–∫ –∏ —Ä–∞–±–æ—Ç–∞—é –≤ –Ω–∞—É—á–Ω–æ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏.",
    "–†–∞–±–æ—Ç–∞—é –∏–Ω–∂–µ–Ω–µ—Ä–æ–º –∏ –∫–æ–Ω—Å—Ç—Ä—É–∏—Ä—É—é –º–æ—Å—Ç—ã.",
    "–Ø –∑–æ–æ–ª–æ–≥ –∏ –∏–∑—É—á–∞—é –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–∏–∫–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö.",
    "–†–∞–±–æ—Ç–∞—é –¥–∞–π–≤–µ—Ä–æ–º –∏ –∏—Å—Å–ª–µ–¥—É—é –º–æ—Ä—Å–∫–∏–µ –≥–ª—É–±–∏–Ω—ã.",
    "–Ø –ø–∏–ª–æ—Ç –∏ –ª–µ—Ç–∞—é –Ω–∞ —Å–∞–º–æ–ª–µ—Ç–∞—Ö –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É.",
    "–†–∞–±–æ—Ç–∞—é –∫–∞–ø–∏—Ç–∞–Ω–æ–º –∫–æ—Ä–∞–±–ª—è –∏ –±–æ—Ä–æ–∑–¥—é –º–æ—Ä—è.",
    "–Ø –∞–ª—å–ø–∏–Ω–∏—Å—Ç –∏ –ø–æ–∫–æ—Ä—è—é –≤—ã—Å–æ—á–∞–π—à–∏–µ –≤–µ—Ä—à–∏–Ω—ã –≥–æ—Ä.",
    "–†–∞–±–æ—Ç–∞—é —Å–ø–∞—Å–∞—Ç–µ–ª–µ–º –Ω–∞ –ø–ª—è–∂–µ –∏ —Å–ª–µ–∂—É –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é.",
    "–Ø –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—é –ø–æ–≥–æ–¥—É.",
    "–†–∞–±–æ—Ç–∞—é –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–æ–º –∏ —Å–æ—Å—Ç–∞–≤–ª—è—é —Ç–æ—á–Ω—ã–µ –∫–∞—Ä—Ç—ã.",
    
    # –•–æ–±–±–∏ –∏ —É–≤–ª–µ—á–µ–Ω–∏—è
    "–í —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è —è –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä—É—é —Ä–µ–¥–∫–∏–µ –º–æ–Ω–µ—Ç—ã —Å–æ –≤—Å–µ–≥–æ –º–∏—Ä–∞.",
    "–£–≤–ª–µ–∫–∞—é—Å—å –≤—ã—Ä–∞—â–∏–≤–∞–Ω–∏–µ–º –æ—Ä—Ö–∏–¥–µ–π –∏ —É –º–µ–Ω—è –¥–æ–º–∞ –Ω–∞—Å—Ç–æ—è—â–∏–µ –¥–∂—É–Ω–≥–ª–∏.",
    "–ó–∞–Ω–∏–º–∞—é—Å—å –π–æ–≥–æ–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —É–∂–µ 5 –ª–µ—Ç –ø–æ–¥—Ä—è–¥.",
    "–ò–≥—Ä–∞—é –≤ —à–∞—Ö–º–∞—Ç—ã –∏ —É—á–∞—Å—Ç–≤—É—é –≤ —Ç—É—Ä–Ω–∏—Ä–∞—Ö –∫–∞–∂–¥—ã–µ –≤—ã—Ö–æ–¥–Ω—ã–µ.",
    "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä—É—é –≤–∏–Ω—Ç–∞–∂–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏ —Ä–µ—Å—Ç–∞–≤—Ä–∏—Ä—É—é –∏—Ö.",
    "–£–≤–ª–µ–∫–∞—é—Å—å –∞—Å—Ç—Ä–æ—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π –∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É—é —Å–æ–∑–≤–µ–∑–¥–∏—è.",
    "–ó–∞–Ω–∏–º–∞—é—Å—å —Å–∫–∞–ª–æ–ª–∞–∑–∞–Ω–∏–µ–º –∏ –ø–æ–∫–æ—Ä–∏–ª —É–∂–µ 20 –≤–µ—Ä—à–∏–Ω.",
    "–ò–∑—É—á–∞—é –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏ –∏ —É–∂–µ –∑–Ω–∞—é 7 —è–∑—ã–∫–æ–≤.",
    "–ü–∏—à—É —Å—Ç–∏—Ö–∏ –∏ —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª —Å–±–æ—Ä–Ω–∏–∫ —Å–≤–æ–∏—Ö —Ä–∞–±–æ—Ç.",
    "–£–≤–ª–µ–∫–∞—é—Å—å –∫—É–ª–∏–Ω–∞—Ä–∏–µ–π –∏ –≥–æ—Ç–æ–≤–ª—é –±–ª—é–¥–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –º–∏—Ä–∞.",
    "–ó–∞–Ω–∏–º–∞—é—Å—å —Ç–∞–Ω—Ü–∞–º–∏ –∏ —É—á–∞—Å—Ç–≤—É—é –≤ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è—Ö –ø–æ –±–∞–ª—å–Ω—ã–º —Ç–∞–Ω—Ü–∞–º.",
    "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä—É—é –±–∞–±–æ—á–µ–∫ –∏ –∑–Ω–∞—é –±–æ–ª–µ–µ 200 –≤–∏–¥–æ–≤.",
    "–£–≤–ª–µ–∫–∞—é—Å—å –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–∞–º–æ–ª–µ—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞—é —Ç–æ—á–Ω—ã–µ –∫–æ–ø–∏–∏.",
    "–ó–∞–Ω–∏–º–∞—é—Å—å –∫–∞–ª–ª–∏–≥—Ä–∞—Ñ–∏–µ–π –∏ –ø–∏—à—É –∫—Ä–∞—Å–∏–≤—ã–µ –æ—Ç–∫—Ä—ã—Ç–∫–∏ –¥—Ä—É–∑—å—è–º.",
    "–ò–∑—É—á–∞—é –∏—Å—Ç–æ—Ä–∏—é –¥—Ä–µ–≤–Ω–∏—Ö —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–π –∏ —á–∏—Ç–∞—é –∞—Ä—Ö–µ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–Ω–∏–≥–∏.",
    "–£–≤–ª–µ–∫–∞—é—Å—å –æ—Ä–∏–≥–∞–º–∏ –∏ –º–æ–≥—É —Å–ª–æ–∂–∏—Ç—å –ª—é–±—É—é —Ñ–∏–≥—É—Ä—É –∏–∑ –±—É–º–∞–≥–∏.",
    "–ó–∞–Ω–∏–º–∞—é—Å—å –ø—á–µ–ª–æ–≤–æ–¥—Å—Ç–≤–æ–º –∏ –ø—Ä–æ–∏–∑–≤–æ–∂—É –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –º–µ–¥.",
    "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä—É—é —Å—Ç–∞—Ä–∏–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ –∏ —É –º–µ–Ω—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∏–∑ 3000 —Ç–æ–º–æ–≤.",
    "–£–≤–ª–µ–∫–∞—é—Å—å –≥–æ–Ω—á–∞—Ä–Ω—ã–º –¥–µ–ª–æ–º –∏ —Å–æ–∑–¥–∞—é —É–Ω–∏–∫–∞–ª—å–Ω—É—é –∫–µ—Ä–∞–º–∏–∫—É.",
    "–ó–∞–Ω–∏–º–∞—é—Å—å –≤—ã–∂–∏–≥–∞–Ω–∏–µ–º –ø–æ –¥–µ—Ä–µ–≤—É –∏ –¥–µ–ª–∞—é —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–∞–Ω–Ω–æ.",
    
    # –°–µ–º—å—è –∏ –ª–∏—á–Ω–∞—è –∂–∏–∑–Ω—å
    "–Ø –Ω–µ–¥–∞–≤–Ω–æ —Å—Ç–∞–ª –æ—Ç—Ü–æ–º –∏ —É—á—É—Å—å –º–µ–Ω—è—Ç—å –ø–æ–¥–≥—É–∑–Ω–∏–∫–∏.",
    "–í–æ—Å–ø–∏—Ç—ã–≤–∞—é —Ç—Ä–æ–∏—Ö –¥–µ—Ç–µ–π –æ–¥–Ω–∞ –∏ –≥–æ—Ä–∂—É—Å—å –∏–º–∏.",
    "–ù–µ–¥–∞–≤–Ω–æ –æ—Ç–ø—Ä–∞–∑–¥–Ω–æ–≤–∞–ª —Å–µ—Ä–µ–±—Ä—è–Ω—É—é —Å–≤–∞–¥—å–±—É —Å –ª—é–±–∏–º–æ–π –∂–µ–Ω–æ–π.",
    "–ü–ª–∞–Ω–∏—Ä—É—é —Å–≤–∞–¥—å–±—É –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü –∏ –æ—á–µ–Ω—å –≤–æ–ª–Ω—É—é—Å—å.",
    "–ù–µ–¥–∞–≤–Ω–æ –ø–µ—Ä–µ–µ—Ö–∞–ª –≤ –Ω–æ–≤—ã–π –¥–æ–º –∏ –æ–±—É—Å—Ç—Ä–∞–∏–≤–∞—é –µ–≥–æ.",
    "–£—Ö–∞–∂–∏–≤–∞—é –∑–∞ –ø–æ–∂–∏–ª–æ–π –º–∞–º–æ–π –∏ –æ—á–µ–Ω—å –µ–µ –ª—é–±–ª—é.",
    "–ñ–¥—É —Ä–æ–∂–¥–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞ —á–µ—Ä–µ–∑ –¥–≤–∞ –º–µ—Å—è—Ü–∞.",
    "–¢–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–∫–æ–Ω—á–∏–ª —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –∏ –∏—â—É —Ä–∞–±–æ—Ç—É –º–µ—á—Ç—ã.",
    "–ü–ª–∞–Ω–∏—Ä—É—é –∫—Ä—É–≥–æ—Å–≤–µ—Ç–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –≥–æ–¥.",
    "–ù–µ–¥–∞–≤–Ω–æ –∫—É–ø–∏–ª –ø–µ—Ä–≤—É—é –º–∞—à–∏–Ω—É –∏ —É—á—É—Å—å –≤–æ–¥–∏—Ç—å.",
    "–ü–µ—Ä–µ–µ—Ö–∞–ª –∏–∑ –¥–µ—Ä–µ–≤–Ω–∏ –≤ –≥–æ—Ä–æ–¥ –º–µ—Å—è—Ü –Ω–∞–∑–∞–¥.",
    "–ñ–∏–≤—É —Å —Ç—Ä–µ–º—è —Å–æ—Å–µ–¥—è–º–∏ –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏ –∏ –º—ã –ª—É—á—à–∏–µ –¥—Ä—É–∑—å—è.",
    "–ù–µ–¥–∞–≤–Ω–æ —Ä–∞–∑–≤–µ–ª—Å—è –∏ –Ω–∞—á–∏–Ω–∞—é –Ω–æ–≤—É—é –∂–∏–∑–Ω—å.",
    "–£—Å—ã–Ω–æ–≤–∏–ª —â–µ–Ω–∫–∞ –∏–∑ –ø—Ä–∏—é—Ç–∞ –∏ —Ç–µ–ø–µ—Ä—å –º—ã –Ω–µ—Ä–∞–∑–ª—É—á–Ω—ã.",
    "–ü–ª–∞–Ω–∏—Ä—É—é –æ—Ç–∫—Ä—ã—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å –≤ —Å–ª–µ–¥—É—é—â–µ–º –≥–æ–¥—É.",
    "–¢–æ–ª—å–∫–æ —á—Ç–æ –≤–µ—Ä–Ω—É–ª—Å—è –∏–∑ –∞—Ä–º–∏–∏ –∏ –ø—Ä–∏–≤—ã–∫–∞—é –∫ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–π –∂–∏–∑–Ω–∏.",
    "–£—á—É—Å—å –≤ –≤–µ—á–µ—Ä–Ω–µ–π —à–∫–æ–ª–µ –∏ –ø–æ–ª—É—á–∞—é –≤—Ç–æ—Ä–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ.",
    "–ù–µ–¥–∞–≤–Ω–æ –ø–µ—Ä–µ–µ—Ö–∞–ª –∫ –±–∞–±—É—à–∫–µ –∏ –ø–æ–º–æ–≥–∞—é –µ–π –ø–æ —Ö–æ–∑—è–π—Å—Ç–≤—É.",
    "–ñ–∏–≤—É –≤ –∫–æ–º–º—É–Ω–∞–ª—å–Ω–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ —Å –ø—è—Ç—å—é —Å–æ—Å–µ–¥—è–º–∏.",
    "–ü–ª–∞–Ω–∏—Ä—É—é —ç–º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω—É —á–µ—Ä–µ–∑ –≥–æ–¥.",
    
    # –£–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç—ã
    "–Ø —É–º–µ—é –∏–≥—Ä–∞—Ç—å –Ω–∞ —Å–µ–º–∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.",
    "–í—ã–∏–≥—Ä–∞–ª –≤ –ª–æ—Ç–µ—Ä–µ—é –∫—Ä—É–ø–Ω—É—é —Å—É–º–º—É, –Ω–æ –Ω–∏–∫–æ–º—É –æ–± —ç—Ç–æ–º –Ω–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—é.",
    "–£–º–µ—é —á–∏—Ç–∞—Ç—å –ø–æ –≥—É–±–∞–º –∏ —á–∞—Å—Ç–æ –ø–æ–¥—Å–ª—É—à–∏–≤–∞—é —á—É–∂–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã.",
    "–£—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ —Å—ä–µ–º–∫–∞—Ö —Ñ–∏–ª—å–º–∞ –≤ —Ä–æ–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∞.",
    "–ú–æ–≥—É –∑–∞–ø–æ–º–Ω–∏—Ç—å –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –ª—é–±—É—é –º–µ–ª–æ–¥–∏—é —Å –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è.",
    "–û–¥–Ω–∞–∂–¥—ã —Å–ø–∞—Å —á–µ–ª–æ–≤–µ–∫–∞ –∏–∑ –≥–æ—Ä—è—â–µ–≥–æ –∑–¥–∞–Ω–∏—è.",
    "–ù–∞—à–µ–ª –∫–ª–∞–¥ –≤ —Å—Ç–∞—Ä–æ–º –¥–æ–º–µ —Å–≤–æ–µ–π –±–∞–±—É—à–∫–∏.",
    "–£–º–µ—é –∂–æ–Ω–≥–ª–∏—Ä–æ–≤–∞—Ç—å –ø—è—Ç—å—é –º—è—á–∞–º–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.",
    "–ü–æ–±—ã–≤–∞–ª –≤–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∞—Ö –ï–≤—Ä–æ–ø—ã –∑–∞ –æ–¥–∏–Ω –≥–æ–¥.",
    "–ú–æ–≥—É —Ä–µ—à–∏—Ç—å –∫—É–±–∏–∫ –†—É–±–∏–∫–∞ –∑–∞ 30 —Å–µ–∫—É–Ω–¥.",
    "–£—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ –º–∞—Ä–∞—Ñ–æ–Ω–µ –∏ —Ñ–∏–Ω–∏—à–∏—Ä–æ–≤–∞–ª –≤ –ø–µ—Ä–≤–æ–π —Å–æ—Ç–Ω–µ.",
    "–£–º–µ—é –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–∞ 20 —Ä–∞–∑–Ω—ã—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö.",
    "–û–¥–Ω–∞–∂–¥—ã –≤—Å—Ç—Ä–µ—Ç–∏–ª –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç—å –≤ —Å–ª—É—á–∞–π–Ω–æ–º –º–µ—Å—Ç–µ.",
    "–ú–æ–≥—É –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å 50 —Ä–∞–∑–Ω—ã—Ö –≤–∏–¥–æ–≤ –∫–æ—Ñ–µ.",
    "–í—ã—É—á–∏–ª –∫–∏—Ç–∞–π—Å–∫–∏–π —è–∑—ã–∫ –∑–∞ –ø–æ–ª–≥–æ–¥–∞.",
    "–£—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ —Ç–µ–ª–µ–≤–∏–∑–∏–æ–Ω–Ω–æ–π –≤–∏–∫—Ç–æ—Ä–∏–Ω–µ –∏ –≤—ã–∏–≥—Ä–∞–ª –≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–∑.",
    "–£–º–µ—é —Ä–∏—Å–æ–≤–∞—Ç—å –ø–æ—Ä—Ç—Ä–µ—Ç—ã –ª—é–¥–µ–π –ø–æ –ø–∞–º—è—Ç–∏.",
    "–û–¥–Ω–∞–∂–¥—ã –∑–∞–±–ª—É–¥–∏–ª—Å—è –≤ –ª–µ—Å—É –Ω–∞ —Ç—Ä–∏ –¥–Ω—è.",
    "–ú–æ–≥—É –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ—Ä–æ–¥—É —Å–æ–±–∞–∫–∏ –ø–æ –æ–¥–Ω–æ–º—É –ª–∞—é.",
    "–£—á–∞—Å—Ç–≤–æ–≤–∞–ª –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∏—Ä–æ–≤–æ–≥–æ —Ä–µ–∫–æ—Ä–¥–∞ –ì–∏–Ω–Ω–µ—Å—Å–∞.",
    
    # –ù–µ–æ–±—ã—á–Ω—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
    "–†–∞–±–æ—Ç–∞—é –¥–µ–≥—É—Å—Ç–∞—Ç–æ—Ä–æ–º –º–æ—Ä–æ–∂–µ–Ω–æ–≥–æ –∏ –ø—Ä–æ–±—É—é –Ω–æ–≤—ã–µ –≤–∫—É—Å—ã.",
    "–Ø –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–±–Ω–∏–º–∞–ª—å—â–∏–∫ –ø–∞–Ω–¥ –≤ –∑–æ–æ–ø–∞—Ä–∫–µ.",
    "–†–∞–±–æ—Ç–∞—é —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–æ–º –≤–æ–¥–Ω—ã—Ö –≥–æ—Ä–æ–∫ –≤ –∞–∫–≤–∞–ø–∞—Ä–∫–∞—Ö.",
    "–Ø –æ—Å—Ç—Ä–æ–≤–Ω–æ–π —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å –Ω–∞ —Ç—Ä–æ–ø–∏—á–µ—Å–∫–æ–º –æ—Å—Ç—Ä–æ–≤–µ.",
    "–†–∞–±–æ—Ç–∞—é –æ—Ö–æ—Ç–Ω–∏–∫–æ–º –∑–∞ –ø—Ä–∏–≤–∏–¥–µ–Ω–∏—è–º–∏ –≤ —Å—Ç–∞—Ä–∏–Ω–Ω—ã—Ö –∑–∞–º–∫–∞—Ö.",
    "–Ø –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ–Ω—è –∏ —Ç–µ—Å—Ç–∏—Ä—É—é –º–∞—Ç—Ä–∞—Å—ã.",
    "–†–∞–±–æ—Ç–∞—é –¥–µ–≥—É—Å—Ç–∞—Ç–æ—Ä–æ–º —à–æ–∫–æ–ª–∞–¥–∞ –≤ –∫–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–æ–π —Ñ–∞–±—Ä–∏–∫–µ.",
    "–Ø —Ç—Ä–µ–Ω–µ—Ä –¥–ª—è –ª–µ–Ω–∏–≤—Ü–µ–≤ –≤ –∑–æ–æ–ø–∞—Ä–∫–µ.",
    "–†–∞–±–æ—Ç–∞—é —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º LEGO-–º–æ–¥–µ–ª–µ–π –≤ –∏–≥—Ä—É—à–µ—á–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.",
    "–Ø –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω—é—Ö–∞—á –¥—É—Ö–æ–≤ –∏ —Å–æ–∑–¥–∞—é –Ω–æ–≤—ã–µ –∞—Ä–æ–º–∞—Ç—ã.",
    "–†–∞–±–æ—Ç–∞—é —Å–º–æ—Ç—Ä–∏—Ç–µ–ª–µ–º –º–∞—è–∫–∞ –Ω–∞ –º–æ—Ä—Å–∫–æ–º –±–µ—Ä–µ–≥—É.",
    "–Ø —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫ –∞–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏—Ö –≥–æ—Ä–æ–∫ –≤ –ø–∞—Ä–∫–∞—Ö —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–π.",
    "–†–∞–±–æ—Ç–∞—é –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞—Ç–µ–ª–µ–º –ø–∏–Ω–≥–≤–∏–Ω–æ–≤ –≤ –ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–µ.",
    "–Ø –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–∫–∞–ª—å—â–∏–∫ –Ω–∞ –ø–æ—Ö–æ—Ä–æ–Ω–∞—Ö.",
    "–†–∞–±–æ—Ç–∞—é –¥–µ–≥—É—Å—Ç–∞—Ç–æ—Ä–æ–º —Å–æ–±–∞—á—å–µ–≥–æ –∫–æ—Ä–º–∞.",
    "–Ø –æ—Ö—Ä–∞–Ω–Ω–∏–∫ –§–æ—Ä—Ç-–ù–æ–∫—Å–∞ –∏ —Å—Ç–µ—Ä–µ–≥—É –∑–æ–ª–æ—Ç–æ.",
    "–†–∞–±–æ—Ç–∞—é –≤—ã–≥—É–ª—å—â–∏–∫–æ–º –∂–∏—Ä–∞—Ñ–æ–≤ –≤ —Å–∞—Ñ–∞—Ä–∏-–ø–∞—Ä–∫–µ.",
    "–Ø –¥–µ–≥—É—Å—Ç–∞—Ç–æ—Ä –º–æ—Ä–æ–∂–µ–Ω–æ–≥–æ –¥–ª—è –∫–æ—Å–º–æ–Ω–∞–≤—Ç–æ–≤.",
    "–†–∞–±–æ—Ç–∞—é –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å—Ç–æ—è–ª—å—â–∏–∫–æ–º –≤ –æ—á–µ—Ä–µ–¥—è—Ö.",
    "–Ø —Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å –∑–∞ –µ–¥–∏–Ω–æ—Ä–æ–≥–∞–º–∏ –≤ —Å–µ–∫—Ä–µ—Ç–Ω–æ–º –∑–∞–ø–æ–≤–µ–¥–Ω–∏–∫–µ.",
    
    # –°—Ç—Ä–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∏ —á–µ—Ä—Ç—ã
    "–Ø –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –µ–º —Ä–æ–≤–Ω–æ 33 –∏–∑—é–º–∏–Ω–∫–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞–∫.",
    "–í—Å–µ–≥–¥–∞ –Ω–æ—à—É —Å —Å–æ–±–æ–π —Ä–µ–∑–∏–Ω–æ–≤—É—é —É—Ç–æ—á–∫—É –¥–ª—è —É–¥–∞—á–∏.",
    "–ú–æ–≥—É —Å–ø–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥ –∑–≤—É–∫–∏ –¥–æ–∂–¥—è –∏–ª–∏ –æ–∫–µ–∞–Ω–∞.",
    "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä—É—é –±–∏–ª–µ—Ç—ã –æ—Ç –≤—Å–µ—Ö –ø–æ–µ–∑–¥–æ–∫ –≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ.",
    "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã—Ö–æ–∂—É –∏–∑ –¥–æ–º–∞ –±–µ–∑ —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ –Ω–æ—Å–∫–∞ –Ω–∞ –ª–µ–≤–æ–π –Ω–æ–≥–µ.",
    "–†–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—é —Å —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏ –∏ –æ–Ω–∏ —Ä–∞—Å—Ç—É—Ç –ª—É—á—à–µ –¥—Ä—É–≥–∏—Ö.",
    "–í—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞—é —Å—Ç—É–ø–µ–Ω—å–∫–∏ –ø—Ä–∏ –ø–æ–¥—ä–µ–º–µ –ø–æ –ª–µ—Å—Ç–Ω–∏—Ü–µ.",
    "–ú–æ–≥—É –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤—Ä–µ–º—è —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –º–∏–Ω—É—Ç—ã –±–µ–∑ —á–∞—Å–æ–≤.",
    "–ï–º –ø–∏—Ü—Ü—É —Ç–æ–ª—å–∫–æ –≤–∏–ª–∫–æ–π –∏ –Ω–æ–∂–æ–º.",
    "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–∞—Å—Ç—É–ø–∞—é –Ω–∞ —Ç—Ä–µ—â–∏–Ω—ã –≤ –∞—Å—Ñ–∞–ª—å—Ç–µ.",
    "–ó–∞–ø–æ–º–∏–Ω–∞—é –Ω–æ–º–µ—Ä–Ω—ã–µ –∑–Ω–∞–∫–∏ –≤—Å–µ—Ö –º–∞—à–∏–Ω –Ω–∞ –º–æ–µ–π —É–ª–∏—Ü–µ.",
    "–í—Å–µ–≥–¥–∞ –º–æ—é –ø–æ—Å—É–¥—É –≤ —Å—Ç—Ä–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.",
    "–ú–æ–≥—É —É–∑–Ω–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ –∑–∞–ø–∞—Ö—É –µ–≥–æ –¥—É—Ö–æ–≤.",
    "–ß–∏—Ç–∞—é –∫–Ω–∏–≥–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–≤–µ—Ç–µ —Å–≤–µ—á–µ–π.",
    "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫—É–ø–∞—é —á–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–Ω–∞–Ω–æ–≤.",
    "–ú–æ–≥—É –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –ø–æ–≥–æ–¥—É –ø–æ –ø–æ–≤–µ–¥–µ–Ω–∏—é —Å–≤–æ–µ–≥–æ –∫–æ—Ç–∞.",
    "–í—Å–µ–≥–¥–∞ –∑–∞—Å—ã–ø–∞—é –ª–∏—Ü–æ–º –∫ —Å–µ–≤–µ—Ä—É.",
    "–ï–º —Å—É–ø —Ç–æ–ª—å–∫–æ —Å–µ—Ä–µ–±—Ä—è–Ω–æ–π –ª–æ–∂–∫–æ–π.",
    "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–æ—à—É –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –Ω–æ—Å–∫–∏.",
    "–ú–æ–≥—É –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ –µ–≥–æ –ø–æ—Ö–æ–¥–∫–µ.",
    
    # –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏
    "–£–º–µ—é –≤–∑–ª–∞–º—ã–≤–∞—Ç—å –ª—é–±—ã–µ –∑–∞–º–∫–∏ –∑–∞ 30 —Å–µ–∫—É–Ω–¥.",
    "–ú–æ–≥—É –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å 200 —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–∫—Ç–µ–π–ª–µ–π –ø–æ –ø–∞–º—è—Ç–∏.",
    "–í–ª–∞–¥–µ—é —Ç–µ—Ö–Ω–∏–∫–∞–º–∏ 15 –≤–∏–¥–æ–≤ –±–æ–µ–≤—ã—Ö –∏—Å–∫—É—Å—Å—Ç–≤.",
    "–£–º–µ—é –≤–æ–¥–∏—Ç—å –≤—Å–µ –≤–∏–¥—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –æ—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –¥–æ –≤–µ—Ä—Ç–æ–ª–µ—Ç–∞.",
    "–ú–æ–≥—É –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—á–µ—Ä–∫ –ª—é–±–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.",
    "–í–ª–∞–¥–µ—é –∏—Å–∫—É—Å—Å—Ç–≤–æ–º –≥–∏–ø–Ω–æ–∑–∞ –∏ –º–æ–≥—É —É—Å—ã–ø–∏—Ç—å —Å–ª–æ–≤–æ–º.",
    "–£–º–µ—é —á–∏—Ç–∞—Ç—å –º—ã—Å–ª–∏ –ø–æ –º–∏–º–∏–∫–µ –ª–∏—Ü–∞.",
    "–ú–æ–≥—É –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å —è–¥ –∏–∑ –æ–±—ã—á–Ω—ã—Ö —Ä–∞—Å—Ç–µ–Ω–∏–π.",
    "–í–ª–∞–¥–µ—é –∏—Å–∫—É—Å—Å—Ç–≤–æ–º –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ –∏ –º–æ–≥—É —Å—Ç–∞—Ç—å –Ω–µ–≤–∏–¥–∏–º—ã–º.",
    "–£–º–µ—é –≤–∑—Ä—ã–≤–∞—Ç—å —Å–µ–π—Ñ—ã –±–µ–∑ –¥–∏–Ω–∞–º–∏—Ç–∞.",
    "–ú–æ–≥—É –ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å –ª—é–±–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ –Ω–µ–∑–∞–º–µ—Ç–Ω–æ.",
    "–í–ª–∞–¥–µ—é —Ç–µ—Ö–Ω–∏–∫–∞–º–∏ –¥–æ–ø—Ä–æ—Å–∞ –∏ –≤—ã–≤–µ–¥—ã–≤–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤.",
    "–£–º–µ—é –ø–æ–¥–¥–µ–ª—ã–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –ª—é–±–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.",
    "–ú–æ–≥—É –≤—Å–∫—Ä—ã—Ç—å –ª—é–±–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä –∑–∞ 5 –º–∏–Ω—É—Ç.",
    "–í–ª–∞–¥–µ—é –∏—Å–∫—É—Å—Å—Ç–≤–æ–º –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏–µ.",
    "–£–º–µ—é –∏–∑–≥–æ—Ç–∞–≤–ª–∏–≤–∞—Ç—å –≤–∑—Ä—ã–≤—á–∞—Ç–∫—É –∏–∑ –±—ã—Ç–æ–≤—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤.",
    "–ú–æ–≥—É —É–±–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ –æ–¥–Ω–∏–º –ø–∞–ª—å—Ü–µ–º.",
    "–í–ª–∞–¥–µ—é —Ç–µ—Ö–Ω–∏–∫–∞–º–∏ –ø—Ä–æ–º—ã–≤–∞–Ω–∏—è –º–æ–∑–≥–æ–≤.",
    "–£–º–µ—é —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–µ–≤–∏–¥–∏–º—ã–º –≤ —Ç–æ–ª–ø–µ.",
    "–ú–æ–≥—É –ø–æ–¥—Å–ª—É—à–∏–≤–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ –∫–∏–ª–æ–º–µ—Ç—Ä–∞."
]

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

def generate_id(length=6):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∏–≥—Ä—ã"""
    chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
    return "".join(random.choice(chars) for _ in range(length))

def get_player_display_name(slot: dict, context=None) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –∏–≥—Ä–æ–∫–∞: –í—ã–º—ã—à–ª–µ–Ω–Ω–æ–µ –∏–º—è (–¢–ì –Ω–∏–∫)"""
    fictional_name = slot.get("fictional_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π")
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –¢–ì –∏–º—è –∏–∑ —Å–ª–æ—Ç–∞ (–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏)
    real_name = slot.get("real_name", "–ò–≥—Ä–æ–∫")
    
    return f"{fictional_name} ({real_name})"



def generate_math_problem(num_active_players: int):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ = –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∂–∏–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤)"""
    operation_type = random.choice(['add', 'subtract', 'multiply'])
    
    if operation_type == 'add':
        a = random.randint(1, 50)
        b = random.randint(1, 50)
        question = f"{a} + {b}"
        correct_answer = a + b
    elif operation_type == 'subtract':
        a = random.randint(20, 100)
        b = random.randint(1, a - 1)  # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        question = f"{a} - {b}"
        correct_answer = a - b
    else:  # multiply
        a = random.randint(2, 12)
        b = random.randint(2, 8)
        question = f"{a} √ó {b}"
        correct_answer = a * b
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
    wrong_answers = set()
    while len(wrong_answers) < min(num_active_players - 1, 5):  # –ú–∞–∫—Å–∏–º—É–º 5 –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–ª–∏–∑–∫–∏–µ –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –æ—Ç–≤–µ—Ç—É –∑–Ω–∞—á–µ–Ω–∏—è
        wrong_answer = correct_answer + random.randint(-10, 10)
        if wrong_answer != correct_answer and wrong_answer > 0:
            wrong_answers.add(wrong_answer)
    
    # –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –µ—â–µ
    while len(wrong_answers) < num_active_players - 1:
        wrong_answer = random.randint(max(1, correct_answer - 20), correct_answer + 20)
        if wrong_answer != correct_answer:
            wrong_answers.add(wrong_answer)
    
    # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
    all_answers = [correct_answer] + list(wrong_answers)[:num_active_players - 1]
    random.shuffle(all_answers)
    
    return question, correct_answer, all_answers

def get_passive_role_players(game_data: dict):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ —Å –ø–∞—Å—Å–∏–≤–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏ (–±–µ–∑ –Ω–æ—á–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π)"""
    passive_players = []
    for slot in game_data.get("players_slots", []):
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("user_id") and 
            slot.get("role") in PASSIVE_ROLES):
            passive_players.append(slot)
    return passive_players

async def send_math_problems_to_passive_players(game_id: str, game_data: dict, context: CallbackContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –¢–û–õ–¨–ö–û –º–∏—Ä–Ω—ã–º –∂–∏—Ç–µ–ª—è–º (—Ä–æ–ª–∏ –±–µ–∑ –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π)"""
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –ë–ï–ó –Ω–æ—á–Ω—ã—Ö —Ä–æ–ª–µ–π - —Ç–æ–ª—å–∫–æ –æ–Ω–∏ —Ä–µ—à–∞—é—Ç –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –¥–ª—è –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–∞
    players_for_math = []
    for slot in game_data.get("players_slots", []):
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("user_id") and 
            slot.get("role") not in NIGHT_ROLES):  # –¢–û–õ–¨–ö–û –º–∏—Ä–Ω—ã–µ –∂–∏—Ç–µ–ª–∏ —Ä–µ—à–∞—é—Ç –º–∞—Ç–µ–º–∞—Ç–∏–∫—É
            players_for_math.append(slot)
    
    if not players_for_math:
        logger.info(f"No passive players found for math problems in game {game_id}")
        return
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
    num_active_players = len([slot for slot in game_data.get("players_slots", []) if slot.get("status") == STATUS_ACTIVE])
    
    logger.info(f"Sending math problems to {len(players_for_math)} players in game {game_id}")
    
    for slot in players_for_math:
        user_id = slot["user_id"]
        question, correct_answer, answer_options = generate_math_problem(num_active_players)
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤
        keyboard = []
        for answer in answer_options:
            keyboard.append([InlineKeyboardButton(str(answer), callback_data=f"math_answer_{game_id}_{user_id}_{answer}")])
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_math_state[user_id] = {
            "game_id": game_id,
            "question": question,
            "correct_answer": correct_answer,
            "answer_options": answer_options,
            "attempts": 0,
            "max_attempts": 2,
            "has_voting_rights": True,
            "waiting_for_answer": True
        }
        
        try:
            await context.bot.send_message(
                user_id,
                f"üßÆ **–ù–æ—á–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ**\n\n"
                f"–ü–æ–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–æ–ª–∏ –¥–µ–π—Å—Ç–≤—É—é—Ç, —Ä–µ—à–∏—Ç–µ –ø—Ä–∏–º–µ—Ä:\n\n"
                f"**{question} = ?**\n\n"
                f"üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.\n"
                f"‚ö†Ô∏è –ü—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –≤—ã –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –¥–Ω–µ–≤–Ω–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏!",
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=reply_markup
            )
            logger.info(f"Math problem sent to user {user_id}: {question}")
        except Exception as e:
            logger.error(f"Error sending math problem to user {user_id}: {e}")

async def handle_math_button_answer(query, context: CallbackContext, game_id: str, user_id: int, selected_answer: int):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏"""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω—ã–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä
    if user_id not in user_math_state:
        await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞", show_alert=True)
        return
    
    math_state = user_math_state[user_id]
    
    if not math_state.get("waiting_for_answer"):
        await query.answer("‚ùå –ü—Ä–∏–º–µ—Ä —É–∂–µ —Ä–µ—à–µ–Ω", show_alert=True)
        return
    
    if math_state.get("game_id") != game_id:
        await query.answer("‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è –∏–≥—Ä–∞", show_alert=True)
        return
    
    correct_answer = math_state["correct_answer"]
    attempts = math_state["attempts"] + 1
    
    math_state["attempts"] = attempts
    
    if selected_answer == correct_answer:
        # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        math_state["waiting_for_answer"] = False
        math_state["has_voting_rights"] = True
        
        await query.edit_message_text(
            f"‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ!** {math_state['question']} = {correct_answer}\n\n"
                            f"üó≥Ô∏è –í—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞ –Ω–∞ –¥–Ω–µ–≤–Ω–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏.",
            parse_mode=ParseMode.MARKDOWN
        )
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –∏–≥—Ä–µ
        await update_voting_rights(game_id, user_id, True)
        
        logger.info(f"User {user_id} answered math problem correctly on attempt {attempts}")
        
    else:
        # –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        if attempts >= math_state["max_attempts"]:
            # –ò—Å—á–µ—Ä–ø–∞–Ω—ã –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏
            math_state["waiting_for_answer"] = False
            math_state["has_voting_rights"] = False
            
            await query.edit_message_text(
                f"‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!** {math_state['question']} = {correct_answer}\n\n"
                f"üòî –í—ã –∏—Å—á–µ—Ä–ø–∞–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏ —Ç–µ—Ä—è–µ—Ç–µ –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –¥–Ω–µ–≤–Ω–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏.\n"
                f"üí° –í —Å–ª–µ–¥—É—é—â—É—é –Ω–æ—á—å —É –≤–∞—Å –±—É–¥–µ—Ç –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞.",
                parse_mode=ParseMode.MARKDOWN
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –∏–≥—Ä–µ
            await update_voting_rights(game_id, user_id, False)
            
            logger.info(f"User {user_id} failed math problem after {attempts} attempts, lost voting rights")
            
        else:
            # –î–∞–µ–º –≤—Ç–æ—Ä—É—é –ø–æ–ø—ã—Ç–∫—É
            game_data = games.get(game_id)
            if game_data:
                num_active_players = len([slot for slot in game_data.get("players_slots", []) if slot.get("status") == STATUS_ACTIVE])
                new_question, new_correct_answer, new_answer_options = generate_math_problem(num_active_players)
                
                math_state["question"] = new_question
                math_state["correct_answer"] = new_correct_answer
                math_state["answer_options"] = new_answer_options
                
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                keyboard = []
                for answer in new_answer_options:
                    keyboard.append([InlineKeyboardButton(str(answer), callback_data=f"math_answer_{game_id}_{user_id}_{answer}")])
                reply_markup = InlineKeyboardMarkup(keyboard)
                
                await query.edit_message_text(
                    f"‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!** –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct_answer}\n\n"
                    f"üîÑ **–£ –≤–∞—Å –µ—Å—Ç—å –µ—â–µ –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞:**\n\n"
                    f"**{new_question} = ?**\n\n"
                    f"‚ö†Ô∏è –ü—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –≤—ã –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞!",
                    parse_mode=ParseMode.MARKDOWN,
                    reply_markup=reply_markup
                )
                
                logger.info(f"User {user_id} failed math problem on attempt {attempts}, giving second chance: {new_question}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ª–∏ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã
    await check_all_math_completed(game_id, context)

async def handle_math_answer(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã (—É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω—ã–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä
    if user_id not in user_math_state:
        return False  # –ù–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç
    
    math_state = user_math_state[user_id]
    
    if not math_state.get("waiting_for_answer"):
        return False  # –ü—Ä–∏–º–µ—Ä —É–∂–µ —Ä–µ—à–µ–Ω –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
    
    # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω—ã–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä, –Ω–æ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    # –ù–∞–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∫–Ω–æ–ø–æ–∫
    await update.message.reply_text(
        "üîò –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä.\n"
        f"–ü—Ä–∏–º–µ—Ä: **{math_state['question']} = ?**",
        parse_mode=ParseMode.MARKDOWN
    )
    
    return True  # –≠—Ç–æ –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä

async def check_all_math_completed(game_id: str, context: CallbackContext):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–≤–µ—Ä—à–∏–ª–∏ –ª–∏ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã, –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –¥–Ω—é –µ—Å–ª–∏ –¥–∞"""
    if game_id not in games:
        return
    
    game_data = games[game_id]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ (–≤–∫–ª—é—á–∞—è —Ç–∞–π–º–µ—Ä) –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –Ω–æ—á–∏
    game_mode = game_data.get("game_mode", "")
    if not ("bot_host" in game_mode) or game_data.get("state") != STATE_NIGHT:
        return
    
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã
    players_with_math = []
    for user_id, math_state in user_math_state.items():
        if math_state.get("game_id") == game_id:
            players_with_math.append(user_id)
    
    if not players_with_math:
        return  # –ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤
    all_completed = True
    for user_id in players_with_math:
        math_state = user_math_state.get(user_id, {})
        if math_state.get("waiting_for_answer", False):
            all_completed = False
            break
    
    if all_completed:
        logger.info(f"All math problems completed in game {game_id}, checking if all night actions are also complete")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –í–°–ï –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–µ —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞)
        await check_all_night_actions_completed(game_id, context)

async def check_all_night_actions_completed(game_id: str, context: CallbackContext):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –í–°–ï –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ + —Ä–æ–ª–∏)"""
    if game_id not in games:
        return
    
    game_data = games[game_id]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ (–≤–∫–ª—é—á–∞—è —Ç–∞–π–º–µ—Ä) –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –Ω–æ—á–∏
    game_mode = game_data.get("game_mode", "")
    if not ("bot_host" in game_mode) or game_data.get("state") != STATE_NIGHT:
        return
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥
    if game_data.get("night_completion_processing", False):
        return  # –£–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ—á–∏
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    game_data["night_completion_processing"] = True
    games[game_id] = game_data
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã
    players_with_math = []
    for user_id, math_state in user_math_state.items():
        if math_state.get("game_id") == game_id:
            players_with_math.append(user_id)
    
    math_completed = True
    for user_id in players_with_math:
        math_state = user_math_state.get(user_id, {})
        if math_state.get("waiting_for_answer", False):
            math_completed = False
            break
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è –Ω–æ—á–Ω—ã—Ö —Ä–æ–ª–µ–π
    night_roles_completed = True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ñ–∏—é
    mafia_count = len([slot for slot in game_data["players_slots"] 
                      if slot.get("status") == STATUS_ACTIVE and 
                         slot.get("role") in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]])
    
    if mafia_count > 0:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ —Ü–µ–ª—å –º–∞—Ñ–∏–∏ (–∫—Ç–æ-—Ç–æ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ targeted_by_mafia)
        mafia_target_chosen = False
        for slot in game_data["players_slots"]:
            if slot.get("targeted_by_mafia"):
                mafia_target_chosen = True
                break
        
        if not mafia_target_chosen:
            night_roles_completed = False
            logger.info(f"Waiting for mafia to choose target")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–∫—Ç–æ—Ä–∞
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") == "–î–æ–∫—Ç–æ—Ä"):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –¥–æ–∫—Ç–æ—Ä —Å–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–≤—ã–ª–µ—á–∏–ª –∫–æ–≥–æ-—Ç–æ –ò–õ–ò –ø—Ä–æ–ø—É—Å—Ç–∏–ª —Ö–æ–¥)
            doctor_acted = False
            if slot.get("doctor_action_complete", False):
                doctor_acted = True
            else:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—á–µ–Ω –ª–∏ –∫—Ç–æ-—Ç–æ –∫–∞–∫ —Å–ø–∞—Å–µ–Ω–Ω—ã–π –¥–æ–∫—Ç–æ—Ä–æ–º
                for check_slot in game_data["players_slots"]:
                    if check_slot.get("saved_by_doctor"):
                        doctor_acted = True
                        break
            
            if not doctor_acted:
                night_roles_completed = False
                logger.info(f"Waiting for doctor action")
            break
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∏—Å—Å–∞—Ä–∞  
    commissioner_acted = True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –∫–æ–º–∏—Å—Å–∞—Ä –Ω–µ –Ω—É–∂–µ–Ω
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") == "–ö–æ–º–∏—Å—Å–∞—Ä"):
            # –ï—Å–ª–∏ –∫–æ–º–∏—Å—Å–∞—Ä –µ—Å—Ç—å –≤ –∏–≥—Ä–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –æ–Ω –¥–µ–π—Å—Ç–≤–∏–µ
            if not slot.get("commissioner_action_complete", False):
                commissioner_acted = False
                logger.info(f"Waiting for commissioner action")
            break
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–Ω—å—è–∫–∞
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") == "–ú–∞–Ω—å—è–∫"):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª –ª–∏ –º–∞–Ω—å—è–∫ —Å–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (—É–±–∏–ª –∫–æ–≥–æ-—Ç–æ –ò–õ–ò –ø—Ä–æ–ø—É—Å—Ç–∏–ª —Ö–æ–¥)
            maniac_acted = False
            if slot.get("maniac_action_complete", False):
                maniac_acted = True
            else:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—á–µ–Ω –ª–∏ –∫—Ç–æ-—Ç–æ –∫–∞–∫ —Ü–µ–ª—å –º–∞–Ω—å—è–∫–∞
                for check_slot in game_data["players_slots"]:
                    if check_slot.get("targeted_by_maniac"):
                        maniac_acted = True
                        break
            
            if not maniac_acted:
                night_roles_completed = False
                logger.info(f"Waiting for maniac action")
            break
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç–∞–Ω—É
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") == "–ü—É—Ç–∞–Ω–∞"):
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª–∞ –ª–∏ –ø—É—Ç–∞–Ω–∞ —Å–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –∫–æ–≥–æ-—Ç–æ –ò–õ–ò –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∞ —Ö–æ–¥)
            prostitute_acted = False
            if slot.get("prostitute_action_complete", False):
                prostitute_acted = True
            else:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –∫—Ç–æ-—Ç–æ –ø—É—Ç–∞–Ω–æ–π
                for check_slot in game_data["players_slots"]:
                    if check_slot.get("blocked_by_prostitute"):
                        prostitute_acted = True
                        break
            
            if not prostitute_acted:
                night_roles_completed = False
                logger.info(f"Waiting for prostitute action")
            break
    
    logger.info(f"Night actions status for game {game_id}: math={math_completed}, roles={night_roles_completed}")
    
    # –ï—Å–ª–∏ –í–°–ï –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–Ω—é
    if math_completed and night_roles_completed:
        logger.info(f"All night actions completed in game {game_id}, starting day early")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º
        for slot in game_data["players_slots"]:
            if slot.get("status") == STATUS_ACTIVE and slot.get("user_id"):
                try:
                    await context.bot.send_message(
                        slot["user_id"],
                        "‚úÖ **–í—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã!**\n\n"
                        "üåÖ –ì–æ—Ä–æ–¥ –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è...",
                        parse_mode=ParseMode.MARKDOWN
                    )
                except Exception as e:
                    logger.error(f"Error sending early day message to player {slot.get('user_id')}: {e}")
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–Ω—é —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        import asyncio
        asyncio.create_task(start_day_after_math_completion(game_id, context))
    else:
        # –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
        game_data["night_completion_processing"] = False
        games[game_id] = game_data

async def start_day_after_math_completion(game_id: str, context: CallbackContext):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –¥–µ–Ω—å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤"""
    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ –¥–Ω—é
    try:
        await asyncio.sleep(3)  # 3 —Å–µ–∫—É–Ω–¥—ã –∑–∞–¥–µ—Ä–∂–∫–∏
    except Exception as e:
        logger.error(f"Error during sleep in start_day_after_math_completion: {e}")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    game_data = games.get(game_id)
    if not game_data or game_data.get("state") != STATE_NIGHT:
        return
    
    # –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    game_data["night_completion_processing"] = False
    games[game_id] = game_data
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–Ω—é
    await start_day_after_night(game_id, game_data, context)

async def update_voting_rights(game_id: str, user_id: int, has_rights: bool):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∏–≥—Ä–æ–∫–∞ –≤ –∏–≥—Ä–µ"""
    if game_id not in games:
        return
    
    game_data = games[game_id]
    
    # –ù–∞—Ö–æ–¥–∏–º –∏–≥—Ä–æ–∫–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    for i, slot in enumerate(game_data.get("players_slots", [])):
        if slot.get("user_id") == user_id:
            player_key = f"player_{i}"
            if "day_voting_rights" not in game_data:
                game_data["day_voting_rights"] = {}
            game_data["day_voting_rights"][player_key] = has_rights
            break
    
    games[game_id] = game_data
    logger.info(f"Updated voting rights for user {user_id} in game {game_id}: {has_rights}")

def get_start_message_text_and_keyboard():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    text = (
        "üé≠ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ú–ê–§–ò–Æ!*\n\n"
        "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏–≥—Ä–∞ —Ç–µ–ø–µ—Ä—å –≤ Telegram!\n"
        "–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏–≥—Ä—ã, –ø—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –∞—Ç–º–æ—Å—Ñ–µ—Ä–æ–π –¥–µ—Ç–µ–∫—Ç–∏–≤–∞.\n\n"
        
        "*–î–æ—Å—Ç—É–ø–Ω–æ 2 —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã:*\n\n"
        
        "üÜì *–ë–ï–°–ü–õ–ê–¢–ù–´–ô –†–ï–ñ–ò–ú:*\n"
        "‚Ä¢ –î–æ 8 –∏–≥—Ä–æ–∫–æ–≤\n"
        "‚Ä¢ –í–µ–¥—É—â–∏–π - –≤—ã –∏–ª–∏ –±–æ—Ç\n"
        "‚Ä¢ –ë–∞–∑–æ–≤—ã–µ —Ä–æ–ª–∏ (–ú–∞—Ñ–∏–æ–∑–∏, –ö–æ–º–∏—Å—Å–∞—Ä, –î–æ–∫—Ç–æ—Ä, –ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å)\n"
        "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π\n\n"
        
        "üíé *–ü–†–ï–ú–ò–£–ú –†–ï–ñ–ò–ú:*\n"
        "‚Ä¢ –î–æ 20 –∏–≥—Ä–æ–∫–æ–≤\n"
        "‚Ä¢ –í–µ–¥—É—â–∏–π - –≤—ã –ò–õ–ò —É–º–Ω—ã–π –±–æ—Ç\n"
        "‚Ä¢ –í–°–ï —Ä–æ–ª–∏ (–î–æ–Ω –ú–∞—Ñ–∏–∏, –ú–∞–Ω—å—è–∫, –ü—É—Ç–∞–Ω–∞ –∏ –¥—Ä.)\n"
        "‚Ä¢ –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π\n"
        "‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\n"
        
        "üöÄ –ù–∞—á–Ω–∏—Ç–µ –∏–≥—Ä–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!"
    )
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üéÆ –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É", callback_data="create_game")],
        [InlineKeyboardButton("üìñ –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã", callback_data="rules")],
        [InlineKeyboardButton("üéØ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–º–æ (14 –¥–Ω–µ–π)", callback_data="activate_demo")],
        [InlineKeyboardButton("üíé –û –ü—Ä–µ–º–∏—É–º", callback_data="get_premium")]
    ])
    
    return text, keyboard



async def assign_roles_standard(num_players: int):
    """–†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª–∏ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∏–≥—Ä—ã"""
    if num_players < 4:
        return None
    
    # –ë–∞–∑–æ–≤–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞
    roles = []
    
    if num_players == 4:
        roles = ["–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    elif num_players == 5:
        roles = ["–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    elif num_players == 6:
        roles = ["–ú–∞—Ñ–∏–æ–∑–∏", "–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    elif num_players == 7:
        roles = ["–ú–∞—Ñ–∏–æ–∑–∏", "–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    elif num_players == 8:
        roles = ["–î–æ–Ω –ú–∞—Ñ–∏–∏", "–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    elif num_players >= 9:
        # –î–ª—è –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
        mafia_count = max(2, num_players // 3)
        roles = ["–î–æ–Ω –ú–∞—Ñ–∏–∏"] + ["–ú–∞—Ñ–∏–æ–∑–∏"] * (mafia_count - 1)
        roles.extend(["–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä"])
        
        if num_players >= 10:
            roles.append("–ú–∞–Ω—å—è–∫")
        if num_players >= 12:
            roles.append("–ü—É—Ç–∞–Ω–∞")
            
        # –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–µ—Å—Ç–∞ –º–∏—Ä–Ω—ã–º–∏ –∂–∏—Ç–µ–ª—è–º–∏
        while len(roles) < num_players:
            roles.append("–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å")
    
    # –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è
    for _ in range(3):
        random.shuffle(roles)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è
    roles = random.sample(roles, len(roles))
    
    return roles

async def assign_roles_free(num_players: int):
    """–†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª–∏ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –∏–≥—Ä—ã (4-8 –∏–≥—Ä–æ–∫–æ–≤)"""
    if num_players < 4 or num_players > 8:
        return None
    
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ - —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —Ä–æ–ª–∏
    roles = []
    
    if num_players == 4:
        roles = ["–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    elif num_players == 5:
        roles = ["–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    elif num_players == 6:
        roles = ["–ú–∞—Ñ–∏–æ–∑–∏", "–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    elif num_players == 7:
        roles = ["–ú–∞—Ñ–∏–æ–∑–∏", "–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    elif num_players == 8:
        roles = ["–ú–∞—Ñ–∏–æ–∑–∏", "–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å"]
    
    # –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è
    for _ in range(3):
        random.shuffle(roles)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è
    roles = random.sample(roles, len(roles))
    
    return roles

async def start(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    args = context.args

    # –ï—Å–ª–∏ –µ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã, —ç—Ç–æ –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ
    if args:
        game_id = args[0]
        if game_id.startswith("join_"):
            game_id = game_id[5:]
        
        if game_id not in games:
            await update.message.reply_text("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return
        
        await join_game(update, context, game_id)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä–µ
    active_sessions = await find_all_player_game_sessions(user.id)
    
    if active_sessions:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –∏–≥—Ä–µ
        current_game_id = active_sessions[0][0]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –∏–≥—Ä—É
        
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üéÆ –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É", callback_data="create_game")],
            [InlineKeyboardButton("üö™ –ü–æ–∫–∏–Ω—É—Ç—å —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É", callback_data=f"leave_game_{current_game_id}")],
            [InlineKeyboardButton("üìñ –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã", callback_data="rules")],
            [InlineKeyboardButton("üíé –û –ü—Ä–µ–º–∏—É–º", callback_data="get_premium")]
        ])
        
        text = (
            "üé≠ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ú–ê–§–ò–Æ!*\n\n"
            f"‚ö†Ô∏è *–í—ã —Å–µ–π—á–∞—Å —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –∏–≥—Ä–µ: {current_game_id}*\n\n"
            "üîÑ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É –∏–ª–∏ –ø–æ–∫–∏–Ω—É—Ç—å —Ç–µ–∫—É—â—É—é?"
        )
        
        await update.message.reply_text(text, parse_mode=None, reply_markup=keyboard)
    else:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é
        text, keyboard = get_start_message_text_and_keyboard()
        await update.message.reply_text(text, parse_mode=None, reply_markup=keyboard)

async def update_game_status_for_all_players(game_id: str, context: CallbackContext):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"""
    game_data = games.get(game_id)
    if not game_data:
        return
    
    filled_slots = sum(1 for s in game_data['players_slots'] if s.get('user_id'))
    total_slots = game_data.get('num_players', 6)
    
    status_message = (
        f"üë• –°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã {game_id}\n\n"
        f"–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–æ—Å—å: {filled_slots}/{total_slots} –∏–≥—Ä–æ–∫–æ–≤\n"
        f"üïê –û–∂–∏–¥–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤..."
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–≤—à–∏–º—Å—è –∏–≥—Ä–æ–∫–∞–º
    for slot in game_data['players_slots']:
        if slot.get('user_id'):
            try:
                await context.bot.send_message(
                    slot['user_id'],
                    status_message,
                    parse_mode=None  # –£–±–∏—Ä–∞–µ–º markdown –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫
                )
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä–æ–∫—É {slot['user_id']}: {e}")

async def join_game(update: Update, context: CallbackContext, game_id: str):
    """–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –∫ –∏–≥—Ä–µ"""
    user = update.effective_user
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if game_id not in games:
        await update.message.reply_text("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
        return

    game = games[game_id]
    
    # –í —Ä–µ–∂–∏–º–µ human_host —Ö–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –∏–≥—Ä–æ–∫
    if (game.get('game_mode') == 'human_host' and 
        game.get('host_id') == user.id):
        await update.message.reply_text(
            "‚ùå –í—ã —è–≤–ª—è–µ—Ç–µ—Å—å –≤–µ–¥—É—â–∏–º —ç—Ç–æ–π –∏–≥—Ä—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ –∏–≥—Ä–æ–∫.\n"
            "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /manage –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π."
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ –∫ –≠–¢–û–ô –∏–≥—Ä–µ
    for slot in game.get('players_slots', []):
        if slot.get('user_id') == user.id:
            await update.message.reply_text("‚úÖ –í—ã —É–∂–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —ç—Ç–æ–π –∏–≥—Ä–µ!")
            return
    
    # –ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –¥—Ä—É–≥–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–∞—Ö
    active_sessions = await find_all_player_game_sessions(user.id)
    if active_sessions:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–∞—Ö
        other_games = [session[0] for session in active_sessions if session[0] != game_id]
        
        if other_games:
            # –û–±—ã—á–Ω–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∏–≥—Ä–∞, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ª—É—á–∞–π
            current_game = other_games[0]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –∏–≥—Ä—É
            
            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("üö™ –ü–æ–∫–∏–Ω—É—Ç—å —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É", 
                                    callback_data=f"leave_games_and_join_{game_id}")],
                [InlineKeyboardButton("‚ùå –û—Å—Ç–∞—Ç—å—Å—è –≤ —Ç–µ–∫—É—â–µ–π –∏–≥—Ä–µ", 
                                    callback_data="cancel_join")]
            ])
            
            await update.message.reply_text(
                f"‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏–≥—Ä!\n\n"
                f"–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä–µ: {current_game}\n\n"
                f"üé≠ –ù–µ–ª—å–∑—è —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –¥–≤—É—Ö –∏–≥—Ä–∞—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.\n\n"
                f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=keyboard,
                parse_mode=None
            )
            return
    
    # –ò—â–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π —Å–ª–æ—Ç
    for i, slot in enumerate(game.get('players_slots', [])):
        if not slot.get('user_id'):
            # –ù–∞–∑–Ω–∞—á–∞–µ–º –∏–≥—Ä–æ–∫–∞ –≤ —ç—Ç–æ—Ç —Å–ª–æ—Ç
            slot['user_id'] = user.id
            slot['_user_first_name'] = user.first_name
            slot['player_number_for_host'] = i + 1
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¢–ì –∏–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            real_name = user.first_name or "–ò–≥—Ä–æ–∫"
            if user.last_name:
                real_name += f" {user.last_name}"
            slot['real_name'] = real_name
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—é–∑–Ω–∏–∫–æ–≤ –º–∞—Ñ–∏–∏
            mafia_allies_text = ""
            if slot['role'] in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]:
                allies = []
                for other_slot in game['players_slots']:
                    if (other_slot.get('user_id') and 
                        other_slot.get('user_id') != user.id and
                        other_slot.get('role') in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]):
                        allies.append(f"{other_slot['fictional_name']} ({other_slot.get('real_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')})")
                
                if allies:
                    mafia_allies_text = f"\nü§ù –í–∞—à–∏ —Å–æ—é–∑–Ω–∏–∫–∏ –≤ –º–∞—Ñ–∏–∏:\n‚Ä¢ " + "\n‚Ä¢ ".join(allies) + "\n"
                else:
                    mafia_allies_text = "\nüë§ –í—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –º–∞—Ñ–∏—è –≤ —ç—Ç–æ–π –∏–≥—Ä–µ.\n"

            # –î–ª—è —Ç–∞–π–º–µ—Ä-–∏–≥—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Ä–æ–ª–∏
            if game.get('state') == STATE_TIMER_WAITING:
                filled_slots = sum(1 for s in game['players_slots'] if s.get('user_id'))
                total_slots = game.get('max_players', 20)
                
                # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –¥–æ —Å—Ç–∞—Ä—Ç–∞
                timer_started = game.get('timer_started_at')
                if timer_started:
                    from datetime import datetime
                    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ datetime –æ–±—ä–µ–∫—Ç
                    if isinstance(timer_started, str):
                        timer_started = datetime.strptime(timer_started, "%Y-%m-%d %H:%M:%S")
                    elapsed = datetime.now() - timer_started
                    remaining_time = max(0, 180 - int(elapsed.total_seconds()))
                    remaining_minutes = remaining_time // 60
                    remaining_seconds = remaining_time % 60
                    time_text = f"{remaining_minutes}:{remaining_seconds:02d}"
                else:
                    time_text = "3:00"
                
                message_text = (
                    f"üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!\n\n"
                    f"–í–∞—à–µ –∏–º—è: {slot['fictional_name']}\n"
                    f"–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è: {slot['description']}\n\n"
                    f"‚è∞ –†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏: –ß–µ—Ä–µ–∑ 3 –º–∏–Ω—É—Ç—ã –∏–≥—Ä–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å —Ç–µ–º–∏, –∫—Ç–æ —É—Å–ø–µ–ª –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è!\n"
                    f"‚è±Ô∏è –û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è: {time_text}\n"
                    f"üë• –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–æ—Å—å –∏–≥—Ä–æ–∫–æ–≤: {filled_slots}/{total_slots}\n"
                    f"üéØ –ú–∏–Ω–∏–º—É–º –¥–ª—è —Å—Ç–∞—Ä—Ç–∞: 4 –∏–≥—Ä–æ–∫–∞\n\n"
                    f"üé≠ –í–∞—à–∞ —Ä–æ–ª—å –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏!\n\n"
                    f"üí¨ –°–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞: –ü–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É."
                )
            else:
                # –û–±—ã—á–Ω—ã–µ –∏–≥—Ä—ã - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å —Ä–æ–ª—å—é
                message_text = (
                    f"üé≠ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É!\n\n"
                    f"–í–∞—à–µ –∏–º—è: {slot['fictional_name']}\n"
                    f"–í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è: {slot['description']}\n"
                    f"**–í–∞—à–∞ —Ä–æ–ª—å: {slot['role']}**\n\n"
                    f"{get_role_description(slot['role'])}"
                    f"{mafia_allies_text}\n"
                    f"üí¨ –°–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞: –ü–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É.\n\n"
                    f"‚è≥ –û–∂–∏–¥–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤..."
                )
            
            await update.message.reply_text(message_text)
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤–µ–¥—É—â–µ–≥–æ –¢–û–õ–¨–ö–û –≤ —Ä–µ–∂–∏–º–µ human_host (–≥–¥–µ —Ö–æ—Å—Ç = –≤–µ–¥—É—â–∏–π, –Ω–µ –∏–≥—Ä–æ–∫)
            game_mode = game.get('game_mode', 'human_host')
            if game_mode == 'human_host':
                # –í —Ä–µ–∂–∏–º–µ —Å —á–µ–ª–æ–≤–µ–∫–æ–º-–≤–µ–¥—É—â–∏–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–æ–ª–∏ —Ö–æ—Å—Ç—É (–æ–Ω –≤–µ–¥—É—â–∏–π)
                try:
                    await context.bot.send_message(
                        game['host_id'],
                        f"‚úÖ –ò–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è!\n"
                        f"–°–ª–æ—Ç {i + 1}: {user.first_name} ({slot['fictional_name']})\n"
                        f"–†–æ–ª—å: {slot['role']}",
                        parse_mode=None
                    )
                except:
                    pass
            # –í —Ä–µ–∂–∏–º–µ bot_host –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
            # (—Ö–æ—Å—Ç —Ç–æ–∂–µ –∏–≥—Ä–æ–∫ –∏ –ø–æ–ª—É—á–∏—Ç –æ–±—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—Å–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—Å—è)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –∏–≥—Ä–æ–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å
            filled_slots = sum(1 for s in game['players_slots'] if s.get('user_id'))
            
            # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ç–∞–π–º–µ—Ä–∞
            if game.get('state') == STATE_TIMER_WAITING:
                # –î–ª—è —Ç–∞–π–º–µ—Ä-–∏–≥—Ä –∏—Å–ø–æ–ª—å–∑—É–µ–º max_players
                total_slots = game.get('max_players', 20)
                
                # –ó–ê–ü–£–°–ö–ê–ï–ú –¢–ê–ô–ú–ï–† –ü–†–ò –ü–†–ò–°–û–ï–î–ò–ù–ï–ù–ò–ò –ü–ï–†–í–û–ì–û –ò–ì–†–û–ö–ê
                if filled_slots == 1 and not game.get('timer_started', False):
                    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ç–∞–π–º–µ—Ä–∞
                    from datetime import datetime
                    game['timer_started_at'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    game['timer_started'] = True
                    
                    # –ó–∞–ø—É—Å–∫–∞–µ–º 3-–º–∏–Ω—É—Ç–Ω—ã–π —Ç–∞–π–º–µ—Ä –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    import asyncio
                    asyncio.create_task(start_timer_game_after_delay(game_id, context))
                    asyncio.create_task(auto_update_timer_status(game_id, context))
                    
                    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –æ –∑–∞–ø—É—Å–∫–µ —Ç–∞–π–º–µ—Ä–∞
                    try:
                        await context.bot.send_message(
                            user.id,
                            f"‚è∞ –¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω! –ò–≥—Ä–∞ –Ω–∞—á–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑ 3 –º–∏–Ω—É—Ç—ã.\n"
                            f"üë• –ò–≥—Ä–æ–∫–æ–≤: {filled_slots}/{total_slots}\n"
                            f"üéØ –ú–∏–Ω–∏–º—É–º –¥–ª—è —Å—Ç–∞—Ä—Ç–∞: 4 –∏–≥—Ä–æ–∫–∞\n\n"
                            f"üì¢ –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –ø–æ —Å—Å—ã–ª–∫–µ!"
                        )
                    except:
                        pass
                else:
                    # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ
                    remaining_time_msg = ""
                    if game.get('timer_started_at'):
                        try:
                            from datetime import datetime, timedelta
                            start_time = datetime.strptime(game['timer_started_at'], "%Y-%m-%d %H:%M:%S")
                            elapsed = datetime.now() - start_time
                            remaining = timedelta(minutes=3) - elapsed
                            if remaining.total_seconds() > 0:
                                minutes = int(remaining.total_seconds() // 60)
                                seconds = int(remaining.total_seconds() % 60)
                                remaining_time_msg = f"‚è∞ –î–æ —Å—Ç–∞—Ä—Ç–∞: {minutes}:{seconds:02d}\n"
                        except:
                            remaining_time_msg = "‚è∞ –ò–≥—Ä–∞ —Å–∫–æ—Ä–æ –Ω–∞—á–Ω–µ—Ç—Å—è!\n"
                    
                    for slot in game['players_slots']:
                        if slot.get('user_id') and slot.get('user_id') != user.id:
                            try:
                                await context.bot.send_message(
                                    slot['user_id'],
                                    f"üë• –ö –∏–≥—Ä–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –Ω–æ–≤—ã–π –∏–≥—Ä–æ–∫!\n"
                                    f"–ò–≥—Ä–æ–∫–æ–≤: {filled_slots}/{total_slots}\n"
                                    f"{remaining_time_msg}"
                                    f"üéØ –ú–∏–Ω–∏–º—É–º –¥–ª—è —Å—Ç–∞—Ä—Ç–∞: 4 –∏–≥—Ä–æ–∫–∞"
                                )
                            except:
                                pass
                
                # –í —Ä–µ–∂–∏–º–µ —Ç–∞–π–º–µ—Ä–∞ –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –¥–æ—Å—Ä–æ—á–Ω–æ - —Ç–æ–ª—å–∫–æ –∂–¥–µ–º —Ç–∞–π–º–µ—Ä
                return
            
            # –û–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º num_players
            total_slots = game.get('num_players', 6)
            if filled_slots >= total_slots:
                game['state'] = 'ready'
                
                # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
                if game_mode == 'human_host':
                    await context.bot.send_message(
                        game['host_id'],
                        f"üéâ –í—Å–µ –∏–≥—Ä–æ–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å!\n"
                        f"–ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É.",
                        parse_mode=None
                    )
                else:
                    await context.bot.send_message(
                        game['host_id'],
                        f"üéâ –í—Å–µ –∏–≥—Ä–æ–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å!\n"
                        f"ü§ñ –ë–æ—Ç-–≤–µ–¥—É—â–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–≥—Ä—É...",
                        parse_mode=None
                    )
                
                # –ï—Å–ª–∏ —ç—Ç–æ –±–æ—Ç-–≤–µ–¥—É—â–∏–π, –∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                if game.get('game_mode') == 'bot_host':
                    await start_bot_hosted_game(game_id, game, context)
                    
            else:
                # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ –¢–û–õ–¨–ö–û –≤ —Ä–µ–∂–∏–º–µ human_host
                if game_mode == 'human_host':
                    await context.bot.send_message(
                        game['host_id'],
                        f"üìä –°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã:\n"
                        f"–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–æ—Å—å: {filled_slots}/{total_slots} –∏–≥—Ä–æ–∫–æ–≤",
                        parse_mode=None
                    )
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ –ª—é–±–æ–º —Ä–µ–∂–∏–º–µ
                await update_game_status_for_all_players(game_id, context)
            return
    
    # –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞, –∑–Ω–∞—á–∏—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–µ—Ç
    await update.message.reply_text("‚ùå –í –∏–≥—Ä–µ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç.")

async def start_bot_hosted_game(game_id: str, game_data: dict, context: CallbackContext):
    """–ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã —Å –±–æ—Ç–æ–º-–≤–µ–¥—É—â–∏–º - –ø–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è"""
    try:
        logger.info(f"Starting bot-hosted game logic for game {game_id}")

        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
        game_data = games.get(game_id, game_data)

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏ —Ö–æ—Å—Ç–∞ –æ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã
        host_id = game_data["host_id"]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ö–æ—Å—Ç –∏–≥—Ä–æ–∫–æ–º
        host_is_player = any(slot.get("status") == STATUS_ACTIVE and slot.get("user_id") == host_id 
                           for slot in game_data["players_slots"])

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –æ –∑–∞–ø—É—Å–∫–µ –∏–≥—Ä—ã
        for slot in game_data["players_slots"]:
            if slot.get("status") == STATUS_ACTIVE and slot.get("user_id"):
                try:
                    await context.bot.send_message(
                        slot["user_id"],
                        f"‚úÖ –ò–≥—Ä–∞ {game_id} –≤ —Ä–µ–∂–∏–º–µ '–í–µ–¥—É—â–∏–π - –ë–æ—Ç' –∑–∞–ø—É—â–µ–Ω–∞! –í—Å–µ –∏–≥—Ä–æ–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å."
                    )
                except Exception as e:
                    logger.error(f"Error sending game start notification to player {slot.get('user_id')}: {e}")

        # –£–≤–µ–¥–æ–º–ª—è–µ–º —Ö–æ—Å—Ç–∞ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω –ù–ï –∏–≥—Ä–æ–∫ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
        if not host_is_player:
            try:
                await context.bot.send_message(
                    host_id,
                    f"‚úÖ –ò–≥—Ä–∞ {game_id} –≤ —Ä–µ–∂–∏–º–µ '–í–µ–¥—É—â–∏–π - –ë–æ—Ç' –∑–∞–ø—É—â–µ–Ω–∞! –í—Å–µ –∏–≥—Ä–æ–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å."
                )
            except Exception as e:
                logger.error(f"Error sending game start notification to host: {e}")

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä—É –∫ —Å—Ç–∞—Ä—Ç—É - –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
        game_data["state"] = STATE_DAY
        game_data["current_day_number"] = 1
        game_data["current_night_number"] = 0
        game_data["math_examples"] = {}
        game_data["math_answers"] = {}
        game_data["day_voting_rights"] = {}
        game_data["first_day_skip_votes"] = set()  # –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
        game_data["night_actions"] = {}
        game_data["day_votes"] = {}

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è: —Ä–æ–ª–∏ —Å –Ω–æ—á–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ = –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∞, –º–∏—Ä–Ω—ã–µ = –Ω–µ—Ç
        for i, slot in enumerate(game_data["players_slots"]):
            if slot.get("status") == STATUS_ACTIVE:
                player_key = f"player_{i}"
                # –†–æ–ª–∏ —Å –Ω–æ—á–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –ø–æ–ª—É—á–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–∞
                has_night_role = slot.get("role") in NIGHT_ROLES
                game_data["day_voting_rights"][player_key] = has_night_role

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
        games[game_id] = game_data

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –æ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
        await announce_first_day(game_id, game_data, context)
        
        logger.info(f"–ë–æ—Ç-–≤–µ–¥—É—â–∏–π: –∏–≥—Ä–∞ {game_id} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–≥—Ä—ã —Å –±–æ—Ç–æ–º-–≤–µ–¥—É—â–∏–º {game_id}: {e}")

async def announce_first_day(game_id: str, game_data: dict, context: CallbackContext):
    """–û–±—ä—è–≤–ª—è–µ—Ç –æ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä –Ω–∞ 10 –º–∏–Ω—É—Ç"""
    logger.info(f"Announcing first day for game {game_id}")

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    game_data = games.get(game_id, game_data)

    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∏–≥—Ä–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    game_data["state"] = STATE_DAY
    game_data["current_day_number"] = 1
    if "first_day_skip_votes" not in game_data:
        game_data["first_day_skip_votes"] = set()
    games[game_id] = game_data

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    keyboard = [[InlineKeyboardButton("‚≠ï –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å", callback_data=f"skip_first_day_{game_id}")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    day_message = (
        "üåÖ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –≥–æ—Ä–æ–¥! –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –∏–≥—Ä—ã.\n\n"
        "–°–µ–π—á–∞—Å —É –≤–∞—Å –µ—Å—Ç—å 10 –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –∏ –æ–±—Å—É–¥–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å, –µ—Å–ª–∏ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –≥–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.\n\n"
        "üí¨ –ß–ê–¢ –ê–ö–¢–ò–í–ï–ù! –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É, –∏ –æ–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –∂–∏–≤—ã–º –∏–≥—Ä–æ–∫–∞–º.\n\n"
        "üìä –°—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:\n"
        "üó≥Ô∏è –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏: 0/N\n"
        "‚è≥ –û–∂–∏–¥–∞–µ–º –≥–æ–ª–æ—Å–æ–≤ –∏–≥—Ä–æ–∫–æ–≤..."
    )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ö–æ—Å—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –∏–≥—Ä—ã
    host_is_player = False
    for slot in game_data["players_slots"]:
        if slot.get("status") == STATUS_ACTIVE and slot.get("user_id") == game_data["host_id"]:
            host_is_player = True
            break

    # –°–ø–∏—Å–æ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    sent_messages = []
    total_players = len([slot for slot in game_data["players_slots"] if slot.get("status") == STATUS_ACTIVE])

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º
    for slot in game_data["players_slots"]:
        if slot.get("status") == STATUS_ACTIVE and slot.get("user_id"):
            try:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏–≥—Ä–æ–∫–æ–≤
                player_message = day_message.replace("üó≥Ô∏è –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏: 0/N", f"üó≥Ô∏è –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏: 0/{total_players}")
                
                message = await context.bot.send_message(
                    slot["user_id"],
                    player_message,
                    reply_markup=reply_markup,
                    parse_mode=None
                )
                sent_messages.append({
                    "chat_id": message.chat_id,
                    "message_id": message.message_id
                })
            except Exception as e:
                logger.error(f"Error sending first day message to player {slot.get('user_id')}: {e}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ö–æ—Å—Ç—É –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –∏–≥—Ä—ã –ò –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
    if not host_is_player and game_data.get("game_mode") != "bot_host":
        try:
            host_message = f"üåÖ –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –Ω–∞—á–∞–ª—Å—è –≤ –∏–≥—Ä–µ {game_id}. –ò–≥—Ä–æ–∫–∏ –∏–º–µ—é—Ç 10 –º–∏–Ω—É—Ç –Ω–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∏–ª–∏ –º–æ–≥—É—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ.\n\nüìä –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ: 0/{total_players}"
            
            message = await context.bot.send_message(
                game_data["host_id"],
                host_message,
                reply_markup=reply_markup,
                parse_mode=None
            )
            sent_messages.append({
                "chat_id": message.chat_id,
                "message_id": message.message_id
            })
        except Exception as e:
            logger.error(f"Error sending first day message to host: {e}")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    game_data["first_day_messages"] = sent_messages
    games[game_id] = game_data

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 10 –º–∏–Ω—É—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    import asyncio
    asyncio.create_task(end_first_day_after_timeout(game_id, context))

async def end_first_day_after_timeout(game_id: str, context: CallbackContext):
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –ø–æ—Å–ª–µ 10-–º–∏–Ω—É—Ç–Ω–æ–≥–æ —Ç–∞–π–º–∞—É—Ç–∞"""
    # –ñ–¥–µ–º 10 –º–∏–Ω—É—Ç
    try:
        await asyncio.sleep(600)  # 10 –º–∏–Ω—É—Ç = 600 —Å–µ–∫—É–Ω–¥
    except Exception as e:
        logger.error(f"Error during sleep in end_first_day_after_timeout: {e}")
        return

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    game_data = games.get(game_id)
    if not game_data:
        logger.error(f"Game {game_id} not found when ending first day")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ –≤—Å–µ –µ—â–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    if game_data.get("state") != STATE_DAY or game_data.get("current_day_number") != 1:
        logger.info(f"Game {game_id} is no longer in first day state, skipping timeout handling")
        return

    # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –∏ –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–≤—É—é –Ω–æ—á—å
    await start_first_night(game_id, game_data, context)

async def start_first_night(game_id: str, game_data: dict, context: CallbackContext):
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–µ—Ä–≤—É—é –Ω–æ—á—å"""
    logger.info(f"Starting first night for game {game_id}")

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    game_data["state"] = STATE_NIGHT
    game_data["current_night_number"] = 1
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ —ç—Ç–æ–π –∏–≥—Ä—ã
    # –¢–û–õ–¨–ö–û –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –±—ã–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
    if game_data.get("game_mode") == "bot_host":
        users_to_reset = []
        for user_id, math_state in user_math_state.items():
            if math_state.get("game_id") == game_id:
                users_to_reset.append(user_id)
        
        for user_id in users_to_reset:
            del user_math_state[user_id]
            logger.info(f"Reset math state for user {user_id} for first night in game {game_id} (bot-host mode)")
    
    games[game_id] = game_data

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –æ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–≤–æ–π –Ω–æ—á–∏
    await announce_night_start(game_id, game_data, context)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é –Ω–æ—á—å
    await start_night_actions(game_id, game_data, context)

async def announce_night_start(game_id: str, game_data: dict, context: CallbackContext):
    """–û–±—ä—è–≤–ª—è–µ—Ç –æ –Ω–∞—á–∞–ª–µ –Ω–æ—á–∏ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º"""
    night_number = game_data.get("current_night_number", 1)
    night_message = f"üåô –ù–∞—Å—Ç—É–ø–∞–µ—Ç –Ω–æ—á—å #{night_number} –≤ –≥–æ—Ä–æ–¥–µ. –í—Å–µ –∂–∏—Ç–µ–ª–∏ –∑–∞—Å—ã–ø–∞—é—Ç..."

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º
    for slot in game_data["players_slots"]:
        if slot.get("status") == STATUS_ACTIVE and slot.get("user_id"):
            try:
                await context.bot.send_message(
                    slot["user_id"],
                    night_message
                )
            except Exception as e:
                logger.error(f"Error sending night message to player {slot.get('user_id')}: {e}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ö–æ—Å—Ç—É –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–≥—Ä–æ–∫–æ–º –∏ –∏–≥—Ä–∞ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
    host_is_player = any(
        slot.get("status") == STATUS_ACTIVE and slot.get("user_id") == game_data["host_id"]
        for slot in game_data["players_slots"]
    )
    
    # –í —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ –Ω–µ —Å–ø–∞–º–∏–º —Ö–æ—Å—Ç—É, –µ—Å–ª–∏ –æ–Ω –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç
    if not host_is_player and game_data.get("game_mode") != "bot_host":
        await context.bot.send_message(
            game_data["host_id"],
            f"üåô –ù–æ—á—å #{night_number} –Ω–∞—á–∞–ª–∞—Å—å –≤ –∏–≥—Ä–µ {game_id}. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ–¥–µ—Ç –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è."
        )

async def start_night_actions(game_id: str, game_data: dict, context: CallbackContext):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π"""
    logger.info(f"Starting night actions for game {game_id}")

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    game_data = games.get(game_id, game_data)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –Ω–æ—á–∏
    if game_data.get("state") != STATE_NIGHT:
        logger.info(f"Game {game_id} is not in night state, skipping night actions")
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —ç—Ç—É –Ω–æ—á—å
    roles_to_act = get_roles_to_act_in_night(game_data)

    # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
    night_actions = {}

    # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏ –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    for role in roles_to_act:
        role_actions = await perform_role_night_action(role, game_id, game_data, context)
        night_actions[role] = role_actions

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã
    game_data["night_data"] = {
        "actions_taken_by_role": night_actions,
        "roles_to_act": roles_to_act
    }
    games[game_id] = game_data

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏–≥—Ä–æ–∫–∞–º —Å –ø–∞—Å—Å–∏–≤–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏
    # –í —Ä–µ–∂–∏–º–µ "–ë–æ—Ç-–í–µ–¥—É—â–∏–π" (–≤–∫–ª—é—á–∞—è —Ç–∞–π–º–µ—Ä-–∏–≥—Ä—ã)
    game_mode = game_data.get("game_mode", "")
    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ - –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã bot_host
    game_mode_str = str(game_mode)
    if "bot_host" in game_mode_str:  # bot_host, bot_host_timer
        await send_math_problems_to_passive_players(game_id, game_data, context)
        logger.info(f"Math problems sent to passive players in bot-host mode for game {game_id} (mode: {game_mode_str})")
    else:
        logger.info(f"Skipping math problems for game {game_id} - not in bot-host mode (mode: {game_mode_str})")

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç –¥–ª—è –Ω–æ—á–∏ (—Å–æ–∫—Ä–∞—Ç–∏–ª —Å 10 –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–≥—Ä—ã)
    import asyncio
    asyncio.create_task(end_night_after_timeout(game_id, context))

async def perform_role_night_action(role: str, game_id: str, game_data: dict, context: CallbackContext):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–æ—á–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ä–æ–ª–∏ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞"""
    logger.info(f"Performing night action for role {role} in game {game_id}")

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    game_data = games.get(game_id, game_data)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –Ω–æ—á–∏
    if game_data.get("state") != STATE_NIGHT:
        logger.info(f"Game {game_id} is not in night state, skipping night action for role {role}")
        return {}

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ —Å –¥–∞–Ω–Ω–æ–π —Ä–æ–ª—å—é
    role_players = []
    for slot in game_data["players_slots"]:
        if slot.get("status") == STATUS_ACTIVE and slot.get("role") == role:
            role_players.append(slot)

    if not role_players:
        logger.info(f"No players with role {role} found in game {game_id}")
        return {}

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∫–∞–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π
    target_slots = []
    for slot in game_data["players_slots"]:
        if slot.get("status") == STATUS_ACTIVE:
            target_slots.append(slot)

    if not target_slots:
        logger.info(f"No valid targets for role {role} in game {game_id}")
        return {}

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –¥–ª—è –≤—Å–µ—Ö –Ω–æ—á–Ω—ã—Ö —Ä–æ–ª–µ–π
    if role in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –º–∞—Ñ–∏–∏
        night_data = game_data.get("night_data", {})
        if not night_data.get("mafia_selection_sent", False):
            await send_mafia_target_selection(game_id, game_data, context)
            night_data["mafia_selection_sent"] = True
            game_data["night_data"] = night_data
            games[game_id] = game_data
        return {"status": "interactive_selection_sent"}

    elif role == "–î–æ–∫—Ç–æ—Ä":
        await send_doctor_target_selection(game_id, game_data, context)
        return {"status": "interactive_selection_sent"}

    elif role == "–ö–æ–º–∏—Å—Å–∞—Ä":
        await send_commissioner_target_selection(game_id, game_data, context)
        return {"status": "interactive_selection_sent"}

    elif role == "–ú–∞–Ω—å—è–∫":
        await send_maniac_target_selection(game_id, game_data, context)
        return {"status": "interactive_selection_sent"}

    elif role == "–ü—É—Ç–∞–Ω–∞":
        await send_prostitute_target_selection(game_id, game_data, context)
        return {"status": "interactive_selection_sent"}

    logger.info(f"Unknown role {role} in game {game_id}, skipping night action")
    return {}

async def create_night_action_timer(game_id: str, role: str, user_ids: list, context: CallbackContext):
    """–°–æ–∑–¥–∞–µ—Ç —Ç–∞–π–º–µ—Ä –Ω–∞ 3 –º–∏–Ω—É—Ç—ã –¥–ª—è –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∑–∞ –º–∏–Ω—É—Ç—É"""
    import asyncio
    
    # –ñ–¥–µ–º 2 –º–∏–Ω—É—Ç—ã (120 —Å–µ–∫—É–Ω–¥)
    await asyncio.sleep(120)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ –µ—â–µ –∞–∫—Ç–∏–≤–Ω–∞ –∏ –≤ –Ω–æ—á–Ω–æ–π —Ñ–∞–∑–µ
    game_data = games.get(game_id)
    if not game_data or game_data.get("state") != STATE_NIGHT:
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –æ—Å—Ç–∞–µ—Ç—Å—è –º–∏–Ω—É—Ç–∞
    warning_message = (
        f"‚è∞ **–í–Ω–∏–º–∞–Ω–∏–µ!**\n\n"
        f"–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –Ω–æ—á–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Å—Ç–∞–ª–∞—Å—å **1 –º–∏–Ω—É—Ç–∞**!\n"
        f"–ï—Å–ª–∏ –≤—ã –Ω–µ —É—Å–ø–µ–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å –≤—ã–±–æ—Ä, –≤–∞—à —Ö–æ–¥ –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫—Ç–æ –µ—â–µ –Ω–µ —Å—Ö–æ–¥–∏–ª
    night_data = game_data.get("night_data", {})
    actions_taken = night_data.get("actions_taken_by_role", {})
    
    # –ï—Å–ª–∏ —Ä–æ–ª—å –µ—â–µ –Ω–µ —Å—Ö–æ–¥–∏–ª–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    if role not in actions_taken:
        for user_id in user_ids:
            try:
                await context.bot.send_message(
                    user_id,
                    warning_message,
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as e:
                logger.error(f"Error sending night timer warning to user {user_id}: {e}")
    
    # –ñ–¥–µ–º –µ—â–µ –º–∏–Ω—É—Ç—É (60 —Å–µ–∫—É–Ω–¥)
    await asyncio.sleep(60)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    game_data = games.get(game_id)
    if not game_data or game_data.get("state") != STATE_NIGHT:
        return
    
    # –ï—Å–ª–∏ —Ä–æ–ª—å –≤—Å–µ –µ—â–µ –Ω–µ —Å—Ö–æ–¥–∏–ª–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    night_data = game_data.get("night_data", {})
    actions_taken = night_data.get("actions_taken_by_role", {})
    
    if role not in actions_taken:
        timeout_message = (
            f"‚è±Ô∏è **–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ!**\n\n"
            f"–í–∞—à —Ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—â–µ–Ω –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏."
        )
        
        for user_id in user_ids:
            try:
                await context.bot.send_message(
                    user_id,
                    timeout_message,
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as e:
                logger.error(f"Error sending night timeout message to user {user_id}: {e}")
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ö–æ–¥ –¥–ª—è —ç—Ç–æ–π —Ä–æ–ª–∏
        await auto_skip_night_action(game_id, role, context)

async def auto_skip_night_action(game_id: str, role: str, context: CallbackContext):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –Ω–æ—á–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —Ä–æ–ª–∏ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏"""
    game_data = games.get(game_id)
    if not game_data:
        return
    
    # –î–ª—è –º–∞—Ñ–∏–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –ª–∏ —É–∂–µ —Ü–µ–ª—å
    if role == "–ú–∞—Ñ–∏—è":
        mafia_target_chosen = False
        for slot in game_data["players_slots"]:
            if slot.get("targeted_by_mafia"):
                mafia_target_chosen = True
                break
        
        if mafia_target_chosen:
            logger.info(f"Mafia already chose target in game {game_id}, not auto-skipping")
            return  # –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —Ü–µ–ª—å —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞
    
    night_data = game_data.get("night_data", {})
    actions_taken = night_data.get("actions_taken_by_role", {})
    
    # –ü–æ–º–µ—á–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ (–ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–µ)
    actions_taken[role] = "skipped"
    night_data["actions_taken_by_role"] = actions_taken
    game_data["night_data"] = night_data
    games[game_id] = game_data
    
    logger.info(f"Auto-skipped night action for role {role} in game {game_id} due to timeout")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await check_all_night_actions_completed(game_id, context)

async def send_mafia_target_selection(game_id: str, game_data: dict, context: CallbackContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–∞—Ñ–∏–∏ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∂–µ—Ä—Ç–≤—ã"""
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –º–∞—Ñ–∏–∏
    mafia_players = []
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"] and
            slot.get("user_id")):
            mafia_players.append(slot)

    if not mafia_players:
        logger.error(f"No mafia players found in game {game_id}")
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∂–µ—Ä—Ç–≤ (–≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä–æ–∫–∏ –∫—Ä–æ–º–µ –º–∞—Ñ–∏–∏)
    potential_targets = []
    for i, slot in enumerate(game_data["players_slots"]):
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") not in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]):
            potential_targets.append((i, slot))

    if not potential_targets:
        logger.error(f"No potential targets for mafia in game {game_id}")
        return

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤—ã–±–æ—Ä–æ–º –∂–µ—Ä—Ç–≤—ã
    keyboard = []
    for target_index, target_slot in potential_targets:
        display_name = get_player_display_name(target_slot, context)
        keyboard.append([InlineKeyboardButton(
            f"üî™ {display_name}", 
            callback_data=f"mafia_target_{game_id}_{target_index}"
        )])

    reply_markup = InlineKeyboardMarkup(keyboard)

    message_text = (
        f"üåô **–ù–æ—á—å {game_data.get('current_night_number', 1)}**\n\n"
        f"üî™ **–ú–∞—Ñ–∏—è, –≤—ã–±–µ—Ä–∏—Ç–µ –∂–µ—Ä—Ç–≤—É:**\n\n"
        f"üí¨ **–ß–ê–¢ –ú–ê–§–ò–ò –ê–ö–¢–ò–í–ï–ù!** –ú–æ–∂–µ—Ç–µ –æ–±—Å—É–¥–∏—Ç—å –≤—ã–±–æ—Ä —Å —Å–æ—é–∑–Ω–∏–∫–∞–º–∏.\n"
        f"–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É - –æ–Ω–æ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –º–∞—Ñ–∏–∏.\n\n"
        f"‚è±Ô∏è **–£ –≤–∞—Å –µ—Å—Ç—å 3 –º–∏–Ω—É—Ç—ã –Ω–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è.**\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å —ç—Ç–æ–π –Ω–æ—á—å—é."
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –º–∞—Ñ–∏–∏
    for mafia_slot in mafia_players:
        try:
            await context.bot.send_message(
                mafia_slot["user_id"],
                message_text,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=reply_markup
            )
            logger.info(f"Mafia target selection sent to user {mafia_slot['user_id']} in game {game_id}")
        except Exception as e:
            logger.error(f"Error sending mafia target selection to user {mafia_slot['user_id']}: {e}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –º–∞—Ñ–∏–∏
    import asyncio
    mafia_user_ids = [slot["user_id"] for slot in mafia_players]
    asyncio.create_task(create_night_action_timer(game_id, "–ú–∞—Ñ–∏—è", mafia_user_ids, context))

async def send_doctor_target_selection(game_id: str, game_data: dict, context: CallbackContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ–∫—Ç–æ—Ä—É –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–≥–æ –ª–µ—á–∏—Ç—å"""
    # –ü–æ–ª—É—á–∞–µ–º –¥–æ–∫—Ç–æ—Ä–∞
    doctor_players = []
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") == "–î–æ–∫—Ç–æ—Ä" and
            slot.get("user_id")):
            doctor_players.append(slot)

    if not doctor_players:
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∫–∞–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
    potential_targets = []
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("status") == STATUS_ACTIVE:
            potential_targets.append((i, slot))

    if not potential_targets:
        return

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤—ã–±–æ—Ä–æ–º –ø–∞—Ü–∏–µ–Ω—Ç–∞
    keyboard = []
    for target_index, target_slot in potential_targets:
        display_name = get_player_display_name(target_slot, context)
        keyboard.append([InlineKeyboardButton(
            f"üè• {display_name}", 
            callback_data=f"doctor_target_{game_id}_{target_index}"
        )])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥"
    keyboard.append([InlineKeyboardButton(
        "‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥", 
        callback_data=f"doctor_skip_{game_id}"
    )])

    reply_markup = InlineKeyboardMarkup(keyboard)

    message_text = (
        f"üåô **–ù–æ—á—å {game_data.get('current_night_number', 1)}**\n\n"
        f"üè• **–î–æ–∫—Ç–æ—Ä, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–≥–æ –ª–µ—á–∏—Ç—å:**\n\n"
        f"‚è±Ô∏è **–£ –≤–∞—Å –µ—Å—Ç—å 3 –º–∏–Ω—É—Ç—ã –Ω–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è.**\n\n"
        f"–í—ã –º–æ–∂–µ—Ç–µ —Å–ø–∞—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –æ—Ç —Å–º–µ—Ä—Ç–∏ —ç—Ç–æ–π –Ω–æ—á—å—é.\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ –º—É–¥—Ä–æ - –≤–∞—à –≤—ã–±–æ—Ä –º–æ–∂–µ—Ç —Ä–µ—à–∏—Ç—å –∏—Å—Ö–æ–¥ –∏–≥—Ä—ã!"
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–∫—Ç–æ—Ä—É
    for doctor_slot in doctor_players:
        try:
            await context.bot.send_message(
                doctor_slot["user_id"],
                message_text,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=reply_markup
            )
            logger.info(f"Doctor target selection sent to user {doctor_slot['user_id']} in game {game_id}")
        except Exception as e:
            logger.error(f"Error sending doctor target selection to user {doctor_slot['user_id']}: {e}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –¥–æ–∫—Ç–æ—Ä–∞
    import asyncio
    doctor_user_ids = [slot["user_id"] for slot in doctor_players]
    asyncio.create_task(create_night_action_timer(game_id, "–î–æ–∫—Ç–æ—Ä", doctor_user_ids, context))

async def send_commissioner_target_selection(game_id: str, game_data: dict, context: CallbackContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∏—Å—Å–∞—Ä—É –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å"""
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∏—Å—Å–∞—Ä–∞
    commissioner_players = []
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") == "–ö–æ–º–∏—Å—Å–∞—Ä" and
            slot.get("user_id")):
            commissioner_players.append(slot)

    if not commissioner_players:
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∫—Ä–æ–º–µ –∫–æ–º–∏—Å—Å–∞—Ä–∞
    potential_targets = []
    for i, slot in enumerate(game_data["players_slots"]):
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") != "–ö–æ–º–∏—Å—Å–∞—Ä"):
            potential_targets.append((i, slot))

    if not potential_targets:
        return

    keyboard = []
    for target_index, target_slot in potential_targets:
        display_name = get_player_display_name(target_slot, context)
        keyboard.append([InlineKeyboardButton(
            f"üîç {display_name}", 
            callback_data=f"commissioner_target_{game_id}_{target_index}"
        )])

    reply_markup = InlineKeyboardMarkup(keyboard)

    message_text = (
        f"üåô **–ù–æ—á—å {game_data.get('current_night_number', 1)}**\n\n"
        f"üîç **–ö–æ–º–∏—Å—Å–∞—Ä, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**\n\n"
        f"‚è±Ô∏è **–£ –≤–∞—Å –µ—Å—Ç—å 3 –º–∏–Ω—É—Ç—ã –Ω–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è.**\n\n"
        f"–í—ã –º–æ–∂–µ—Ç–µ —É–∑–Ω–∞—Ç—å —Ä–æ–ª—å –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.\n"
        f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º—É–¥—Ä–æ –≤ –¥–Ω–µ–≤–Ω–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏!"
    )

    for commissioner_slot in commissioner_players:
        try:
            await context.bot.send_message(
                commissioner_slot["user_id"],
                message_text,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=reply_markup
            )
            logger.info(f"Commissioner target selection sent to user {commissioner_slot['user_id']} in game {game_id}")
        except Exception as e:
            logger.error(f"Error sending commissioner target selection to user {commissioner_slot['user_id']}: {e}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –∫–æ–º–∏—Å—Å–∞—Ä–∞
    # –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞–π–º–µ—Ä –¥–ª—è –∫–æ–º–∏—Å—Å–∞—Ä–∞ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
    # –ö–æ–º–∏—Å—Å–∞—Ä—É –¥–∞–µ—Ç—Å—è 3 –º–∏–Ω—É—Ç—ã –Ω–∞ –≤—ã–±–æ—Ä —Ü–µ–ª–∏

async def send_maniac_target_selection(game_id: str, game_data: dict, context: CallbackContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–∞–Ω—å—è–∫—É –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∂–µ—Ä—Ç–≤—ã"""
    # –ü–æ–ª—É—á–∞–µ–º –º–∞–Ω—å—è–∫–∞
    maniac_players = []
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") == "–ú–∞–Ω—å—è–∫" and
            slot.get("user_id")):
            maniac_players.append(slot)

    if not maniac_players:
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∫—Ä–æ–º–µ –º–∞–Ω—å—è–∫–∞
    potential_targets = []
    for i, slot in enumerate(game_data["players_slots"]):
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") != "–ú–∞–Ω—å—è–∫"):
            potential_targets.append((i, slot))

    if not potential_targets:
        return

    keyboard = []
    for target_index, target_slot in potential_targets:
        display_name = get_player_display_name(target_slot, context)
        keyboard.append([InlineKeyboardButton(
            f"üíÄ {display_name}", 
            callback_data=f"maniac_target_{game_id}_{target_index}"
        )])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥"
    keyboard.append([InlineKeyboardButton(
        "‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥", 
        callback_data=f"maniac_skip_{game_id}"
    )])

    reply_markup = InlineKeyboardMarkup(keyboard)

    message_text = (
        f"üåô **–ù–æ—á—å {game_data.get('current_night_number', 1)}**\n\n"
        f"üíÄ **–ú–∞–Ω—å—è–∫, –≤—ã–±–µ—Ä–∏—Ç–µ –∂–µ—Ä—Ç–≤—É:**\n\n"
        f"–ñ–∞–∂–¥–∞ –∫—Ä–æ–≤–∏ –∑–æ–≤–µ—Ç... –ö–æ–≥–æ –≤—ã –≤—ã–±–µ—Ä–µ—Ç–µ —ç—Ç–æ–π –Ω–æ—á—å—é?\n"
        f"–í–∞—à–∞ —Ü–µ–ª—å –±—É–¥–µ—Ç —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –º–∞—Ñ–∏–∏."
    )

    for maniac_slot in maniac_players:
        try:
            await context.bot.send_message(
                maniac_slot["user_id"],
                message_text,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=reply_markup
            )
            logger.info(f"Maniac target selection sent to user {maniac_slot['user_id']} in game {game_id}")
        except Exception as e:
            logger.error(f"Error sending maniac target selection to user {maniac_slot['user_id']}: {e}")

async def send_prostitute_target_selection(game_id: str, game_data: dict, context: CallbackContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É—Ç–∞–Ω–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–≥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å"""
    # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç–∞–Ω—É
    prostitute_players = []
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") == "–ü—É—Ç–∞–Ω–∞" and
            slot.get("user_id")):
            prostitute_players.append(slot)

    if not prostitute_players:
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∫—Ä–æ–º–µ –ø—É—Ç–∞–Ω—ã
    potential_targets = []
    for i, slot in enumerate(game_data["players_slots"]):
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") != "–ü—É—Ç–∞–Ω–∞"):
            potential_targets.append((i, slot))

    if not potential_targets:
        return

    keyboard = []
    for target_index, target_slot in potential_targets:
        display_name = get_player_display_name(target_slot, context)
        keyboard.append([InlineKeyboardButton(
            f"üö´ {display_name}", 
            callback_data=f"prostitute_target_{game_id}_{target_index}"
        )])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥"
    keyboard.append([InlineKeyboardButton(
        "‚ùå –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ö–æ–¥", 
        callback_data=f"prostitute_skip_{game_id}"
    )])

    reply_markup = InlineKeyboardMarkup(keyboard)

    message_text = (
        f"üåô **–ù–æ—á—å {game_data.get('current_night_number', 1)}**\n\n"
        f"üö´ **–ü—É—Ç–∞–Ω–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–≥–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å:**\n\n"
        f"–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–º–µ—à–∞—Ç—å –æ–¥–Ω–æ–º—É –∏–≥—Ä–æ–∫—É –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–æ—á–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.\n"
        f"–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å —É–≥—Ä–æ–∑—É!"
    )

    for prostitute_slot in prostitute_players:
        try:
            await context.bot.send_message(
                prostitute_slot["user_id"],
                message_text,
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=reply_markup
            )
            logger.info(f"Prostitute target selection sent to user {prostitute_slot['user_id']} in game {game_id}")
        except Exception as e:
            logger.error(f"Error sending prostitute target selection to user {prostitute_slot['user_id']}: {e}")

async def handle_mafia_target_selection(query, context: CallbackContext, game_id: str, target_index: int):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –∂–µ—Ä—Ç–≤—ã –º–∞—Ñ–∏–µ–π"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    if game_data.get("state") != STATE_NIGHT:
        await query.answer("‚ùå –°–µ–π—á–∞—Å –Ω–µ –Ω–æ—á—å", show_alert=True)
        return

    voter_id = query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–æ–ª–æ—Å—É—é—â–∏–π - –º–∞—Ñ–∏—è
    is_mafia = False
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == voter_id and 
            slot.get("status") == STATUS_ACTIVE and
            slot.get("role") in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]):
            is_mafia = True
            break

    if not is_mafia:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ –º–∞—Ñ–∏—è –º–æ–∂–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å –∂–µ—Ä—Ç–≤—É", show_alert=True)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∞–∫—Ç–∏–≤–Ω–∞
    if target_index >= len(game_data["players_slots"]):
        await query.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∏–≥—Ä–æ–∫", show_alert=True)
        return

    target_slot = game_data["players_slots"][target_index]
    if target_slot.get("status") != STATUS_ACTIVE:
        await query.answer("‚ùå –≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω", show_alert=True)
        return

    if target_slot.get("role") in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]:
        await query.answer("‚ùå –ú–∞—Ñ–∏—è –Ω–µ –º–æ–∂–µ—Ç —É–±–∏—Ç—å –º–∞—Ñ–∏—é", show_alert=True)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –≤—ã–±–æ—Ä–∞ –º–∞—Ñ–∏–µ–π
    if "mafia_votes" not in game_data:
        game_data["mafia_votes"] = {}

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≥–æ–ª–æ—Å –º–∞—Ñ–∏–∏
    game_data["mafia_votes"][voter_id] = target_index
    games[game_id] = game_data

    target_name = get_player_display_name(target_slot, context)
    
    # –ù–∞—Ö–æ–¥–∏–º –∏–º—è –≥–æ–ª–æ—Å—É—é—â–µ–≥–æ –º–∞—Ñ–∏–æ–∑–∏
    voter_name = "–ß–ª–µ–Ω –º–∞—Ñ–∏–∏"
    for slot in game_data["players_slots"]:
        if slot.get("user_id") == voter_id:
            voter_name = get_player_display_name(slot, context)
            break
    
    await query.edit_message_text(
        f"‚úÖ **–¶–µ–ª—å –≤—ã–±—Ä–∞–Ω–∞**\n\n"
        f"üî™ –í—ã –≤—ã–±—Ä–∞–ª–∏: **{target_name}**\n\n"
        f"–û–∂–∏–¥–∞–µ–º –≤—ã–±–æ—Ä–∞ –¥—Ä—É–≥–∏—Ö —á–ª–µ–Ω–æ–≤ –º–∞—Ñ–∏–∏ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ—á–∏...",
        parse_mode=ParseMode.MARKDOWN
    )

    logger.info(f"Mafia member {voter_id} chose target {target_index} ({target_name}) in game {game_id}")

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –û–°–¢–ê–õ–¨–ù–´–• —á–ª–µ–Ω–æ–≤ –º–∞—Ñ–∏–∏ –æ –≤—ã–±–æ—Ä–µ —Ç–æ–≤–∞—Ä–∏—â–∞
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"] and
            slot.get("user_id") and slot.get("user_id") != voter_id):
            try:
                await context.bot.send_message(
                    slot["user_id"],
                    f"üë• **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç –∫–æ–º–∞–Ω–¥—ã –º–∞—Ñ–∏–∏**\n\n"
                    f"üó≥Ô∏è **{voter_name}** –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞: **{target_name}**\n\n"
                    f"üí≠ –û–±—Å—É–¥–∏—Ç–µ –≤—ã–±–æ—Ä –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Å–≤–æ–π –≥–æ–ª–æ—Å!",
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as e:
                logger.error(f"Error notifying other mafia member {slot['user_id']}: {e}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —á–ª–µ–Ω—ã –º–∞—Ñ–∏–∏ —Å–¥–µ–ª–∞–ª–∏ –≤—ã–±–æ—Ä
    mafia_count = len([slot for slot in game_data["players_slots"] 
                      if slot.get("status") == STATUS_ACTIVE and 
                         slot.get("role") in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]])
    
    votes_count = len(game_data["mafia_votes"])
    
    if votes_count >= mafia_count:
        # –í—Å–µ –º–∞—Ñ–∏—è –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∞, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—É—é —Ü–µ–ª—å
        await finalize_mafia_target(game_id, game_data, context)

async def handle_doctor_target_selection(query, context: CallbackContext, game_id: str, target_index: int):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–∞—Ü–∏–µ–Ω—Ç–∞ –¥–æ–∫—Ç–æ—Ä–æ–º —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    user_id = query.from_user.id
    doctor_slot = None
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == user_id and 
            slot.get("role") == "–î–æ–∫—Ç–æ—Ä" and 
            slot.get("status") == STATUS_ACTIVE):
            doctor_slot = slot
            break

    if not doctor_slot:
        await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –≤—ã–±–∏—Ä–∞—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞", show_alert=True)
        return

    if target_index < 0 or target_index >= len(game_data["players_slots"]):
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–ª—å", show_alert=True)
        return

    target_slot = game_data["players_slots"][target_index]
    if target_slot.get("status") != STATUS_ACTIVE:
        await query.answer("–≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ —É–∂–µ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∏–≥—Ä–µ", show_alert=True)
        return

    patient_name = get_player_display_name(target_slot, context)
    
    # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    confirmation_keyboard = [
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–µ—á–µ–Ω–∏–µ", callback_data=f"confirm_doctor_{game_id}_{target_index}")],
        [InlineKeyboardButton("üîô –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ", callback_data=f"return_doctor_{game_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(confirmation_keyboard)
    
    confirmation_message = (
        f"üè• **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ª–µ—á–µ–Ω–∏—è**\n\n"
        f"üéØ –í—ã –≤—ã–±—Ä–∞–ª–∏: **{patient_name}**\n\n"
        f"‚ùì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–≤–æ–π –≤—ã–±–æ—Ä?\n"
        f"‚ö†Ô∏è –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ –±—É–¥–µ—Ç –Ω–µ–ª—å–∑—è."
    )
    
    try:
        await query.edit_message_text(
            confirmation_message,
            reply_markup=reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error showing doctor confirmation: {e}")

async def handle_confirm_doctor(query, context: CallbackContext, game_id: str, target_index: int):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–µ –ª–µ—á–µ–Ω–∏–µ –¥–æ–∫—Ç–æ—Ä–∞"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    user_id = query.from_user.id
    doctor_slot = None
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == user_id and 
            slot.get("role") == "–î–æ–∫—Ç–æ—Ä" and 
            slot.get("status") == STATUS_ACTIVE):
            doctor_slot = slot
            break

    if not doctor_slot:
        await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –ª–µ—á–∏—Ç—å", show_alert=True)
        return

    target_slot = game_data["players_slots"][target_index]
    target_slot["saved_by_doctor"] = True
    patient_name = get_player_display_name(target_slot, context)
    
    # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –¥–æ–∫—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ
    doctor_slot["doctor_action_complete"] = True
    
    logger.info(f"Doctor {user_id} selected {patient_name} to heal in game {game_id}")

    try:
        await query.edit_message_text(
            f"üè• **–í–∞—à –≤—ã–±–æ—Ä –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω**\n\n"
            f"–í—ã –∑–∞—â–∏—Ç–∏–ª–∏: **{patient_name}**\n"
            f"–≠—Ç–æ–π –Ω–æ—á—å—é –≤–∞—à –ø–∞—Ü–∏–µ–Ω—Ç –±—É–¥–µ—Ç –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating doctor message: {e}")

    games[game_id] = game_data
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await check_all_night_actions_completed(game_id, context)

async def handle_return_doctor(query, context: CallbackContext, game_id: str):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–∫—Ç–æ—Ä–∞ –∫ –≤—ã–±–æ—Ä—É –ø–∞—Ü–∏–µ–Ω—Ç–∞"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–Ω–æ–≤–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—ã–±–æ—Ä–∞
    await send_doctor_target_selection(game_id, game_data, context)
    await query.answer("–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∑–∞–Ω–æ–≤–æ")

async def handle_commissioner_target_selection(query, context: CallbackContext, game_id: str, target_index: int):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ü–µ–ª–∏ –∫–æ–º–∏—Å—Å–∞—Ä–æ–º"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    user_id = query.from_user.id
    commissioner_slot = None
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == user_id and 
            slot.get("role") == "–ö–æ–º–∏—Å—Å–∞—Ä" and 
            slot.get("status") == STATUS_ACTIVE):
            commissioner_slot = slot
            break

    if not commissioner_slot:
        await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É", show_alert=True)
        return

    if target_index < 0 or target_index >= len(game_data["players_slots"]):
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–ª—å", show_alert=True)
        return

    target_slot = game_data["players_slots"][target_index]
    if target_slot.get("status") != STATUS_ACTIVE:
        await query.answer("–≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ —É–∂–µ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∏–≥—Ä–µ", show_alert=True)
        return

    target_name = get_player_display_name(target_slot, context)
    target_role = target_slot["role"]
    is_mafia = target_role in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]
    
    result_text = "**–ú–ê–§–ò–Ø**" if is_mafia else "**–ù–ï –ú–ê–§–ò–Ø**"
    
    logger.info(f"Commissioner {user_id} checked {target_name} ({target_role}) in game {game_id}, result: {result_text}")

    await query.answer(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏: {target_name} - {result_text}")
    
    try:
        await query.edit_message_text(
            f"üîç **–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏**\n\n"
            f"–ü—Ä–æ–≤–µ—Ä–µ–Ω: **{target_name}**\n"
            f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {result_text}\n\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º—É–¥—Ä–æ –≤ –¥–Ω–µ–≤–Ω–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏!",
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating commissioner message: {e}")
    
    # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –∫–æ–º–∏—Å—Å–∞—Ä –∑–∞–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ
    commissioner_slot["commissioner_action_complete"] = True
    games[game_id] = game_data
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await check_all_night_actions_completed(game_id, context)

async def handle_maniac_target_selection(query, context: CallbackContext, game_id: str, target_index: int):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –∂–µ—Ä—Ç–≤—ã –º–∞–Ω—å—è–∫–æ–º"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    user_id = query.from_user.id
    maniac_slot = None
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == user_id and 
            slot.get("role") == "–ú–∞–Ω—å—è–∫" and 
            slot.get("status") == STATUS_ACTIVE):
            maniac_slot = slot
            break

    if not maniac_slot:
        await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ —É–±–∏–≤–∞—Ç—å", show_alert=True)
        return

    if target_index < 0 or target_index >= len(game_data["players_slots"]):
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–ª—å", show_alert=True)
        return

    target_slot = game_data["players_slots"][target_index]
    if target_slot.get("status") != STATUS_ACTIVE:
        await query.answer("–≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ —É–∂–µ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∏–≥—Ä–µ", show_alert=True)
        return

    target_slot["targeted_by_maniac"] = True
    victim_name = get_player_display_name(target_slot, context)
    
    # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –º–∞–Ω—å—è–∫ –∑–∞–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ
    maniac_slot["maniac_action_complete"] = True
    
    logger.info(f"Maniac {user_id} targeted {victim_name} in game {game_id}")

    await query.answer(f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏ –∂–µ—Ä—Ç–≤—É: {victim_name}")
    
    try:
        await query.edit_message_text(
            f"üíÄ **–ñ–µ—Ä—Ç–≤–∞ –≤—ã–±—Ä–∞–Ω–∞**\n\n"
            f"–¶–µ–ª—å: **{victim_name}**\n"
            f"–ñ–∞–∂–¥–∞ –∫—Ä–æ–≤–∏ –±—É–¥–µ—Ç —É—Ç–æ–ª–µ–Ω–∞ —ç—Ç–æ–π –Ω–æ—á—å—é...",
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating maniac message: {e}")

    games[game_id] = game_data
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await check_all_night_actions_completed(game_id, context)

async def handle_prostitute_target_selection(query, context: CallbackContext, game_id: str, target_index: int):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ü–µ–ª–∏ –ø—É—Ç–∞–Ω–æ–π"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    user_id = query.from_user.id
    prostitute_slot = None
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == user_id and 
            slot.get("role") == "–ü—É—Ç–∞–Ω–∞" and 
            slot.get("status") == STATUS_ACTIVE):
            prostitute_slot = slot
            break

    if not prostitute_slot:
        await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", show_alert=True)
        return

    if target_index < 0 or target_index >= len(game_data["players_slots"]):
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–ª—å", show_alert=True)
        return

    target_slot = game_data["players_slots"][target_index]
    if target_slot.get("status") != STATUS_ACTIVE:
        await query.answer("–≠—Ç–æ—Ç –∏–≥—Ä–æ–∫ —É–∂–µ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∏–≥—Ä–µ", show_alert=True)
        return

    target_slot["blocked_by_prostitute"] = True
    blocked_name = get_player_display_name(target_slot, context)
    
    # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –ø—É—Ç–∞–Ω–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞ –¥–µ–π—Å—Ç–≤–∏–µ
    prostitute_slot["prostitute_action_complete"] = True
    
    logger.info(f"Prostitute {user_id} blocked {blocked_name} in game {game_id}")

    await query.answer(f"‚úÖ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏: {blocked_name}")
    
    try:
        await query.edit_message_text(
            f"üö´ **–¶–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞**\n\n"
            f"–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: **{blocked_name}**\n"
            f"–û–Ω–∏ –Ω–µ —Å–º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–æ—á–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.",
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating prostitute message: {e}")

    games[game_id] = game_data
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await check_all_night_actions_completed(game_id, context)

async def handle_doctor_skip(query, context: CallbackContext, game_id: str):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–ø—É—Å–∫ —Ö–æ–¥–∞ –¥–æ–∫—Ç–æ—Ä–∞"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    user_id = query.from_user.id
    doctor_slot = None
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == user_id and 
            slot.get("role") == "–î–æ–∫—Ç–æ—Ä" and 
            slot.get("status") == STATUS_ACTIVE):
            doctor_slot = slot
            break

    if not doctor_slot:
        await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Ö–æ–¥ –¥–æ–∫—Ç–æ—Ä–∞", show_alert=True)
        return

    # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –¥–æ–∫—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ (–ø—Ä–æ–ø—É—Å—Ç–∏–ª —Ö–æ–¥)
    doctor_slot["doctor_action_complete"] = True
    
    logger.info(f"Doctor {user_id} skipped turn in game {game_id}")

    await query.answer("‚úÖ –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ —Ö–æ–¥")
    
    try:
        await query.edit_message_text(
            f"üè• **–•–æ–¥ –ø—Ä–æ–ø—É—â–µ–Ω**\n\n"
            f"–í—ã —Ä–µ—à–∏–ª–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ –ª–µ—á–∏—Ç—å —ç—Ç–æ–π –Ω–æ—á—å—é.\n"
            f"–ù–∞–¥–µ–µ–º—Å—è, —ç—Ç–æ –±—ã–ª–æ –º—É–¥—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ...",
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating doctor skip message: {e}")

    games[game_id] = game_data
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await check_all_night_actions_completed(game_id, context)

async def handle_maniac_skip(query, context: CallbackContext, game_id: str):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–ø—É—Å–∫ —Ö–æ–¥–∞ –º–∞–Ω—å—è–∫–∞"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    user_id = query.from_user.id
    maniac_slot = None
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == user_id and 
            slot.get("role") == "–ú–∞–Ω—å—è–∫" and 
            slot.get("status") == STATUS_ACTIVE):
            maniac_slot = slot
            break

    if not maniac_slot:
        await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Ö–æ–¥ –º–∞–Ω—å—è–∫–∞", show_alert=True)
        return

    # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –º–∞–Ω—å—è–∫ –∑–∞–≤–µ—Ä—à–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ (–ø—Ä–æ–ø—É—Å—Ç–∏–ª —Ö–æ–¥)
    maniac_slot["maniac_action_complete"] = True
    
    logger.info(f"Maniac {user_id} skipped turn in game {game_id}")

    await query.answer("‚úÖ –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ —Ö–æ–¥")
    
    try:
        await query.edit_message_text(
            f"üíÄ **–•–æ–¥ –ø—Ä–æ–ø—É—â–µ–Ω**\n\n"
            f"–ñ–∞–∂–¥–∞ –∫—Ä–æ–≤–∏ –æ—Ç—Å—Ç—É–ø–∏–ª–∞... –ù–∞ —ç—Ç–æ—Ç —Ä–∞–∑.\n"
            f"–í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –±—ã–ª–æ —Ä–∞–∑—É–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.",
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating maniac skip message: {e}")

    games[game_id] = game_data
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await check_all_night_actions_completed(game_id, context)

async def handle_prostitute_skip(query, context: CallbackContext, game_id: str):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–ø—É—Å–∫ —Ö–æ–¥–∞ –ø—É—Ç–∞–Ω—ã"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    user_id = query.from_user.id
    prostitute_slot = None
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == user_id and 
            slot.get("role") == "–ü—É—Ç–∞–Ω–∞" and 
            slot.get("status") == STATUS_ACTIVE):
            prostitute_slot = slot
            break

    if not prostitute_slot:
        await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —Ö–æ–¥ –ø—É—Ç–∞–Ω—ã", show_alert=True)
        return

    # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –ø—É—Ç–∞–Ω–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞ –¥–µ–π—Å—Ç–≤–∏–µ (–ø—Ä–æ–ø—É—Å—Ç–∏–ª–∞ —Ö–æ–¥)
    prostitute_slot["prostitute_action_complete"] = True
    
    logger.info(f"Prostitute {user_id} skipped turn in game {game_id}")

    await query.answer("‚úÖ –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ —Ö–æ–¥")
    
    try:
        await query.edit_message_text(
            f"üö´ **–•–æ–¥ –ø—Ä–æ–ø—É—â–µ–Ω**\n\n"
            f"–í—ã —Ä–µ—à–∏–ª–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–π –Ω–æ—á—å—é.\n"
            f"–í—Å–µ –∏–≥—Ä–æ–∫–∏ —Å–º–æ–≥—É—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ.",
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating prostitute skip message: {e}")

    games[game_id] = game_data
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await check_all_night_actions_completed(game_id, context)

async def finalize_mafia_target(game_id: str, game_data: dict, context: CallbackContext):
    """–§–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—ã–±–æ—Ä —Ü–µ–ª–∏ –º–∞—Ñ–∏–∏"""
    mafia_votes = game_data.get("mafia_votes", {})
    
    if not mafia_votes:
        logger.info(f"No mafia votes in game {game_id}, skipping mafia action")
        return

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≥–æ–ª–æ—Å–∞
    vote_counts = {}
    for voter_id, target_index in mafia_votes.items():
        vote_counts[target_index] = vote_counts.get(target_index, 0) + 1

    # –ù–∞—Ö–æ–¥–∏–º —Ü–µ–ª—å —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≥–æ–ª–æ—Å–æ–≤
    final_target_index = max(vote_counts.keys(), key=lambda x: vote_counts[x])
    final_target_slot = game_data["players_slots"][final_target_index]

    # –ü–æ–º–µ—á–∞–µ–º —Ü–µ–ª—å –∫–∞–∫ –∞—Ç–∞–∫–æ–≤–∞–Ω–Ω—É—é –º–∞—Ñ–∏–µ–π
    final_target_slot["targeted_by_mafia"] = True
    
    # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –º–∞—Ñ–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞ –¥–µ–π—Å—Ç–≤–∏–µ –≤ night_data
    if "night_data" not in game_data:
        game_data["night_data"] = {}
    if "actions_taken_by_role" not in game_data["night_data"]:
        game_data["night_data"]["actions_taken_by_role"] = {}
    
    game_data["night_data"]["actions_taken_by_role"]["–ú–∞—Ñ–∏—è"] = "completed"
    
    # –û—á–∏—â–∞–µ–º –≥–æ–ª–æ—Å–∞ –º–∞—Ñ–∏–∏
    game_data["mafia_votes"] = {}
    games[game_id] = game_data

    logger.info(f"Mafia finalized target: {final_target_slot['fictional_name']} in game {game_id}")

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö —á–ª–µ–Ω–æ–≤ –º–∞—Ñ–∏–∏ –æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Ä–µ—à–µ–Ω–∏–∏
    target_name = get_player_display_name(final_target_slot, context)
    for slot in game_data["players_slots"]:
        if (slot.get("status") == STATUS_ACTIVE and 
            slot.get("role") in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"] and
            slot.get("user_id")):
            try:
                await context.bot.send_message(
                    slot["user_id"],
                    f"üéØ **–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ**\n\n"
                    f"–¶–µ–ª—å —ç—Ç–æ–π –Ω–æ—á–∏: **{target_name}**\n\n"
                    f"üåô –û–∂–∏–¥–∞–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ—á–∏...",
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as e:
                logger.error(f"Error notifying mafia member {slot['user_id']}: {e}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await check_all_night_actions_completed(game_id, context)

def get_roles_to_act_in_night(game_data: dict):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —ç—Ç—É –Ω–æ—á—å"""
    roles_to_act = []
    for slot in game_data["players_slots"]:
        if slot.get("status") == STATUS_ACTIVE and slot.get("role") in NIGHT_ROLES:
            if slot["role"] not in roles_to_act:  # –ò–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                roles_to_act.append(slot["role"])
    return roles_to_act

async def end_night_after_timeout(game_id: str, context: CallbackContext):
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –Ω–æ—á—å –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞"""
    # –ñ–¥–µ–º 5 –º–∏–Ω—É—Ç
    try:
        await asyncio.sleep(300)  # 5 –º–∏–Ω—É—Ç = 300 —Å–µ–∫—É–Ω–¥
    except Exception as e:
        logger.error(f"Error during sleep in end_night_after_timeout: {e}")
        return

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    game_data = games.get(game_id)
    if not game_data:
        logger.error(f"Game {game_id} not found when ending night")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–∞ –≤—Å–µ –µ—â–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –Ω–æ—á–∏
    if game_data.get("state") != STATE_NIGHT:
        logger.info(f"Game {game_id} is no longer in night state, skipping timeout handling")
        return

    # –ó–∞–≤–µ—Ä—à–∞–µ–º –Ω–æ—á—å –∏ –Ω–∞—á–∏–Ω–∞–µ–º –¥–µ–Ω—å
    await start_day_after_night(game_id, game_data, context)

async def start_day_after_night(game_id: str, game_data: dict, context: CallbackContext):
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –Ω–æ—á—å –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–µ–Ω—å"""
    logger.info(f"Starting day after night for game {game_id}")

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    game_data["state"] = STATE_DAY
    game_data["current_day_number"] += 1

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–æ—á–∏
    eliminated_players = []
    saved_players = []

    for slot in game_data["players_slots"]:
        if slot.get("targeted_by_mafia") and not slot.get("saved_by_doctor"):
            slot["status"] = STATUS_ELIMINATED
            eliminated_players.append(get_player_display_name(slot, context))
        elif slot.get("targeted_by_maniac") and not slot.get("saved_by_doctor"):
            slot["status"] = STATUS_ELIMINATED
            eliminated_players.append(get_player_display_name(slot, context))
        elif slot.get("saved_by_doctor") and (slot.get("targeted_by_mafia") or slot.get("targeted_by_maniac")):
            saved_players.append(get_player_display_name(slot, context))
        
        # –û—á–∏—â–∞–µ–º –Ω–æ—á–Ω—ã–µ –º–µ—Ç–∫–∏
        slot.pop("targeted_by_mafia", None)
        slot.pop("targeted_by_maniac", None)
        slot.pop("saved_by_doctor", None)
        slot.pop("blocked_by_prostitute", None)
        slot.pop("commissioner_action_complete", None)
        slot.pop("doctor_action_complete", None)
        slot.pop("maniac_action_complete", None)
        slot.pop("prostitute_action_complete", None)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ï–î–ò–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –Ω–æ—á–∏
    if eliminated_players and saved_players:
        result_message = (
            f"üåÖ –ù–∞—Å—Ç—É–ø–∞–µ—Ç –¥–µ–Ω—å {game_data['current_day_number']}.\n\n"
            f"üíÄ **–≠—Ç–æ–π –Ω–æ—á—å—é –ø–æ–≥–∏–±–ª–∏:** {', '.join(eliminated_players)}\n"
            f"üè• **–î–æ–∫—Ç–æ—Ä —Å–ø–∞—Å –æ—Ç —Å–º–µ—Ä—Ç–∏:** {', '.join(saved_players)}\n\n"
            f"‚ö∞Ô∏è –ì–æ—Ä–æ–¥ —Å–∫–æ—Ä–±–∏—Ç –ø–æ —É—Ç—Ä–∞—á–µ–Ω–Ω—ã–º, –Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω —Å–ø–∞—Å–∏—Ç–µ–ª—é..."
        )
    elif eliminated_players:
        death_count = len(eliminated_players)
        if death_count == 1:
            eliminated_name = eliminated_players[0]
            result_message = (
                f"üåÖ –ù–∞—Å—Ç—É–ø–∞–µ—Ç –¥–µ–Ω—å {game_data['current_day_number']}.\n\n"
                f"üíÄ **–≠—Ç–æ–π –Ω–æ—á—å—é –∫—Ç–æ-—Ç–æ –±—ã–ª –∂–µ—Å—Ç–æ–∫–æ —É–±–∏—Ç...**\n\n"
                f"üîç –ñ–∏—Ç–µ–ª–∏ –≥–æ—Ä–æ–¥–∞ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ —Ç–µ–ª–æ **{eliminated_name}** –Ω–∞ —Ä–∞—Å—Å–≤–µ—Ç–µ.\n\n"
                f"üò¢ –ì–æ—Ä–æ–¥ —Å–∫–æ—Ä–±–∏—Ç –æ –ø–æ—Ç–µ—Ä–µ –µ—â–µ –æ–¥–Ω–æ–≥–æ –∂–∏—Ç–µ–ª—è."
            )
        else:
            eliminated_names = ", ".join(eliminated_players)
            result_message = (
                f"üåÖ –ù–∞—Å—Ç—É–ø–∞–µ—Ç –¥–µ–Ω—å {game_data['current_day_number']}.\n\n"
                f"üíÄ **–≠—Ç–æ–π –Ω–æ—á—å—é {death_count} —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–≥–∏–±–ª–∏...**\n\n"
                f"üò± –ì–æ—Ä–æ–¥ –æ–±–Ω–∞—Ä—É–∂–∏–ª —Ç–µ–ª–∞: **{eliminated_names}**\n\n"
                f"üö® –ì–æ—Ä–æ–¥ –æ—Ö–≤–∞—Ç–∏–ª —É–∂–∞—Å –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É–±–∏–π—Å—Ç–≤!"
            )
    elif saved_players:
        result_message = (
            f"üåÖ –ù–∞—Å—Ç—É–ø–∞–µ—Ç –¥–µ–Ω—å {game_data['current_day_number']}.\n\n"
            f"üè• **–î–æ–∫—Ç–æ—Ä —Å–ø–∞—Å –∏–≥—Ä–æ–∫–∞ –æ—Ç –≤–µ—Ä–Ω–æ–π —Å–º–µ—Ä—Ç–∏!**\n\n"
            f"üõ°Ô∏è –ê–Ω–≥–µ–ª-—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –±—ã–ª —Ä—è–¥–æ–º —ç—Ç–æ–π –Ω–æ—á—å—é..."
        )
    else:
        mysterious_messages = [
            "üåô –ù–æ—á—å –ø—Ä–æ—à–ª–∞ –≤ —Ç—Ä–µ–≤–æ–∂–Ω–æ–º –º–æ–ª—á–∞–Ω–∏–∏...",
            "üò¥ –ì–æ—Ä–æ–¥ —Å–ø–∞–ª –±–µ—Å–ø–æ–∫–æ–π–Ω—ã–º —Å–Ω–æ–º...", 
            "üå´Ô∏è –í —Ç—É–º–∞–Ω–µ –Ω–æ—á–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ...",
            "ü¶â –¢–æ–ª—å–∫–æ —Å–æ–≤—ã –±—ã–ª–∏ —Å–≤–∏–¥–µ—Ç–µ–ª—è–º–∏ —Ç–∞–π–Ω —ç—Ç–æ–π –Ω–æ—á–∏...",
            "‚≠ê –ó–≤–µ–∑–¥—ã —Ö—Ä–∞–Ω—è—Ç —Å–µ–∫—Ä–µ—Ç—ã –ø—Ä–æ—à–µ–¥—à–µ–π –Ω–æ—á–∏..."
        ]
        result_message = f"üåÖ –ù–∞—Å—Ç—É–ø–∞–µ—Ç –¥–µ–Ω—å {game_data['current_day_number']}.\n\n" + random.choice(mysterious_messages)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã
    if await check_game_end_conditions(game_id, game_data, context):
        return

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é
    from telegram import InlineKeyboardButton, InlineKeyboardMarkup
    phase_keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚ñ∂Ô∏è –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é", callback_data=f"phase_next_day_{game_id}")]
    ])

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º
    for slot in game_data["players_slots"]:
        if slot.get("user_id"):
            try:
                await context.bot.send_message(
                    slot["user_id"],
                    result_message,
                    reply_markup=phase_keyboard
                )
            except Exception as e:
                logger.error(f"Error sending day start message to player {slot.get('user_id')}: {e}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–±–∏—Ç—ã–º –∏–≥—Ä–æ–∫–∞–º –≤—ã–±–æ—Ä —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Ä–æ–ª—å –∏–ª–∏ –Ω–µ—Ç
    if eliminated_players:
        import asyncio
        asyncio.create_task(send_role_reveal_choice_to_eliminated(game_id, eliminated_players, context))

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
    await send_game_summary_to_players(game_id, game_data, context)

    games[game_id] = game_data

async def send_role_reveal_choice_to_eliminated(game_id: str, eliminated_players: list, context: CallbackContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–±–∏—Ç—ã–º –∏–≥—Ä–æ–∫–∞–º –≤—ã–±–æ—Ä - —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Ä–æ–ª—å –∏–ª–∏ –Ω–µ—Ç"""
    for eliminated_name in eliminated_players:
        # –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —É–±–∏—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        eliminated_slot = None
        for slot in games[game_id]["players_slots"]:
            if (slot.get("fictional_name") == eliminated_name and 
                slot.get("status") == STATUS_ELIMINATED and
                slot.get("user_id")):
                eliminated_slot = slot
                break
        
        if not eliminated_slot:
            continue
        
        user_id = eliminated_slot["user_id"]
        role = eliminated_slot["role"]
        
        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚úÖ –†–∞—Å–∫—Ä—ã—Ç—å —Ä–æ–ª—å", callback_data=f"reveal_role_{game_id}_{user_id}")],
            [InlineKeyboardButton("‚ùå –°–∫—Ä—ã—Ç—å —Ä–æ–ª—å", callback_data=f"hide_role_{game_id}_{user_id}")]
        ])
        
        try:
            await context.bot.send_message(
                user_id,
                f"üíÄ **–í—ã –±—ã–ª–∏ —É–±–∏—Ç—ã —ç—Ç–æ–π –Ω–æ—á—å—é**\n\n"
                f"–í–∞—à–∞ —Ä–æ–ª—å: **{role}**\n\n"
                f"üìú **–ü—Ä–µ–¥—Å–º–µ—Ä—Ç–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞:**\n"
                f"–í—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∂–∏–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤. –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ –±–æ—Ç—É.\n"
                f"–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –∏–≥—Ä–æ–π.\n\n"
                f"üé≠ **–†–∞—Å–∫—Ä—ã—Ç–∏–µ —Ä–æ–ª–∏:**\n"
                f"–•–æ—Ç–∏—Ç–µ –ª–∏ –≤—ã —Ä–∞—Å–∫—Ä—ã—Ç—å —Å–≤–æ—é —Ä–æ–ª—å –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º?\n"
                f"–≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ –∏–ª–∏ —Å–±–∏—Ç—å —Å —Ç–æ–ª–∫—É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤.",
                parse_mode=ParseMode.MARKDOWN,
                reply_markup=keyboard
            )
            logger.info(f"Role reveal choice sent to eliminated player {user_id} ({eliminated_name})")
        except Exception as e:
            logger.error(f"Error sending role reveal choice to {user_id}: {e}")

async def handle_role_reveal_choice(query, context: CallbackContext, game_id: str, user_id: int, reveal: bool):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –∏–≥—Ä–æ–∫–∞ - —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Ä–æ–ª—å –∏–ª–∏ –Ω–µ—Ç"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    # –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
    player_slot = None
    for slot in game_data["players_slots"]:
        if (slot.get("user_id") == user_id and 
            slot.get("status") == STATUS_ELIMINATED):
            player_slot = slot
            break

    if not player_slot:
        await query.answer("‚ùå –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    player_name = get_player_display_name(player_slot, context)
    player_role = player_slot["role"]

    if reveal:
        # –ò–≥—Ä–æ–∫ —Ä–µ—à–∏–ª —Ä–∞—Å–∫—Ä—ã—Ç—å —Ä–æ–ª—å
        await query.edit_message_text(
            f"‚úÖ **–†–æ–ª—å —Ä–∞—Å–∫—Ä—ã—Ç–∞**\n\n"
            f"–í—ã —Ä–∞—Å–∫—Ä—ã–ª–∏ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º, —á—Ç–æ –±—ã–ª–∏ **{player_role}**.",
            parse_mode=ParseMode.MARKDOWN
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∂–∏–≤—ã–º –∏–≥—Ä–æ–∫–∞–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞—Å–∫—Ä—ã—Ç–æ–π —Ä–æ–ª–∏
        reveal_message = (
            f"üé≠ **–†–∞—Å–∫—Ä—ã—Ç–∏–µ —Ä–æ–ª–∏**\n\n"
            f"üíÄ **{player_name}** —Ä–∞—Å–∫—Ä—ã–ª —Å–≤–æ—é —Ä–æ–ª—å:\n"
            f"üéØ **{player_role}**\n\n"
            f"–≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞ –¥–ª—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è!"
        )

        for slot in game_data["players_slots"]:
            if (slot.get("status") == STATUS_ACTIVE and 
                slot.get("user_id") and 
                slot.get("user_id") != user_id):
                try:
                    await context.bot.send_message(
                        slot["user_id"],
                        reveal_message,
                        parse_mode=ParseMode.MARKDOWN
                    )
                except Exception as e:
                    logger.error(f"Error sending role reveal to player {slot['user_id']}: {e}")

        logger.info(f"Player {user_id} ({player_name}) revealed role {player_role} in game {game_id}")

    else:
        # –ò–≥—Ä–æ–∫ —Ä–µ—à–∏–ª —Å–∫—Ä—ã—Ç—å —Ä–æ–ª—å
        await query.edit_message_text(
            f"ü§´ **–†–æ–ª—å —Å–∫—Ä—ã—Ç–∞**\n\n"
            f"–í—ã —Ä–µ—à–∏–ª–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —Å–≤–æ—é —Ä–æ–ª—å (**{player_role}**) –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º.\n"
            f"–≠—Ç–æ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∏–Ω—Ç—Ä–∏–≥—É –∏ –ø–æ–º–æ—á—å –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ.",
            parse_mode=ParseMode.MARKDOWN
        )

        logger.info(f"Player {user_id} ({player_name}) chose to hide role {player_role} in game {game_id}")

async def start_day_voting_after_delay(game_id: str, context: CallbackContext):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –¥–Ω–µ–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏"""
    # –ñ–¥–µ–º –Ω–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ (—Å–æ–∫—Ä–∞—Ç–∏–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    try:
        await asyncio.sleep(10)  # 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    except Exception as e:
        logger.error(f"Error during sleep in start_day_voting_after_delay: {e}")
        return

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    game_data = games.get(game_id)
    if not game_data or game_data.get("state") != STATE_DAY:
        return

    await start_day_voting(game_id, game_data, context)

async def start_day_voting(game_id: str, game_data: dict, context: CallbackContext):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –¥–Ω–µ–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ"""
    logger.info(f"Starting day voting for game {game_id}")

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ
    game_data["voting_active"] = True
    game_data["votes"] = {}
    games[game_id] = game_data

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    active_players = []
    players_with_voting_rights = []
    voting_rights = game_data.get("day_voting_rights", {})
    game_mode = game_data.get("game_mode", "human_host")
    
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("status") == STATUS_ACTIVE:
            player_key = f"player_{i}"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
            if game_mode == "bot_host":
                has_voting_rights = voting_rights.get(player_key, True)  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å—Ç—å –ø—Ä–∞–≤–∞
            else:
                has_voting_rights = True  # –í —Ä–µ–∂–∏–º–µ —á–µ–ª–æ–≤–µ–∫-–≤–µ–¥—É—â–µ–≥–æ –≤—Å–µ –∏–º–µ—é—Ç –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏
            display_name = get_player_display_name(slot, context)
            active_players.append((i, display_name))
            if has_voting_rights:
                players_with_voting_rights.append((i, display_name, slot.get("user_id")))

    if len(active_players) <= 2:
        # –°–ª–∏—à–∫–æ–º –º–∞–ª–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
        await check_game_end_conditions(game_id, game_data, context)
        return

    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –±–µ–∑ –≥–æ–ª–æ—Å–æ–≤)
    keyboard = []
    for i, name in active_players:
        button_text = f"üó≥Ô∏è {name}"
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"vote_{game_id}_{i}")])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–ø—É—Å–∫–∞
    keyboard.append([InlineKeyboardButton("‚≠ï –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ", callback_data=f"vote_skip_{game_id}")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)

    # –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–º–µ–Ω–∞–º–∏ –∏–≥—Ä–æ–∫–æ–≤
    player_list = "\n".join([f"‚Ä¢ {name} - 0 –≥–æ–ª–æ—Å(–æ–≤)" for i, name in active_players])
    
    voting_message = (
        f"üó≥Ô∏è **–î–Ω–µ–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ**\n\n"
        f"üí¨ **–ß–ê–¢ –ê–ö–¢–ò–í–ï–ù!** –ú–æ–∂–µ—Ç–µ –æ–±—Å—É–∂–¥–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.\n"
        f"–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É - –æ–Ω–æ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤—Å–µ–º –∂–∏–≤—ã–º –∏–≥—Ä–æ–∫–∞–º.\n\n"
        f"–í—Ä–µ–º—è –≤—ã–±—Ä–∞—Ç—å, –∫–æ–≥–æ –∏–∑–≥–Ω–∞—Ç—å –∏–∑ –≥–æ—Ä–æ–¥–∞!\n"
        f"–£ –∫–∞–∂–¥–æ–≥–æ –µ—Å—Ç—å 3 –º–∏–Ω—É—Ç—ã –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ.\n\n"
        f"üë• **–ñ–∏–≤—ã–µ –∏–≥—Ä–æ–∫–∏:**\n{player_list}\n"
        f"‚≠ï –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ - 0 –≥–æ–ª–æ—Å(–æ–≤)\n\n"
        f"üìä **–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ:** 0/{len(players_with_voting_rights)} –∏–≥—Ä–æ–∫–æ–≤"
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º, –Ω–æ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    for slot in game_data["players_slots"]:
        if slot.get("status") == STATUS_ACTIVE and slot.get("user_id"):
            user_id = slot.get("user_id")
            # –ù–∞–π–¥–µ–º –∏–Ω–¥–µ–∫—Å –∏–≥—Ä–æ–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
            slot_index = None
            for i, s in enumerate(game_data["players_slots"]):
                if s.get("user_id") == user_id:
                    slot_index = i
                    break
            
            player_key = f"player_{slot_index}" if slot_index is not None else None
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
            if game_mode == "bot_host" and player_key:
                has_voting_rights = voting_rights.get(player_key, True)
            else:
                has_voting_rights = True  # –í —Ä–µ–∂–∏–º–µ —á–µ–ª–æ–≤–µ–∫-–≤–µ–¥—É—â–µ–≥–æ –≤—Å–µ –∏–º–µ—é—Ç –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞
            
            try:
                if has_voting_rights:
                    # –ò–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å
                    await context.bot.send_message(
                        user_id,
                        voting_message,
                        reply_markup=reply_markup,
                        parse_mode=ParseMode.MARKDOWN
                    )
                else:
                    # –ò–≥—Ä–æ–∫ –ª–∏—à–µ–Ω –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–∞ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ)
                    no_vote_message = (
                        f"üó≥Ô∏è **–î–Ω–µ–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ**\n\n"
                        f"–û–±—Å—É–∂–¥–µ–Ω–∏–µ –æ–∫–æ–Ω—á–µ–Ω–æ. –í—Ä–µ–º—è –≤—ã–±—Ä–∞—Ç—å, –∫–æ–≥–æ –∏–∑–≥–Ω–∞—Ç—å –∏–∑ –≥–æ—Ä–æ–¥–∞!\n\n"
                        f"‚ùå **–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–∞** –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –Ω–æ—á–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ.\n"
                        f"üí° –í —Å–ª–µ–¥—É—é—â—É—é –Ω–æ—á—å —É –≤–∞—Å –±—É–¥–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞."
                    )
                    await context.bot.send_message(
                        user_id,
                        no_vote_message,
                        parse_mode=ParseMode.MARKDOWN
                    )
                    logger.info(f"Player {user_id} cannot vote due to math failure in bot-host mode")
                    
            except Exception as e:
                logger.error(f"Error sending voting message to player {user_id}: {e}")

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 3 –º–∏–Ω—É—Ç—ã
    import asyncio
    asyncio.create_task(end_voting_after_timeout(game_id, context))

async def end_voting_after_timeout(game_id: str, context: CallbackContext):
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞"""
    # –ñ–¥–µ–º 3 –º–∏–Ω—É—Ç—ã
    try:
        await asyncio.sleep(180)  # 3 –º–∏–Ω—É—Ç—ã = 180 —Å–µ–∫—É–Ω–¥
    except Exception as e:
        logger.error(f"Error during sleep in end_voting_after_timeout: {e}")
        return

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
    game_data = games.get(game_id)
    if not game_data or not game_data.get("voting_active"):
        return

    await process_voting_results(game_id, game_data, context)

async def process_voting_results(game_id: str, game_data: dict, context: CallbackContext):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è"""
    logger.info(f"Processing voting results for game {game_id}")

    game_data["voting_active"] = False
    votes = game_data.get("votes", {})

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≥–æ–ª–æ—Å–∞ –∏ —Å–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    vote_counts = {}
    voting_details = []
    
    for voter_id, voted_for in votes.items():
        if voted_for not in vote_counts:
            vote_counts[voted_for] = 0
        vote_counts[voted_for] += 1
        
        # –ù–∞—Ö–æ–¥–∏–º –∏–º—è –≥–æ–ª–æ—Å—É—é—â–µ–≥–æ (voter_id —ç—Ç–æ —á–∏—Å–ª–æ–≤–æ–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        voter_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
        for slot in game_data["players_slots"]:
            if slot.get("user_id") == voter_id:
                voter_name = get_player_display_name(slot, context)
                break
        
        # –ù–∞—Ö–æ–¥–∏–º –∏–º—è —Ç–æ–≥–æ, –∑–∞ –∫–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏
        if voted_for == "skip":
            voted_for_name = "–ü—Ä–æ–ø—É—Å–∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è"
        else:
            voted_for_slot = game_data["players_slots"][voted_for]
            voted_for_name = get_player_display_name(voted_for_slot, context)
        
        voting_details.append(f"‚Ä¢ {voter_name} ‚Üí {voted_for_name}")

    # –°–æ–∑–¥–∞–µ–º —Å–≤–æ–¥–∫—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    voting_summary = "\nüìã **–î–µ—Ç–∞–ª–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:**\n" + "\n".join(voting_details) + "\n\n"

    # –ù–∞—Ö–æ–¥–∏–º –∏–≥—Ä–æ–∫–∞ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≥–æ–ª–æ—Å–æ–≤
    if not vote_counts:
        result_message = "üìä –ù–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª. –î–µ–Ω—å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–≥–Ω–∞–Ω–∏—è."
    else:
        max_votes = max(vote_counts.values())
        candidates = [player for player, votes in vote_counts.items() if votes == max_votes]

        if len(candidates) > 1:
            if candidates[0] == "skip":
                result_message = f"üìä –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –≤—ã—è–≤–∏–ª–æ —è–≤–Ω–æ–≥–æ –ª–∏–¥–µ—Ä–∞. –î–µ–Ω—å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–≥–Ω–∞–Ω–∏—è.\n\n{voting_summary}"
            else:
                # –†–∞–≤–µ–Ω—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤ –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏ - –∑–∞–ø—É—Å–∫–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
                await start_runoff_voting(game_id, game_data, candidates, voting_summary, context)
                return
        elif candidates[0] == "skip":
            result_message = f"üìä –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –≤—ã—è–≤–∏–ª–æ —è–≤–Ω–æ–≥–æ –ª–∏–¥–µ—Ä–∞. –î–µ–Ω—å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–≥–Ω–∞–Ω–∏—è.\n\n{voting_summary}"
        else:
            # –ò–∑–≥–æ–Ω—è–µ–º –∏–≥—Ä–æ–∫–∞
            eliminated_player_index = candidates[0]
            eliminated_slot = game_data["players_slots"][eliminated_player_index]
            eliminated_slot["status"] = STATUS_ELIMINATED
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏
            eliminated_display_name = get_player_display_name(eliminated_slot, context)
            result_message = f"üìä –ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∏–∑–≥–Ω–∞–Ω: {eliminated_display_name} (–†–æ–ª—å: {eliminated_slot['role']})\n\n{voting_summary}"

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º
    for slot in game_data["players_slots"]:
        if slot.get("user_id"):
            try:
                await context.bot.send_message(
                    slot["user_id"],
                    result_message
                )
            except Exception as e:
                logger.error(f"Error sending voting results to player {slot.get('user_id')}: {e}")

    games[game_id] = game_data

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã
    if await check_game_end_conditions(game_id, game_data, context):
        return

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –Ω–æ—á—å—é
    await send_game_summary_to_players(game_id, game_data, context)

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –Ω–æ—á—å
    await start_next_night(game_id, game_data, context)

async def start_runoff_voting(game_id: str, game_data: dict, tied_candidates: list, voting_summary: str, context: CallbackContext):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏ —Å —Ä–∞–≤–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≥–æ–ª–æ—Å–æ–≤"""
    logger.info(f"Starting runoff voting in game {game_id} between candidates: {tied_candidates}")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
    game_data["voting_active"] = True
    game_data["votes"] = {}
    game_data["runoff_voting"] = True
    game_data["runoff_candidates"] = tied_candidates
    games[game_id] = game_data
    
    # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–º–µ–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    candidate_names = []
    for candidate_index in tied_candidates:
        candidate_slot = game_data["players_slots"][candidate_index]
        candidate_names.append(get_player_display_name(candidate_slot, context))
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    keyboard = []
    for candidate_index in tied_candidates:
        candidate_slot = game_data["players_slots"][candidate_index]
        candidate_name = get_player_display_name(candidate_slot, context)
        keyboard.append([InlineKeyboardButton(f"üó≥Ô∏è {candidate_name}", callback_data=f"vote_{game_id}_{candidate_index}")])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–ø—É—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    keyboard.append([InlineKeyboardButton("‚≠ï –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ", callback_data=f"vote_skip_{game_id}")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏
    runoff_message = (
        f"‚öñÔ∏è **–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ï –ì–û–õ–û–°–û–í–ê–ù–ò–ï**\n\n"
        f"üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:**\n{voting_summary}"
        f"üéØ **–†–∞–≤–µ–Ω—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤ –º–µ–∂–¥—É:**\n" + "\n".join([f"‚Ä¢ {name}" for name in candidate_names]) + "\n\n"
        f"üó≥Ô∏è **–í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–≥–æ –∏–∑–≥–Ω–∞—Ç—å –∏–∑ –≥–æ—Ä–æ–¥–∞:**\n"
        f"‚è±Ô∏è –£ –≤–∞—Å –µ—Å—Ç—å 2 –º–∏–Ω—É—Ç—ã –Ω–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è"
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º —Å –ø—Ä–∞–≤–æ–º –≥–æ–ª–æ—Å–∞
    game_mode = game_data.get("game_mode", "human_host")
    voting_rights = game_data.get("day_voting_rights", {})
    
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("status") == STATUS_ACTIVE:
            player_key = f"player_{i}"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
            if game_mode == "bot_host":
                has_voting_rights = voting_rights.get(player_key, True)
            else:
                has_voting_rights = True
            
            if has_voting_rights and slot.get("user_id"):
                try:
                    await context.bot.send_message(
                        slot["user_id"],
                        runoff_message,
                        reply_markup=reply_markup,
                        parse_mode=ParseMode.MARKDOWN
                    )
                except Exception as e:
                    logger.error(f"Error sending runoff voting message to player {slot['user_id']}: {e}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    import asyncio
    asyncio.create_task(end_voting_after_timeout(game_id, context))

async def start_next_night(game_id: str, game_data: dict, context: CallbackContext):
    """–ù–∞—á–∏–Ω–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –Ω–æ—á—å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–Ω—è"""
    logger.info(f"Starting next night for game {game_id}")

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    game_data["state"] = STATE_NIGHT
    game_data["current_night_number"] = game_data.get("current_night_number", 0) + 1
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è: –Ω–æ—á–Ω—ã–µ —Ä–æ–ª–∏ = –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∞, –º–∏—Ä–Ω—ã–µ = –Ω–µ—Ç
    game_data["day_voting_rights"] = {}
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("status") == STATUS_ACTIVE:
            player_key = f"player_{i}"
            # –†–æ–ª–∏ —Å –Ω–æ—á–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –ø–æ–ª—É—á–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–∞
            has_night_role = slot.get("role") in NIGHT_ROLES
            game_data["day_voting_rights"][player_key] = has_night_role
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ —ç—Ç–æ–π –∏–≥—Ä—ã
    # –¢–û–õ–¨–ö–û –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
    if game_data.get("game_mode") == "bot_host":
        users_to_reset = []
        for user_id, math_state in user_math_state.items():
            if math_state.get("game_id") == game_id:
                users_to_reset.append(user_id)
        
        for user_id in users_to_reset:
            del user_math_state[user_id]
            logger.info(f"Reset math state for user {user_id} for new night in game {game_id} (bot-host mode)")
    
    games[game_id] = game_data

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –Ω–æ—á–∏
    await announce_night_start(game_id, game_data, context)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    await start_night_actions(game_id, game_data, context)

async def check_game_end_conditions(game_id: str, game_data: dict, context: CallbackContext):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã –∏ –æ–±—ä—è–≤–ª—è–µ—Ç –ø–æ–±–µ–¥–∏—Ç–µ–ª—è"""
    logger.info(f"Checking game end conditions for game {game_id}")

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø–æ —Ä–æ–ª—è–º
    mafia_count = 0
    civilian_count = 0
    maniac_count = 0

    for slot in game_data["players_slots"]:
        if slot.get("status") == STATUS_ACTIVE:
            role = slot["role"]
            if role in ["–î–æ–Ω –ú–∞—Ñ–∏–∏", "–ú–∞—Ñ–∏–æ–∑–∏"]:
                mafia_count += 1
            elif role == "–ú–∞–Ω—å—è–∫":
                maniac_count += 1
            else:
                civilian_count += 1

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –ø–æ–±–µ–¥—ã
    game_over = False
    winner = None
    winner_message = ""

    if mafia_count == 0 and maniac_count == 0:
        # –ú–∞—Ñ–∏—è –∏ –ú–∞–Ω—å—è–∫ —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã - –ø–æ–±–µ–¥–∞ –º–∏—Ä–Ω—ã—Ö
        game_over = True
        winner = "–ú–∏—Ä–Ω—ã–µ –∂–∏—Ç–µ–ª–∏"
        winner_message = "üéâ –ü–æ–±–µ–¥–∞ –º–∏—Ä–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π! –í—Å–µ –∑–ª–æ–¥–µ–∏ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã."
    elif mafia_count >= civilian_count and maniac_count == 0:
        # –ú–∞—Ñ–∏–∏ —Å—Ç–æ–ª—å–∫–æ –∂–µ –∏–ª–∏ –±–æ–ª—å—à–µ, —á–µ–º –º–∏—Ä–Ω—ã—Ö, –∏ –ú–∞–Ω—å—è–∫ —É–Ω–∏—á—Ç–æ–∂–µ–Ω - –ø–æ–±–µ–¥–∞ –º–∞—Ñ–∏–∏
        game_over = True
        winner = "–ú–∞—Ñ–∏—è"
        winner_message = "üî™ –ü–æ–±–µ–¥–∞ –º–∞—Ñ–∏–∏! –û–Ω–∏ –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ –≥–æ—Ä–æ–¥ –∏ —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤—è—Ç –±–µ–∑—Ä–∞–∑–¥–µ–ª—å–Ω–æ."
    elif civilian_count == 0 and mafia_count == 0 and maniac_count == 1:
        # –í—Å–µ –∫—Ä–æ–º–µ –ú–∞–Ω—å—è–∫–∞ –º–µ—Ä—Ç–≤—ã - –ø–æ–±–µ–¥–∞ –ú–∞–Ω—å—è–∫–∞
        game_over = True
        winner = "–ú–∞–Ω—å—è–∫"
        winner_message = "ü§Ø –ü–æ–±–µ–¥–∞ –ú–∞–Ω—å—è–∫–∞! –ì–æ—Ä–æ–¥ –ø–æ–≥—Ä—É–∑–∏–ª—Å—è –≤ —Ö–∞–æ—Å –∏ —É–∂–∞—Å."

    if game_over:
        # –ó–∞–≤–µ—Ä—à–∞–µ–º –∏–≥—Ä—É
        game_data["state"] = STATE_FINISHED
        game_data["winner"] = winner
        games[game_id] = game_data

        # –°–æ–∑–¥–∞—ë–º –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–æ–ª–µ–π
        role_stats = []
        for slot in game_data["players_slots"]:
            if slot.get("user_id"):
                player_name = get_player_display_name(slot, context)
                role = slot.get("role", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
                status = "üü¢ –í—ã–∂–∏–ª" if slot.get("status") == STATUS_ACTIVE else "üíÄ –ü–æ–≥–∏–±"
                role_stats.append(f"‚Ä¢ {player_name}: **{role}** - {status}")

        final_message = (
            f"üèÅ **–ò–ì–†–ê –ó–ê–í–ï–†–®–ï–ù–ê!**\n\n"
            f"{winner_message}\n\n"
            f"üë• **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤:**\n" + "\n".join(role_stats) + "\n\n"
            f"üé≠ –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É! –•–æ—Ç–∏—Ç–µ —Å—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑?"
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä—ã –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
        for slot in game_data["players_slots"]:
            if slot.get("user_id"):
                try:
                    await context.bot.send_message(
                        slot["user_id"],
                        final_message,
                        parse_mode=ParseMode.MARKDOWN
                    )
                except Exception as e:
                    logger.error(f"Error sending game end message to player {slot.get('user_id')}: {e}")

        logger.info(f"Game {game_id} ended with winner: {winner}")
        return True

    return False

async def create_game_from_pending_settings(query_or_update, context: CallbackContext, settings: dict):
    """–°–æ–∑–¥–∞–µ—Ç –∏–≥—Ä—É –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
    try:
        logger.info(f"[DEBUG] –ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏: {settings}")

        if hasattr(query_or_update, 'from_user'):
            user = query_or_update.from_user
        else:
            user = query_or_update.message.from_user
        
        logger.info(f"[DEBUG] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} ({user.full_name}) —Å–æ–∑–¥–∞–µ—Ç –∏–≥—Ä—É")

        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        num_players = settings.get('num_players', 6)
        game_mode = settings.get('game_mode', 'human_host')
        version = settings.get('version', 'paid')
        role_setup_method = settings.get('role_setup_method', 'auto')

        logger.info(f"[DEBUG] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã: {num_players} –∏–≥—Ä–æ–∫–æ–≤, —Ä–µ–∂–∏–º: {game_mode}, –≤–µ—Ä—Å–∏—è: {version}")

        # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–†–ï–ú–ò–£–ú –î–û–°–¢–£–ü–ê
        if version in ['paid', 'premium']:
            user_premium_status, status_info = premium_db.check_premium_status(user.id)
            if not user_premium_status:
                logger.warning(f"[SECURITY] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} ({user.full_name}) –ø–æ–ø—ã—Ç–∞–ª—Å—è —Å–æ–∑–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º –∏–≥—Ä—É –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏!")
                error_message = (
                    "üö´ **–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!**\n\n"
                    "–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–º–∏—É–º –∏–≥—Ä—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.\n\n"
                    "üíé **–ß—Ç–æ –¥–∞–µ—Ç –ø—Ä–µ–º–∏—É–º:**\n"
                    "‚Ä¢ –î–æ 20 –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–≥—Ä–µ\n"
                    "‚Ä¢ –í—Å–µ —Ä–æ–ª–∏ (–î–æ–Ω –ú–∞—Ñ–∏–∏, –ú–∞–Ω—å—è–∫, –ü—É—Ç–∞–Ω–∞)\n"
                    "‚Ä¢ –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π\n"
                    "‚Ä¢ –†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏\n\n"
                    f"**–í–∞—à —Å—Ç–∞—Ç—É—Å:** {status_info}"
                )
                
                if hasattr(query_or_update, 'edit_message_text'):
                    await query_or_update.edit_message_text(
                        error_message,
                        reply_markup=InlineKeyboardMarkup([
                            [InlineKeyboardButton("üíé –ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º", callback_data="buy_premium")],
                            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="create_game")]
                        ]),
                        parse_mode=ParseMode.MARKDOWN
                    )
                else:
                    await query_or_update.message.reply_text(error_message, parse_mode=ParseMode.MARKDOWN)
                return None

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        if not (4 <= num_players <= 20):
            error_msg = f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤: {num_players}"
            logger.error(error_msg)
            if hasattr(query_or_update, 'edit_message_text'):
                await query_or_update.edit_message_text("‚ùå –û—à–∏–±–∫–∞: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 4 –¥–æ 20")
            return None

        logger.info("[DEBUG] –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ")

        # –°–æ–∑–¥–∞–µ–º —Ä–æ–ª–∏
        if version == 'free':
            assigned_roles_list = await assign_roles_free(num_players)
        else:
            assigned_roles_list = await assign_roles_standard(num_players)

        if not assigned_roles_list:
            if hasattr(query_or_update, 'edit_message_text'):
                await query_or_update.edit_message_text("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–ª–µ–π")
            return None

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∏–≥—Ä—ã
        game_id = "mafia_" + generate_id(6)

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏–º–µ–Ω–∞ –∏ –¥–µ–ª–∞
        available_fictional_names = fictional_names_list.copy()
        random.shuffle(available_fictional_names)
        available_personal_cases = personal_cases.copy()
        random.shuffle(available_personal_cases)

        # –°–æ–∑–¥–∞–µ–º —Å–ª–æ—Ç—ã –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤
        players_slots = []
        for i in range(num_players):
            player_role = assigned_roles_list[i]
            player_name = available_fictional_names[i % len(available_fictional_names)]
            player_case = available_personal_cases[i % len(available_personal_cases)]
            
            slot = {
                "role": player_role,
                "description": player_case,
                "fictional_name": player_name,
                "user_id": None,
                "_user_first_name": None,
                "status": STATUS_ACTIVE,
                "original_slot_index": i
            }
            players_slots.append(slot)

        # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–≥—Ä—ã
        game_data = {
            'host_id': user.id,
            'host_name': user.full_name or "–ê–Ω–æ–Ω–∏–º",
            'state': STATE_ROLES_DISTRIBUTED,
            'players_slots': players_slots,
            'num_players': num_players,
            'game_mode': game_mode,
            'game_version': version,
            'created_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            'current_night_number': 0,
            'current_day_number': 0
        }

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É
        games[game_id] = game_data

        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –±–æ—Ç–∞ –¥–ª—è —Å—Å—ã–ª–∫–∏
        try:
            bot_info = await context.bot.get_me()
            bot_username = bot_info.username
            logger.info(f"[DEBUG] –ü–æ–ª—É—á–µ–Ω–æ –∏–º—è –±–æ—Ç–∞ –∏–∑ API: @{bot_username}")
        except Exception as e:
            logger.error(f"[ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ: {e}")
            bot_username = "Mafia_IRL_Bot"
            logger.info(f"[DEBUG] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∏–º—è –±–æ—Ç–∞: @{bot_username}")

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –æ–±—ã—á–Ω–æ–π –∏–≥—Ä–µ
        join_game_link = f"https://t.me/{bot_username}?start=join_{game_id}"
        
        logger.info(f"[DEBUG] –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è —Å—Å—ã–ª–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏: {join_game_link}")
        logger.info(f"[DEBUG] –ò—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –∏–º—è –±–æ—Ç–∞ –≤ —Ç–µ–∫—Å—Ç–µ: @{bot_username}")

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ –∏–≥—Ä—ã
        if version == 'free':
            game_type_description = "üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞"
        else:
            if game_mode == 'human_host':
                game_type_description = "üíé –ü–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞ (–í–µ–¥—É—â–∏–π - –Ø)"
            else:
                game_type_description = "ü§ñüíé –ü–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞ (–í–µ–¥—É—â–∏–π - –ë–æ—Ç)"

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ
        host_display_line = f"–í–µ–¥—É—â–∏–π: {user.first_name}\n"
        if game_mode == 'bot_host':
            host_display_line = f"–°–æ–∑–¥–∞—Ç–µ–ª—å –∏–≥—Ä—ã: {user.first_name}\n"

        message_text = (
            f"üé≤ –ù–æ–≤–∞—è –∏–≥—Ä–∞ –≤ –ú–∞—Ñ–∏—é —Å–æ–∑–¥–∞–Ω–∞!\n\n"
            f"üÜî ID –∏–≥—Ä—ã: {game_id}\n"
            f"üéÆ –¢–∏–ø –∏–≥—Ä—ã: {game_type_description}\n"
            f"{host_display_line}"
            f"üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤: {num_players}\n\n"
            f"üîó –°–°–´–õ–ö–ê –î–õ–Ø –ò–ì–†–û–ö–û–í:\n"
            f"{join_game_link}\n\n"
            f"üì§ –†–∞–∑–æ—à–ª–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.\n"
            f"üé≠ –ò–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å —Ä–æ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
        )

        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üéÆ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è", callback_data=f"join_game_{game_id}")],
            [InlineKeyboardButton("üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–≥—Ä–æ–π", callback_data=f"copy_link_{game_id}")]
        ])

        if hasattr(query_or_update, 'edit_message_text'):
            await query_or_update.edit_message_text(
                message_text,
                parse_mode=None,
                reply_markup=keyboard
            )
        else:
            await query_or_update.message.reply_text(
                message_text, 
                parse_mode=None,
                reply_markup=keyboard
            )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Ä–æ–ª–µ–π –≤–µ–¥—É—â–µ–º—É (–µ—Å–ª–∏ –Ω–µ –±–æ—Ç-–≤–µ–¥—É—â–∏–π)
        if game_mode != 'bot_host':
            roles_details = ["üïµÔ∏è **–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ —Ä–æ–ª–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏:**"]
            for i, slot in enumerate(players_slots):
                roles_details.append(
                    f"**–°–ª–æ—Ç {i+1}:** {slot['fictional_name']} - {slot['role']} *(–û–∂–∏–¥–∞–µ—Ç –∏–≥—Ä–æ–∫–∞)*"
                )
            
            await context.bot.send_message(
                user.id,
                "\n".join(roles_details),
                parse_mode=None
            )

        logger.info(f"[DEBUG] –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ —Å ID: {game_id}")
        
        # –í —Ä–µ–∂–∏–º–µ human_host —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        if game_mode == 'human_host':
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            await context.bot.send_message(
                chat_id=user.id,
                text=f"üéÆ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π {game_id}\n\n–í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É –∏–ª–∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤.",
                reply_markup=get_main_control_keyboard(game_id),
                parse_mode=None
            )
        else:
            return game_id

    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–≥—Ä—ã: {str(e)}\n\n–î–µ—Ç–∞–ª–∏:\n{error_details}"
        logger.error(f"[ERROR] {error_msg}")
        if hasattr(query_or_update, 'edit_message_text'):
            try:
                await query_or_update.edit_message_text(
                    f"‚ùå **–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–≥—Ä—ã.**\n\n"
                    f"**–¢–∏–ø –æ—à–∏–±–∫–∏:** {type(e).__name__}\n"
                    f"**–°–æ–æ–±—â–µ–Ω–∏–µ:** {str(e)}",
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as send_error:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: {send_error}")
        return None

async def create_timer_game_from_pending_settings(query_or_update, context: CallbackContext, settings: dict):
    """–°–æ–∑–¥–∞–µ—Ç –∏–≥—Ä—É —Å —Ä–µ–∂–∏–º–æ–º –≤—Ä–µ–º–µ–Ω–∏ (3 –º–∏–Ω—É—Ç—ã)"""
    try:
        logger.info(f"[DEBUG] –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã —Å —Ç–∞–π–º–µ—Ä–æ–º: {settings}")

        if hasattr(query_or_update, 'from_user'):
            user = query_or_update.from_user
        else:
            user = query_or_update.message.from_user
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        max_players = settings.get('num_players', 6)
        version = settings.get('version', 'paid')
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–†–ï–ú–ò–£–ú –î–û–°–¢–£–ü–ê
        if version in ['paid', 'premium']:
            user_premium_status, status_info = premium_db.check_premium_status(user.id)
            if not user_premium_status:
                logger.warning(f"[SECURITY] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} ({user.full_name}) –ø–æ–ø—ã—Ç–∞–ª—Å—è —Å–æ–∑–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º –∏–≥—Ä—É –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏!")
                error_message = (
                    "üö´ **–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!**\n\n"
                    "–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–º–∏—É–º –∏–≥—Ä—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.\n\n"
                    "üíé **–ß—Ç–æ –¥–∞–µ—Ç –ø—Ä–µ–º–∏—É–º:**\n"
                    "‚Ä¢ –î–æ 20 –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–≥—Ä–µ\n"
                    "‚Ä¢ –í—Å–µ —Ä–æ–ª–∏ (–î–æ–Ω –ú–∞—Ñ–∏–∏, –ú–∞–Ω—å—è–∫, –ü—É—Ç–∞–Ω–∞)\n"
                    "‚Ä¢ –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π\n"
                    "‚Ä¢ –†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏\n\n"
                    f"**–í–∞—à —Å—Ç–∞—Ç—É—Å:** {status_info}"
                )
                
                if hasattr(query_or_update, 'edit_message_text'):
                    await query_or_update.edit_message_text(
                        error_message,
                        reply_markup=InlineKeyboardMarkup([
                            [InlineKeyboardButton("üíé –ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º", callback_data="buy_premium")],
                            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="create_game")]
                        ]),
                        parse_mode=ParseMode.MARKDOWN
                    )
                else:
                    await query_or_update.message.reply_text(error_message, parse_mode=ParseMode.MARKDOWN)
                return None

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∏–≥—Ä—ã
        game_id = "timer_" + generate_id(6)

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏–º–µ–Ω–∞ –∏ –¥–µ–ª–∞
        available_fictional_names = fictional_names_list.copy()
        random.shuffle(available_fictional_names)
        available_personal_cases = personal_cases.copy()
        random.shuffle(available_personal_cases)

        # –°–æ–∑–¥–∞–µ–º —Å–ª–æ—Ç—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤ (–≤—Å–µ –ø—É—Å—Ç—ã–µ –ø–æ–∫–∞)
        # –†–æ–ª–∏ –±—É–¥—É—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è 3 –º–∏–Ω—É—Ç
        players_slots = []
        for i in range(max_players):
            player_name = available_fictional_names[i % len(available_fictional_names)]
            player_case = available_personal_cases[i % len(available_personal_cases)]
            
            slot = {
                "role": None,  # –†–æ–ª—å –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–æ–∑–∂–µ
                "fictional_name": player_name,
                "description": player_case,
                "user_id": None,  # –ü–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
                "_user_first_name": None,
                "real_name": None,
                "status": STATUS_ACTIVE,
                "player_number_for_host": i + 1
            }
            players_slots.append(slot)

        # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–≥—Ä—ã
        game_data = {
            'host_id': user.id,
            'host_name': user.full_name or "–ê–Ω–æ–Ω–∏–º",
            'state': STATE_TIMER_WAITING,  # –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤—Ä–µ–º–µ–Ω–∏
            'players_slots': players_slots,
            'max_players': max_players,
            'current_players': 0,
            'game_mode': 'bot_host_timer',
            'game_version': version,
            'created_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            'timer_started_at': datetime.now(),
            'current_night_number': 0,
            'current_day_number': 0
        }

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É
        games[game_id] = game_data

        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –±–æ—Ç–∞ –¥–ª—è —Å—Å—ã–ª–∫–∏
        try:
            bot_info = await context.bot.get_me()
            bot_username = bot_info.username
            logger.info(f"[DEBUG] –ü–æ–ª—É—á–µ–Ω–æ –∏–º—è –±–æ—Ç–∞ –¥–ª—è —Ç–∞–π–º–µ—Ä-–∏–≥—Ä—ã: @{bot_username}")
        except Exception as e:
            logger.error(f"[ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ –¥–ª—è —Ç–∞–π–º–µ—Ä-–∏–≥—Ä—ã: {e}")
            bot_username = "Mafia_IRL_Bot"

        join_game_link = f"https://t.me/{bot_username}?start=join_timer_{game_id.replace('timer_', '')}"
        
        logger.info(f"[DEBUG] –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è —Å—Å—ã–ª–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏: {join_game_link}")
        logger.info(f"[DEBUG] –ò—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –∏–º—è –±–æ—Ç–∞ –≤ —Ç–µ–∫—Å—Ç–µ: @{bot_username}")

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ –∏–≥—Ä—ã
        if version == 'free':
            game_type_description = "üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞"
        else:
            game_type_description = "üíé –ü—Ä–µ–º–∏—É–º –∏–≥—Ä–∞"

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è (—É–±–∏—Ä–∞–µ–º markdown —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫)
        message_text = (
            f"‚è±Ô∏è –ò–≥—Ä–∞ —Å —Ç–∞–π–º–µ—Ä–æ–º —Å–æ–∑–¥–∞–Ω–∞!\n\n"
            f"üÜî ID –∏–≥—Ä—ã: {game_id}\n"
            f"üéÆ –¢–∏–ø –∏–≥—Ä—ã: {game_type_description} (–†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏)\n"
            f"–°–æ–∑–¥–∞—Ç–µ–ª—å: {user.first_name}\n"
            f"üë• –ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤: {max_players}\n\n"
            f"‚è∞ –†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏: –ß–µ—Ä–µ–∑ 3 –º–∏–Ω—É—Ç—ã –∏–≥—Ä–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å —Ç–µ–º–∏, –∫—Ç–æ —É—Å–ø–µ–ª –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è!\n"
            f"–ú–∏–Ω–∏–º—É–º –¥–ª—è —Å—Ç–∞—Ä—Ç–∞: 4 –∏–≥—Ä–æ–∫–∞\n\n"
            f"üîó –°–°–´–õ–ö–ê –î–õ–Ø –ò–ì–†–û–ö–û–í:\n"
            f"{join_game_link}\n\n"
            f"üì§ –†–∞–∑–æ—à–ª–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º. –¢–æ—Ä–æ–ø–∏—Ç–µ—Å—å - –≤—Ä–µ–º—è –ø–æ—à–ª–æ!"
        )

        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üìã –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–≥—Ä–æ–π", callback_data=f"copy_link_{game_id}")],
            [InlineKeyboardButton("‚è∞ –°—Ç–∞—Ç—É—Å —Ç–∞–π–º–µ—Ä–∞", callback_data=f"timer_status_{game_id}")]
        ])

        if hasattr(query_or_update, 'edit_message_text'):
            await query_or_update.edit_message_text(
                message_text,
                reply_markup=keyboard,
                parse_mode=None
            )
        else:
            await context.bot.send_message(
                chat_id=user.id,
                text=message_text,
                reply_markup=keyboard,
                parse_mode=None
            )

        # –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å—Ä–∞–∑—É - –æ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
        # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ —Ç–∞–π–º–µ—Ä –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω
        game_data['timer_started'] = False

        logger.info(f"[DEBUG] –ò–≥—Ä–∞ —Å —Ç–∞–π–º–µ—Ä–æ–º —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞: {game_id}")
        return game_id

    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        error_msg = f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–≥—Ä—ã —Å —Ç–∞–π–º–µ—Ä–æ–º: {str(e)}\n\n–î–µ—Ç–∞–ª–∏:\n{error_details}"
        logger.error(f"[ERROR] {error_msg}")
        if hasattr(query_or_update, 'edit_message_text'):
            try:
                await query_or_update.edit_message_text(
                    f"‚ùå **–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–≥—Ä—ã.**\n\n"
                    f"**–¢–∏–ø –æ—à–∏–±–∫–∏:** {type(e).__name__}\n"
                    f"**–°–æ–æ–±—â–µ–Ω–∏–µ:** {str(e)}",
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as send_error:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: {send_error}")
        return None

async def auto_update_timer_status(game_id: str, context: CallbackContext):
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Ç–∞–π–º–µ—Ä–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤"""
    import asyncio
    from datetime import datetime, timedelta
    
    while True:
        await asyncio.sleep(10)  # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        
        game_data = games.get(game_id)
        if not game_data or game_data.get('state') != STATE_TIMER_WAITING:
            break  # –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞
        
        # –°—á–∏—Ç–∞–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
        timer_started = game_data.get('timer_started_at')
        if isinstance(timer_started, str):
            try:
                timer_started = datetime.strptime(timer_started, "%Y-%m-%d %H:%M:%S")
            except:
                timer_started = datetime.now() - timedelta(minutes=1)
        
        elapsed_time = datetime.now() - timer_started
        remaining_time = timedelta(minutes=3) - elapsed_time
        
        if remaining_time.total_seconds() <= 0:
            break  # –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ
        
        remaining_minutes = int(remaining_time.total_seconds() // 60)
        remaining_seconds = int(remaining_time.total_seconds() % 60)
        time_text = f"{remaining_minutes}:{remaining_seconds:02d}"
        
        current_players = sum(1 for slot in game_data['players_slots'] if slot.get('user_id'))
        max_players = game_data.get('max_players', 20)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞–º (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –≤–º–µ—Å—Ç–æ —Å–ø–∞–º–∞)
        update_message = (
            f"‚è∞ –ò–≥—Ä–∞ –Ω–∞—á–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑: {time_text}\n\n"
            f"üë• –ò–≥—Ä–æ–∫–æ–≤: {current_players}/{max_players}\n"
            f"üéØ –ú–∏–Ω–∏–º—É–º: 4 –∏–≥—Ä–æ–∫–∞\n\n"
            f"üìà –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏!"
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if not hasattr(auto_update_timer_status, 'message_ids'):
            auto_update_timer_status.message_ids = {}
        
        for slot in game_data['players_slots']:
            if slot.get('user_id'):
                user_id = slot['user_id']
                try:
                    if user_id in auto_update_timer_status.message_ids:
                        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        await context.bot.edit_message_text(
                            chat_id=user_id,
                            message_id=auto_update_timer_status.message_ids[user_id],
                            text=update_message
                        )
                    else:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        msg = await context.bot.send_message(user_id, update_message)
                        auto_update_timer_status.message_ids[user_id] = msg.message_id
                except Exception:
                    # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
                    try:
                        msg = await context.bot.send_message(user_id, update_message)
                        auto_update_timer_status.message_ids[user_id] = msg.message_id
                    except:
                        pass

async def start_timer_game_after_delay(game_id: str, context: CallbackContext):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–≥—Ä—É —á–µ—Ä–µ–∑ 3 –º–∏–Ω—É—Ç—ã –∏–ª–∏ –∫–æ–≥–¥–∞ –≤—Å–µ –º–µ—Å—Ç–∞ –∑–∞–Ω—è—Ç—ã"""
    # –ñ–¥–µ–º 3 –º–∏–Ω—É—Ç—ã (180 —Å–µ–∫—É–Ω–¥)
    import asyncio
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    for remaining_minutes in [2, 1]:
        await asyncio.sleep(60)  # –ñ–¥–µ–º –º–∏–Ω—É—Ç—É
        
        game_data = games.get(game_id)
        if not game_data or game_data.get('state') != STATE_TIMER_WAITING:
            return  # –ò–≥—Ä–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞
        
        current_players = sum(1 for slot in game_data['players_slots'] if slot.get('user_id'))
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º
        for slot in game_data['players_slots']:
            if slot.get('user_id'):
                try:
                    await context.bot.send_message(
                        slot['user_id'],
                        f"‚è∞ –î–æ —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã –æ—Å—Ç–∞–ª–æ—Å—å {remaining_minutes} {get_minute_word(remaining_minutes)}!\n"
                        f"üë• –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–æ—Å—å –∏–≥—Ä–æ–∫–æ–≤: {current_players}/{game_data['max_players']}"
                    )
                except:
                    pass
    
    # –ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–Ω—É—Ç–∞ - –∂–¥–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
    await asyncio.sleep(60)
    
    game_data = games.get(game_id)
    if not game_data or game_data.get('state') != STATE_TIMER_WAITING:
        return  # –ò–≥—Ä–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞
    
    current_players = sum(1 for slot in game_data['players_slots'] if slot.get('user_id'))
    
    if current_players < 4:
        # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ - –æ—Ç–º–µ–Ω—è–µ–º –∏–≥—Ä—É –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è
        try:
            await context.bot.send_message(
                game_data['host_id'],
                f"‚ùå **–ò–≥—Ä–∞ {game_id} –æ—Ç–º–µ–Ω–µ–Ω–∞**\n\n"
                f"–ó–∞ 3 –º–∏–Ω—É—Ç—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–æ—Å—å —Ç–æ–ª—å–∫–æ {current_players} –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–∏–Ω–∏–º—É–º 4."
            )
        except:
            pass
        
        # –£–¥–∞–ª—è–µ–º –∏–≥—Ä—É
        if game_id in games:
            del games[game_id]
        return
    
    # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–≥—Ä–æ–∫–æ–≤ - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª–∏ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É
    filled_slots = [slot for slot in game_data['players_slots'] if slot.get('user_id')]
    actual_player_count = len(filled_slots)
    
    # –í–ê–ñ–ù–û: –¢–µ–ø–µ—Ä—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–û–ì–û –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
    if game_data.get('version') == 'free':
        roles_to_assign = await assign_roles_free(actual_player_count)
    else:
        roles_to_assign = await assign_roles_standard(actual_player_count)
    
    # –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Ä–æ–ª–∏
    import random
    random.shuffle(roles_to_assign)
    
    # –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª–∏ —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º —Å–ª–æ—Ç–∞–º
    for i, slot in enumerate(filled_slots):
        if i < len(roles_to_assign):
            slot['role'] = roles_to_assign[i]
    
    # –û–±—Ä–µ–∑–∞–µ–º —Å–ª–æ—Ç—ã –¥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–≤—à–∏—Ö—Å—è –∏–≥—Ä–æ–∫–æ–≤
    game_data['players_slots'] = filled_slots
    game_data['num_players'] = actual_player_count
    game_data['state'] = 'ready'
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ–± –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å—Ç–∞—Ä—Ç–µ —Å –ü–û–õ–ù–û–ô –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–æ–ª—è—Ö
    for slot in filled_slots:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—é–∑–Ω–∏–∫–æ–≤ –º–∞—Ñ–∏–∏
        mafia_allies_text = ""
        if slot['role'] in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]:
            allies = []
            for other_slot in filled_slots:
                if (other_slot.get('user_id') and 
                    other_slot.get('user_id') != slot.get('user_id') and
                    other_slot.get('role') in ["–ú–∞—Ñ–∏–æ–∑–∏", "–î–æ–Ω –ú–∞—Ñ–∏–∏"]):
                    allies.append(f"{other_slot['fictional_name']} ({other_slot.get('real_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')})")
            
            if allies:
                mafia_allies_text = f"\nü§ù –í–∞—à–∏ —Å–æ—é–∑–Ω–∏–∫–∏ –≤ –º–∞—Ñ–∏–∏:\n‚Ä¢ " + "\n‚Ä¢ ".join(allies) + "\n"
            else:
                mafia_allies_text = "\nüë§ –í—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –º–∞—Ñ–∏—è –≤ —ç—Ç–æ–π –∏–≥—Ä–µ.\n"
        
        try:
            # –ü–û–õ–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–º–µ–Ω–µ–º, —Ä–æ–ª—å—é, –ª–∏—á–Ω—ã–º –¥–µ–ª–æ–º –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
            full_message = (
                f"üéâ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!\n\n"
                f"üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {actual_player_count}\n\n"
                f"üé≠ –í–∞—à–µ –∏–º—è: {slot['fictional_name']}\n"
                f"üìã –í–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è: {slot['description']}\n\n"
                f"{get_role_description(slot['role'])}"
                f"{mafia_allies_text}\n"
                f"üí¨ –°–∏—Å—Ç–µ–º–∞ —á–∞—Ç–∞: –ü–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏, –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É.\n\n"
                f"ü§ñ –ë–æ—Ç-–≤–µ–¥—É—â–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–≥—Ä—É..."
            )
            
            await context.bot.send_message(
                slot['user_id'],
                full_message
            )
        except Exception as e:
            logger.error(f"Error sending full game start info to player {slot['user_id']}: {e}")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä—É —á–µ—Ä–µ–∑ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
    await start_bot_hosted_game(game_id, game_data, context)

async def button_callback_handler(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""
    query = update.callback_query
    await query.answer()
    
    data = query.data
    user = query.from_user
    
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ callback –¥–∞–Ω–Ω—ã—Ö: {data}")
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.id} ({user.full_name})")
    
    if data == "create_game":
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –∏–≥—Ä—ã
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üéÆ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º", callback_data="game_type_free")],
            [InlineKeyboardButton("üíé –ü—Ä–µ–º–∏—É–º —Ä–µ–∂–∏–º", callback_data="game_type_premium")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")]
        ])
        await query.edit_message_text(
            "üéÆ **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–≥—Ä—ã:",
            reply_markup=keyboard,
            parse_mode=ParseMode.MARKDOWN
        )
    
    elif data in ["game_type_free", "game_type_premium"]:
        is_premium = (data == "game_type_premium")
        logger.info(f"[DEBUG] –í—ã–±—Ä–∞–Ω —Ç–∏–ø –∏–≥—Ä—ã: {'premium' if is_premium else 'free'}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –∏–≥—Ä—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        context.user_data['game_type'] = 'premium' if is_premium else 'free'
        logger.info(f"[DEBUG] –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –Ω–∞–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üë• –¢–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤", 
                                callback_data=f"player_mode_exact_{'premium' if is_premium else 'free'}")],
            [InlineKeyboardButton("‚è±Ô∏è –†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏ (3 –º–∏–Ω—É—Ç—ã)", 
                                callback_data=f"player_mode_timer_{'premium' if is_premium else 'free'}")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="create_game")]
        ])
        
        game_type_name = "–ü—Ä–µ–º–∏—É–º" if is_premium else "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π"
        max_players = "20" if is_premium else "8"
        
        await query.edit_message_text(
            f"üéÆ **{game_type_name} —Ä–µ–∂–∏–º**\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –Ω–∞–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤:\n\n"
            f"üë• **–¢–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ** - —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —á–∏—Å–ª–æ –∏–≥—Ä–æ–∫–æ–≤ (4-{max_players})\n\n"
            f"‚è±Ô∏è **–†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏** - –∏–≥—Ä–∞ –Ω–∞—á–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑ 3 –º–∏–Ω—É—Ç—ã —Å —Ç–µ–º–∏, –∫—Ç–æ —É—Å–ø–µ–µ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è (–º–∏–Ω–∏–º—É–º 4 –∏–≥—Ä–æ–∫–∞)",
            reply_markup=keyboard,
            parse_mode=ParseMode.MARKDOWN
        )
    
    elif data.startswith("player_mode_"):
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –Ω–∞–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–æ–≤
        parts = data.split('_')
        mode = parts[2]  # exact –∏–ª–∏ timer
        game_type = parts[3]  # premium –∏–ª–∏ free
        is_premium = (game_type == "premium")
        
        logger.info(f"[DEBUG] –í—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º: {mode}, —Ç–∏–ø –∏–≥—Ä—ã: {game_type}")
        
        if mode == "timer":
            # –†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏ - —Å–æ–∑–¥–∞–µ–º –∏–≥—Ä—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–ª–æ—Ç–æ–≤
            max_players = 20 if is_premium else 8
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –≤–µ–¥—É—â–µ–≥–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤—Ä–µ–º–µ–Ω–∏
            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("üë§ –Ø –≤–µ–¥—É—â–∏–π", 
                                    callback_data=f"timer_host_human_{game_type}")],
                [InlineKeyboardButton("ü§ñ –ë–æ—Ç-–≤–µ–¥—É—â–∏–π", 
                                    callback_data=f"timer_host_bot_{game_type}")],
                [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"game_type_{game_type}")]
            ])
            
            await query.edit_message_text(
                f"‚è±Ô∏è **–†–µ–∂–∏–º –≤—Ä–µ–º–µ–Ω–∏ (3 –º–∏–Ω—É—Ç—ã)**\n\n"
                f"–ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤: {max_players}\n"
                f"–ú–∏–Ω–∏–º—É–º –¥–ª—è —Å—Ç–∞—Ä—Ç–∞: 4 –∏–≥—Ä–æ–∫–∞\n\n"
                f"–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–µ–¥—É—â–µ–≥–æ:",
                reply_markup=keyboard,
                parse_mode=ParseMode.MARKDOWN
            )
        
        elif mode == "exact":
            # –¢–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–≤–æ–¥ —á–∏—Å–ª–∞
            context.user_data['game_setup_state'] = 'waiting_player_count'
            context.user_data['game_type'] = game_type
            
            if is_premium:
                keyboard = InlineKeyboardMarkup([
                    [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"game_type_{game_type}")]
                ])
                await query.edit_message_text(
                    "üíé **–ü—Ä–µ–º–∏—É–º —Ä–µ–∂–∏–º - –¢–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ**\n\n"
                    "üìù **–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (4-20):**\n\n"
                    "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ü–∏—Ñ—Ä–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: `6`\n\n"
                    "üí° –î–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ä–æ–ª–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏:\n"
                    "‚Ä¢ –í–µ–¥—É—â–∏–π - –≤—ã –∏–ª–∏ –±–æ—Ç\n"
                    "‚Ä¢ –í—Å–µ —Ä–æ–ª–∏ (–î–æ–Ω –ú–∞—Ñ–∏–∏, –ú–∞–Ω—å—è–∫, –ü—É—Ç–∞–Ω–∞ –∏ –¥—Ä.)\n"
                    "‚Ä¢ –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π",
                    reply_markup=keyboard,
                    parse_mode=ParseMode.MARKDOWN
                )
            else:
                keyboard = InlineKeyboardMarkup([
                    [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"game_type_{game_type}")]
                ])
                await query.edit_message_text(
                    "üéÆ **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º - –¢–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ**\n\n"
                    "üìù **–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (4-8):**\n\n"
                    "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ü–∏—Ñ—Ä–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: `5`\n\n"
                    "üéØ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞:\n"
                    "‚Ä¢ –ë–∞–∑–æ–≤—ã–µ —Ä–æ–ª–∏ (–ú–∞—Ñ–∏–æ–∑–∏, –ö–æ–º–∏—Å—Å–∞—Ä, –î–æ–∫—Ç–æ—Ä, –ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å)\n"
                    "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π",
                    reply_markup=keyboard,
                    parse_mode=ParseMode.MARKDOWN
                )
    
    elif data.startswith("timer_host_"):
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–µ–¥—É—â–µ–≥–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ –≤—Ä–µ–º–µ–Ω–∏
        parts = data.split('_')
        host_type = parts[2]  # human –∏–ª–∏ bot
        game_type = parts[3]  # premium –∏–ª–∏ free
        is_premium = (game_type == "premium")
        
        max_players = 20 if is_premium else 8
        
        # –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∏–≥—Ä—ã —Å —Ç–∞–π–º–µ—Ä–æ–º
        context.user_data['new_game_pending_settings'] = {
            'num_players': max_players,
            'game_mode': f'{host_type}_host_timer',
            'host_id': query.from_user.id,
            'host_name': query.from_user.full_name or '–ê–Ω–æ–Ω–∏–º',
            'version': 'premium' if is_premium else 'free',
            'role_setup_method': 'auto'
        }
        
        await query.answer("–°–æ–∑–¥–∞—é –∏–≥—Ä—É —Å —Ç–∞–π–º–µ—Ä–æ–º...")
        await create_timer_game_from_pending_settings(query, context, context.user_data['new_game_pending_settings'])
    
    elif data.startswith("game_mode_"):
        logger.info(f"[DEBUG] –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã: {data}")
        
        # –†–∞–∑–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        parts = data.split('_')
        num_players = int(parts[2])
        mode = parts[3]  # human, bot
        is_free = len(parts) > 4 and parts[4] == 'free'
        
        logger.info(f"[DEBUG] –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: {num_players} –∏–≥—Ä–æ–∫–æ–≤, —Ä–µ–∂–∏–º: {mode}, –±–µ—Å–ø–ª–∞—Ç–Ω–æ: {is_free}")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã
        context.user_data['new_game_pending_settings'] = {
            'num_players': num_players,
            'game_mode': f'{mode}_host',
            'host_id': query.from_user.id,
            'host_name': query.from_user.full_name or '–ê–Ω–æ–Ω–∏–º',
            'version': 'free' if is_free else 'paid'
        }

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π
        callback_prefix = "ng_bh" if mode == 'bot' else "ng"
        
        # –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
        if is_free:
            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ", 
                                    callback_data=f"{callback_prefix}_roles_auto")]
            ])
            
            mode_text = '–í–µ–¥—É—â–∏–π - –ë–æ—Ç' if mode == 'bot' else '–í–µ–¥—É—â–∏–π - –Ø'
            message_text = (
                f"üéÆ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ–≤–æ–π –∏–≥—Ä—ã (–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º)**\n\n"
                f"**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:** {num_players}\n"
                f"**–†–µ–∂–∏–º:** {mode_text}\n"
                f"**–†–æ–ª–∏:** –ú–∞—Ñ–∏–æ–∑–∏, –ö–æ–º–∏—Å—Å–∞—Ä, –î–æ–∫—Ç–æ—Ä, –ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å\n\n"
                f"–í –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π:"
            )
        else:
            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ", 
                                    callback_data=f"{callback_prefix}_roles_auto")],
                [InlineKeyboardButton("‚úçÔ∏è –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π", 
                                    callback_data=f"{callback_prefix}_roles_manual")]
            ])
            
            mode_text = '–í–µ–¥—É—â–∏–π - –ë–æ—Ç' if mode == 'bot' else '–í–µ–¥—É—â–∏–π - –Ø'
            message_text = (
                f"üéÆ **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ–≤–æ–π –∏–≥—Ä—ã (–ü—Ä–µ–º–∏—É–º —Ä–µ–∂–∏–º)**\n\n"
                f"**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:** {num_players}\n"
                f"**–†–µ–∂–∏–º:** {mode_text}\n\n"
                f"–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π:"
            )
        
        await query.edit_message_text(
            message_text,
            reply_markup=keyboard,
            parse_mode=ParseMode.MARKDOWN
        )
    
    elif data.startswith("ng_"):
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ–ª–µ–π
        parts = data.split('_')
        pending_settings = context.user_data.get('new_game_pending_settings')
        if not pending_settings:
            await query.answer("–û—à–∏–±–∫–∞: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.", show_alert=True)
            return
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        if len(parts) == 3 and parts[1] == "roles" and parts[2] == "auto":
            # ng_roles_auto
            action = "roles_auto"
        elif len(parts) == 4 and parts[1] == "bh" and parts[2] == "roles" and parts[3] == "auto":
            # ng_bh_roles_auto
            action = "bh_roles_auto"
        elif len(parts) == 3 and parts[1] == "roles" and parts[2] == "manual":
            # ng_roles_manual
            action = "roles_manual"
        elif len(parts) == 4 and parts[1] == "bh" and parts[2] == "roles" and parts[3] == "manual":
            # ng_bh_roles_manual
            action = "bh_roles_manual"
        else:
            await query.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã.", show_alert=True)
            return
        
        if action == "roles_auto":
            pending_settings['role_setup_method'] = 'auto'
            await query.answer("–í—ã–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π.")
            await create_game_from_pending_settings(query, context, pending_settings)
            return
        
        elif action == "bh_roles_auto":
            if pending_settings.get('game_mode') != 'bot_host':
                await query.answer("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (–ë–æ—Ç-–í–µ–¥—É—â–∏–π).", show_alert=True)
                return
            pending_settings['role_setup_method'] = 'auto'
            await query.answer("–í—ã–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π –¥–ª—è –ë–æ—Ç–∞-–í–µ–¥—É—â–µ–≥–æ.")
            await create_game_from_pending_settings(query, context, pending_settings)
            return
        
        elif action in ["roles_manual", "bh_roles_manual"]:
            # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ä–æ–ª–µ–π
            await query.answer("–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ä–æ–ª–µ–π...")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            context.user_data['pending_game_setup'] = {
                'host_id': pending_settings['host_id'],
                'total_players': pending_settings['num_players'],
                'current_roles': {role: 0 for role in ALL_CONFIGURABLE_ROLES},
                'game_version': pending_settings['version'],
                'game_mode': pending_settings['game_mode']
            }
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            if 'new_game_pending_settings' in context.user_data:
                del context.user_data['new_game_pending_settings']
            
            await send_role_config_message(query, context, is_edit=True)
            return
    
    elif data.startswith("join_game_"):
        game_id = data[10:]  # –£–±–∏—Ä–∞–µ–º "join_game_"
        
        # –ò–º–∏—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç update –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ join_game
        class FakeUpdate:
            def __init__(self, user):
                self.effective_user = user
                self.message = query.message
        
        fake_update = FakeUpdate(user)
        await join_game(fake_update, context, game_id)
    
    elif data.startswith("copy_link_"):
        game_id = data[10:]  # –£–±–∏—Ä–∞–µ–º "copy_link_"
        
        if game_id not in games:
            await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
            return
            
        game = games[game_id]
        
        try:
            bot_info = await context.bot.get_me()
            original_bot_username = bot_info.username
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
            bot_username = str(original_bot_username)
            logger.info(f"[DEBUG] copy_link: bot_info –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ")
            logger.info(f"[DEBUG] copy_link: original username = '{original_bot_username}'")
            logger.info(f"[DEBUG] copy_link: processed username = '{bot_username}'")
            logger.info(f"[DEBUG] copy_link: username equals Mafia_IRL_Bot: {bot_username == 'Mafia_IRL_Bot'}")
        except Exception as e:
            logger.error(f"[ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Å—ã–ª–∫–∏ –≤ copy_link: {e}")
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –±–æ—Ç–∞ –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ä–µ–∑–µ—Ä–≤–∞
            bot_username = "Mafia_IRL_Bot"
            logger.info(f"[DEBUG] copy_link: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∏–º—è –±–æ—Ç–∞: @{bot_username}")
            await query.answer("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞", show_alert=False)
        
        # –Ø–≤–Ω–æ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
        safe_bot_username = str(bot_username)
        telegram_link = f"https://t.me/{safe_bot_username}?start=join_{game_id}"
        
        logger.info(f"[DEBUG] copy_link: safe_bot_username = '{safe_bot_username}'")
        logger.info(f"[DEBUG] copy_link: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞: {telegram_link}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–≥—Ä—ã –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
        version = game.get('game_version', 'paid')
        game_mode = game.get('game_mode', 'human_host')
        host_name = game.get('host_name', '–ê–Ω–æ–Ω–∏–º')
        
        # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
        if game.get('state') == STATE_TIMER_WAITING:
            # –î–ª—è —Ç–∞–π–º–µ—Ä-–∏–≥—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ/–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ
            current_players = sum(1 for slot in game['players_slots'] if slot.get('user_id'))
            max_players = game.get('max_players', 20)
            players_text = f"{current_players}/{max_players}"
        else:
            # –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∏–≥—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            num_players = game.get('num_players', 6)
            players_text = str(num_players)
        
        if version == 'free':
            game_type_emoji = "üÜì"
            game_type_text = "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞"
            if game_mode in ['bot_host', 'bot_host_timer']:
                host_text = "ü§ñ –í–µ–¥—É—â–∏–π - –ë–æ—Ç"
            else:
                host_text = "üë§ –í–µ–¥—É—â–∏–π - –Ø"
        else:
            game_type_emoji = "üíé"
            game_type_text = "–ü—Ä–µ–º–∏—É–º –∏–≥—Ä–∞"
            if game_mode in ['bot_host', 'bot_host_timer']:
                host_text = "ü§ñ –í–µ–¥—É—â–∏–π - –ë–æ—Ç"
            else:
                host_text = "üë§ –í–µ–¥—É—â–∏–π - –Ø"
        
        # –ö—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ)
        share_message = (
            f"{game_type_emoji} {game_type_text} –≤ –ú–∞—Ñ–∏—é!\n\n"
            f"üé≠ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∏–≥—Ä–µ!\n"
            f"üë• –ò–≥—Ä–æ–∫–æ–≤: {players_text}\n"
            f"üëë –°–æ–∑–¥–∞—Ç–µ–ª—å: {host_name}\n"
            f"{host_text}\n"
            f"üÜî ID –∏–≥—Ä—ã: {game_id}\n\n"
            f"üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:\n"
            f"{telegram_link}\n\n"
            f"üì§ –ü–µ—Ä–µ—à–ª–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥—Ä—É–∑—å—è–º –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ –∏–≥—Ä—É"
        )
        
        logger.info(f"[DEBUG] –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏:")
        logger.info(f"[DEBUG] {share_message}")
        logger.info(f"[DEBUG] –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è —Å—Å—ã–ª–∫–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏: {telegram_link}")
        logger.info(f"[DEBUG] –ò—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ –∏–º—è –±–æ—Ç–∞ –≤ —Ç–µ–∫—Å—Ç–µ: @{safe_bot_username}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ë–ï–ó markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        await context.bot.send_message(
            query.from_user.id,
            share_message,
            parse_mode=None,  # –£–±–∏—Ä–∞–µ–º markdown
            disable_web_page_preview=True  # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Å—ã–ª–æ–∫
        )
        
        await query.answer("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
    
    elif data.startswith("timer_status_"):
        game_id = data[13:]  # –£–±–∏—Ä–∞–µ–º "timer_status_"
        
        if game_id not in games:
            await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
            return
            
        game = games[game_id]
        
        if game.get('state') != STATE_TIMER_WAITING:
            await query.answer("–≠—Ç–∞ –∏–≥—Ä–∞ —É–∂–µ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞", show_alert=True)
            return
            
        current_players = sum(1 for slot in game['players_slots'] if slot.get('user_id'))
        max_players = game.get('max_players', 6)
        
        # –°—á–∏—Ç–∞–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
        from datetime import datetime, timedelta
        timer_started = game.get('timer_started_at')
        if isinstance(timer_started, str):
            # –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞, –ø–∞—Ä—Å–∏–º –µ–≥–æ
            try:
                timer_started = datetime.strptime(timer_started, "%Y-%m-%d %H:%M:%S")
            except:
                timer_started = datetime.now() - timedelta(minutes=1)  # –ó–∞–≥–ª—É—à–∫–∞
        
        elapsed_time = datetime.now() - timer_started
        remaining_time = timedelta(minutes=3) - elapsed_time
        
        if remaining_time.total_seconds() <= 0:
            remaining_text = "–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ! –ò–≥—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ –Ω–∞—á–∞—Ç—å—Å—è."
        else:
            remaining_minutes = int(remaining_time.total_seconds() // 60)
            remaining_seconds = int(remaining_time.total_seconds() % 60)
            remaining_text = f"{remaining_minutes}:{remaining_seconds:02d}"
        
        status_message = (
            f"‚è∞ –°—Ç–∞—Ç—É—Å —Ç–∞–π–º–µ—Ä-–∏–≥—Ä—ã {game_id}\n\n"
            f"üë• –ò–≥—Ä–æ–∫–æ–≤ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–æ—Å—å: {current_players}/{max_players}\n"
            f"‚è±Ô∏è –û—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è: {remaining_text}\n"
            f"üéØ –ú–∏–Ω–∏–º—É–º –¥–ª—è —Å—Ç–∞—Ä—Ç–∞: 4 –∏–≥—Ä–æ–∫–∞\n\n"
            f"üìà –ò–≥—Ä–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –°–¢–†–û–ì–û —á–µ—Ä–µ–∑ 3 –º–∏–Ω—É—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤."
        )
        
        try:
            await query.edit_message_text(
                status_message,
                parse_mode=None,
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"timer_status_{game_id}")],
                    [InlineKeyboardButton("üìã –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–≥—Ä–æ–π", callback_data=f"copy_link_{game_id}")]
                ])
            )
        except Exception as e:
            if "Message is not modified" in str(e):
                await query.answer("‚è∞ –°—Ç–∞—Ç—É—Å —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω")
            else:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Ç–∞–π–º–µ—Ä–∞: {e}")
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞")
    
    elif data == "rules":
        await show_roles_selection_menu(query)
    
    elif data == "show_all_roles":
        await show_all_roles_with_buttons(query)
    
    elif data.startswith("role_detail_"):
        role_name = data[12:]  # –£–±–∏—Ä–∞–µ–º "role_detail_"
        await show_role_details(query, role_name)
    
    elif data == "show_full_rules":
        await show_full_rules_text_interface(query)
    
    elif data == "activate_demo":
        # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –¥–µ–º–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
        user_id = query.from_user.id
        
        if not premium_db.can_activate_demo(user_id):
            is_premium, status = premium_db.check_premium_status(user_id)
            user_data = premium_db.get_user_info(user_id)
            
            if user_data and user_data.get("demo_used", False):
                await query.answer("‚ùå –í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—é", show_alert=True)
            elif is_premium:
                await query.answer("‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞", show_alert=True)
            return
        
        success, message = premium_db.activate_demo(user_id)
        
        if success:
            await query.edit_message_text(
                f"{message}\n\n"
                "üéÆ **–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ–º–∏—É–º-—Ñ—É–Ω–∫—Ü–∏–∏:**\n"
                "‚Ä¢ –ò–≥—Ä—ã –æ—Ç 4 –¥–æ 20 –∏–≥—Ä–æ–∫–æ–≤ (–≤–º–µ—Å—Ç–æ 8)\n"
                "‚Ä¢ –í—Å–µ —Ä–æ–ª–∏ (–î–æ–Ω –ú–∞—Ñ–∏–∏, –ú–∞–Ω—å—è–∫, –ü—É—Ç–∞–Ω–∞ –∏ –¥—Ä.)\n"
                "‚Ä¢ –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π\n"
                "‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
                "‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n\n"
                "üí° **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É –Ω–∞ 10+ –∏–≥—Ä–æ–∫–æ–≤!**\n\n"
                "üíé –ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å? –ü–æ–ª—É—á–∏—Ç–µ –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø: /premium",
                parse_mode='Markdown',
                reply_markup=InlineKeyboardMarkup([[
                    InlineKeyboardButton("üéÆ –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º –∏–≥—Ä—É", callback_data="create_game"),
                    InlineKeyboardButton("üíé –ö—É–ø–∏—Ç—å Premium", callback_data="get_premium")
                ]])
            )
        else:
            await query.answer(f"‚ùå {message}", show_alert=True)
    
    elif data == "get_premium":
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∫—É–ø–∫–∏ –ø—Ä–µ–º–∏—É–º–∞
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üí≥ –ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º (299‚ÇΩ)", callback_data="buy_premium")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")]
        ])
        
        await query.edit_message_text(
            "üíé **–ü—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–∏:**\n\n"
            "‚Ä¢ **üé≠ –í—Å–µ —Ä–æ–ª–∏** (–î–æ–Ω –ú–∞—Ñ–∏–∏, –ú–∞–Ω—å—è–∫, –ü—É—Ç–∞–Ω–∞ –∏ –¥—Ä.)\n"
            "‚Ä¢ **üë• –î–æ 20 –∏–≥—Ä–æ–∫–æ–≤** –≤ –æ–¥–Ω–æ–π –∏–≥—Ä–µ (–≤–º–µ—Å—Ç–æ 8)\n"
            "‚Ä¢ **‚öôÔ∏è –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π**\n"
            "‚Ä¢ **üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**\n\n"
            "üí° **–ë–æ—Ç-–≤–µ–¥—É—â–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω –ë–ï–°–ü–õ–ê–¢–ù–û!**\n\n"
            f"**–¶–µ–Ω–∞: {PREMIUM_PRICE_RUBLES}‚ÇΩ**",
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=keyboard
        )
    
    elif data == "buy_premium":
        await handle_premium_purchase(update, context)
    
    elif data == "back_to_main":
        text, keyboard = get_start_message_text_and_keyboard()
        await query.edit_message_text(text, parse_mode=ParseMode.MARKDOWN, reply_markup=keyboard)
    
    elif data.startswith("leave_game_"):
        game_id = data[11:]  # –£–±–∏—Ä–∞–µ–º "leave_game_"
        
        # –£–¥–∞–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –∏–∑ –∏–≥—Ä—ã
        await remove_player_from_game(user.id, game_id, context)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        await query.edit_message_text(
            "‚úÖ **–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∏–≥—Ä—É!**\n\n"
            "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –¥—Ä—É–≥–æ–π.",
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üéÆ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É", callback_data="create_game")],
                [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
            ])
        )

    elif data.startswith("cfg_"):
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ–ª–µ–π
        pending_setup = context.user_data.get('pending_game_setup')
        if not pending_setup or pending_setup.get('host_id') != user.id:
            await query.answer("–≠—Ç–æ –Ω–µ –≤–∞—à–∞ —Å–µ—Å—Å–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã –∏–ª–∏ –æ–Ω–∞ –∏—Å—Ç–µ–∫–ª–∞.", show_alert=True)
            return
        
        parts = data.split('_')
        action = parts[1]
        role_name = parts[2] if len(parts) > 2 else None
        
        current_roles = pending_setup.get('current_roles', {})
        total_players = pending_setup.get('total_players', 0)
        current_assigned = sum(current_roles.values())
        
        if action == "inc" and role_name:
            if current_assigned < total_players:
                current_roles[role_name] = current_roles.get(role_name, 0) + 1
                await query.answer(f"{role_name} +1")
            else:
                await query.answer(f"–£–∂–µ –≤—ã–±—Ä–∞–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–æ–ª–µ–π ({total_players})!", show_alert=True)
            await send_role_config_message(query, context, is_edit=True)
            return
        
        elif action == "dec" and role_name:
            if current_roles.get(role_name, 0) > 0:
                current_roles[role_name] = current_roles.get(role_name, 0) - 1
                await query.answer(f"{role_name} -1")
            else:
                await query.answer(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ {role_name} —É–∂–µ 0.")
            await send_role_config_message(query, context, is_edit=True)
            return
        
        elif action == "reset":
            pending_setup['current_roles'] = {role: 0 for role in ALL_CONFIGURABLE_ROLES}
            await query.answer("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–æ–ª–µ–π —Å–±—Ä–æ—à–µ–Ω–∞.")
            await send_role_config_message(query, context, is_edit=True)
            return
        
        elif action == "cancel":
            await query.answer("–°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã –æ—Ç–º–µ–Ω–µ–Ω–æ.")
            await query.edit_message_text("–°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä—ã –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=None)
            if 'pending_game_setup' in context.user_data: 
                del context.user_data['pending_game_setup']
            return
        
        elif action == "confirm":
            if current_assigned != total_players:
                await query.answer(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π ({current_assigned}) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏–≥—Ä–æ–∫–æ–≤ ({total_players})!", show_alert=True)
                return
            
            await query.answer("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ! –°–æ–∑–¥–∞—é –∏–≥—Ä—É...")
            
            # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–µ–π
            final_roles_list = []
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–æ–ª–∏ –≤ —Å–ø–∏—Å–æ–∫
            for role_name, count in current_roles.items():
                if count > 0:
                    final_roles_list.extend([role_name] * count)
            
            # –ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–µ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
            for _ in range(5):
                random.shuffle(final_roles_list)
            
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ random.sample
            final_roles_list = random.sample(final_roles_list, len(final_roles_list))
            
            logger.info(f"[DEBUG] –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π (—Å–ª—É—á–∞–π–Ω–æ–µ): {final_roles_list}")
            
            # –°–æ–∑–¥–∞–µ–º –∏–≥—Ä—É —Å —Ä—É—á–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
            await create_game_with_manual_roles(query, context, pending_setup, final_roles_list)
            return
    
    elif data.startswith("role_info_"):
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–æ–ª–∏
        role_name = data[10:]  # –£–±–∏—Ä–∞–µ–º "role_info_"
        role_data = ROLES_DATA.get(role_name, {})
        if role_data:
            # –°–æ–∫—Ä–∞—â–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–∫–∏ Message_too_long
            description = role_data.get('description', '–ù/–î')[:100]
            goal = role_data.get('goal', '–ù/–î')[:80]
            actions = role_data.get('actions', '–ù/–î')[:80]
            
            info_text = (
                f"{role_name}\n\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ: {description}...\n\n"
                f"–¶–µ–ª—å: {goal}\n\n"
                f"–î–µ–π—Å—Ç–≤–∏—è: {actions}"
            )
        else:
            info_text = f"{role_name}\n\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–æ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞."
        
        await query.answer(info_text, show_alert=True)
        return
    
    elif data == "ignore":
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ callback (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏)
        await query.answer()
        return

    elif data.startswith("host_type_"):
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≤–µ–¥—É—â–µ–≥–æ –¥–ª—è –ø—Ä–µ–º–∏—É–º –∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        try:
            parts = data.split('_')
            host_type = parts[2]  # human, bot –∏–ª–∏ timer
            num_players = int(parts[3])
            is_free = len(parts) > 4 and parts[4] == 'free'
            
            logger.info(f"[DEBUG] –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≤–µ–¥—É—â–µ–≥–æ: {host_type} –¥–ª—è {num_players} –∏–≥—Ä–æ–∫–æ–≤, free: {is_free}")
        except Exception as e:
            logger.error(f"[ERROR] –û—à–∏–±–∫–∞ –≤ host_type_ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ: {e}")
            await query.answer("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏", show_alert=True)
            return
        
        # –î–ª—è —Ä–µ–∂–∏–º–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–µ–º –∏–≥—Ä—É –æ—Å–æ–±—ã–º —Å–ø–æ—Å–æ–±–æ–º
        if host_type == 'timer':
            context.user_data['new_game_pending_settings'] = {
                'num_players': num_players,
                'game_mode': 'bot_host_timer',
                'host_id': query.from_user.id,
                'host_name': query.from_user.full_name or '–ê–Ω–æ–Ω–∏–º',
                'version': 'free' if is_free else 'paid',
                'role_setup_method': 'auto'
            }
            
            # –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ–º –∏–≥—Ä—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            await query.answer("–°–æ–∑–¥–∞—é –∏–≥—Ä—É —Å —Ç–∞–π–º–µ—Ä–æ–º...")
            await create_timer_game_from_pending_settings(query, context, context.user_data['new_game_pending_settings'])
            return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã (–æ–±—ã—á–Ω—ã–µ —Ä–µ–∂–∏–º—ã)
        context.user_data['new_game_pending_settings'] = {
            'num_players': num_players,
            'game_mode': f'{host_type}_host',
            'host_id': query.from_user.id,
            'host_name': query.from_user.full_name or '–ê–Ω–æ–Ω–∏–º',
            'version': 'free' if is_free else 'paid'
        }

        # –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
        if is_free:
            context.user_data['new_game_pending_settings']['role_setup_method'] = 'auto'
            await query.answer("–°–æ–∑–¥–∞—é –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∏–≥—Ä—É...")
            await create_game_from_pending_settings(query, context, context.user_data['new_game_pending_settings'])
            return

        # –î–ª—è –ø—Ä–µ–º–∏—É–º —Ä–µ–∂–∏–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π
        callback_prefix = "ng_bh" if host_type == 'bot' else "ng"
        
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ", 
                                callback_data=f"{callback_prefix}_roles_auto")],
            [InlineKeyboardButton("‚úçÔ∏è –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π", 
                                callback_data=f"{callback_prefix}_roles_manual")]
        ])
        
        host_name = '–ë–æ—Ç' if host_type == 'bot' else '–ß–µ–ª–æ–≤–µ–∫'
        message_text = (
            f"üíé **–ü—Ä–µ–º–∏—É–º –∏–≥—Ä–∞ –Ω–∞ {num_players} –∏–≥—Ä–æ–∫–æ–≤**\n\n"
            f"**–í–µ–¥—É—â–∏–π:** {host_name}\n\n"
            f"–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π:"
        )
        
        await query.edit_message_text(
            message_text,
            reply_markup=keyboard,
            parse_mode=ParseMode.MARKDOWN
        )

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –≤ –∏–≥—Ä–µ —Å –±–æ—Ç–æ–º-–≤–µ–¥—É—â–∏–º
    elif data.startswith("vote_") and not data.startswith("vote_confirmed_"):
        parts = data.split("_")
        if len(parts) >= 3:
            if parts[1] == "skip":
                # –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –ø—Ä–æ–ø—É—Å–∫
                game_id = "_".join(parts[2:])
                await handle_vote_skip(query, context, game_id)
            else:
                # –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                try:
                    game_id = "_".join(parts[1:-1])
                    player_index = int(parts[-1])
                    await handle_vote_player(query, context, game_id, player_index)
                except (ValueError, IndexError) as e:
                    await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è", show_alert=True)
                    logger.error(f"Error parsing vote callback: {e}")

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    elif data.startswith("skip_first_day_"):
        game_id = data.replace("skip_first_day_", "")
        await handle_skip_first_day(query, context, game_id)

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "—É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞ –ø—Ä–æ–ø—É—Å–∫"
    elif data.startswith("already_voted_skip_"):
        await query.answer("‚úÖ –í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –¥–Ω—è", show_alert=False)

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –∏–≥—Ä–æ–∫–∞
    elif data.startswith("confirm_vote_"):
        parts = data.split("_")
        if len(parts) >= 3:
            try:
                player_index = int(parts[-1])
                game_id = "_".join(parts[2:-1])
                await handle_confirm_vote(query, context, game_id, player_index)
            except (ValueError, IndexError) as e:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è", show_alert=True)
                logger.error(f"Error parsing confirm vote callback: {e}")

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    elif data.startswith("confirm_skip_"):
        game_id = data.replace("confirm_skip_", "")
        await handle_confirm_skip(query, context, game_id)

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    elif data.startswith("return_to_voting_"):
        game_id = data.replace("return_to_voting_", "")
        await handle_return_to_voting(query, context, game_id)

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–≥–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω"
    elif data.startswith("vote_confirmed_"):
        await query.answer("‚úÖ –í–∞—à –≥–æ–ª–æ—Å —É–∂–µ –∑–∞—Å—á–∏—Ç–∞–Ω", show_alert=False)
    
    # === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ß–ï–õ–û–í–ï–ö–û–ú-–í–ï–î–£–©–ò–ú ===
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    elif data.startswith("night_"):
        game_id = data.replace("night_", "")
        if game_id in games:
            await set_night_action(game_id, games[game_id], query, context)
    
    elif data.startswith("day_"):
        game_id = data.replace("day_", "")
        if game_id in games:
            await set_day_action(game_id, games[game_id], query, context)
    
    elif data.startswith("status_"):
        game_id = data.replace("status_", "")
        if game_id in games:
            await game_status_action(game_id, games[game_id], query, context)
    
    elif data.startswith("end_"):
        game_id = data.replace("end_", "")
        if game_id in games:
            await end_game_action(game_id, games[game_id], query, context)
    
    elif data.startswith("manage_"):
        game_id = data.replace("manage_", "")
        if game_id in games:
            await query.edit_message_text(f"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π {game_id}:", 
                                        reply_markup=get_main_control_keyboard(game_id))
    
    # –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
    elif data.startswith("show_elim_list_"):
        game_id = data.replace("show_elim_list_", "")
        if game_id in games:
            await query.edit_message_text(f"–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –∏–≥—Ä—ã {game_id}:", 
                                        reply_markup=get_player_elimination_keyboard(game_id, games[game_id]))
    
    elif data.startswith("elim_"):
        parts = data.split("_")
        if len(parts) >= 3:
            game_id = "_".join(parts[1:-1])
            player_num = int(parts[-1])
            if game_id in games:
                await eliminate_player_action(game_id, games[game_id], player_num, query, context)
    
    # –ù–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    elif data.startswith("night_role_turn_"):
        parts = data.replace("night_role_turn_", "").split("_", 1)
        if len(parts) == 2:
            game_id, role = parts
            if game_id in games:
                await query.edit_message_text(f"–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –¥–ª—è —Ä–æ–ª–∏ {role}:", 
                                            reply_markup=get_player_selection_keyboard_for_night_action(game_id, games[game_id], role))
    
    elif data.startswith("night_action_"):
        parts = data.replace("night_action_", "").split("_")
        if len(parts) >= 3:
            game_id = "_".join(parts[:-2])
            role = parts[-2]
            target_num = int(parts[-1])
            if game_id in games:
                game_data = games[game_id]
                night_data = game_data.get("night_data", {})
                night_data["actions_taken_by_role"][role] = target_num
                night_data["acted_roles"].add(role)
                games[game_id] = game_data
                
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–æ—á–Ω–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
                message = f"üåÉ –ù–æ—á—å {game_data['current_night_number']} –≤ –∏–≥—Ä–µ {game_id}. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π:"
                await query.edit_message_text(text=message, reply_markup=get_night_host_keyboard(game_id, game_data))
                await query.answer(f"{role} –≤—ã–±—Ä–∞–ª —Ü–µ–ª—å {target_num}")
    
    elif data.startswith("night_return_to_main_"):
        game_id = data.replace("night_return_to_main_", "")
        if game_id in games:
            game_data = games[game_id]
            message = f"üåÉ –ù–æ—á—å {game_data['current_night_number']} –≤ –∏–≥—Ä–µ {game_id}. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π:"
            await query.edit_message_text(text=message, reply_markup=get_night_host_keyboard(game_id, game_data))
    
    elif data.startswith("night_end_"):
        game_id = data.replace("night_end_", "")
        if game_id in games:
            game_data = games[game_id]
            await resolve_night_actions_and_announce_day(game_id, game_data, query, context)
    
    elif data.startswith("night_info_"):
        await query.answer("–î–µ–π—Å—Ç–≤–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ", show_alert=False)
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–• –ü–†–ò–ú–ï–†–û–í ===
    elif data.startswith("math_answer_"):
        # –†–∞–∑–±–∏—Ä–∞–µ–º callback: math_answer_{game_id}_{user_id}_{selected_answer}
        parts = data.split("_")
        if len(parts) >= 4:
            try:
                # –°–æ–±–∏—Ä–∞–µ–º game_id –æ–±—Ä–∞—Ç–Ω–æ (–º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å underscores)
                game_id_start_index = 2
                user_id_index = -2
                answer_index = -1
                
                user_id = int(parts[user_id_index])
                selected_answer = int(parts[answer_index])
                game_id = "_".join(parts[game_id_start_index:user_id_index])
                
                await handle_math_button_answer(query, context, game_id, user_id, selected_answer)
            except (ValueError, IndexError) as e:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞", show_alert=True)
                logger.error(f"Error parsing math answer callback: {e}")
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê –ñ–ï–†–¢–í–´ –ú–ê–§–ò–ï–ô ===
    elif data.startswith("mafia_target_"):
        # –†–∞–∑–±–∏—Ä–∞–µ–º callback: mafia_target_{game_id}_{target_index}
        parts = data.split("_")
        if len(parts) >= 3:
            try:
                target_index = int(parts[-1])
                game_id = "_".join(parts[2:-1])
                
                await handle_mafia_target_selection(query, context, game_id, target_index)
            except (ValueError, IndexError) as e:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏", show_alert=True)
                logger.error(f"Error parsing mafia target callback: {e}")
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê –¶–ï–õ–ò –î–û–ö–¢–û–†–ê ===
    elif data.startswith("doctor_target_"):
        parts = data.split("_")
        if len(parts) >= 3:
            try:
                target_index = int(parts[-1])
                game_id = "_".join(parts[2:-1])
                
                await handle_doctor_target_selection(query, context, game_id, target_index)
            except (ValueError, IndexError) as e:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏", show_alert=True)
                logger.error(f"Error parsing doctor target callback: {e}")
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –í–´–ë–û–†–ê –î–û–ö–¢–û–†–ê ===
    elif data.startswith("confirm_doctor_"):
        parts = data.split("_")
        if len(parts) >= 3:
            try:
                target_index = int(parts[-1])
                game_id = "_".join(parts[2:-1])
                await handle_confirm_doctor(query, context, game_id, target_index)
            except (ValueError, IndexError) as e:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è", show_alert=True)
                logger.error(f"Error parsing confirm doctor callback: {e}")
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –í–û–ó–í–†–ê–¢–ê –ö –í–´–ë–û–†–£ –î–û–ö–¢–û–†–ê ===
    elif data.startswith("return_doctor_"):
        game_id = data.replace("return_doctor_", "")
        await handle_return_doctor(query, context, game_id)
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê –¶–ï–õ–ò –ö–û–ú–ò–°–°–ê–†–ê ===
    elif data.startswith("commissioner_target_"):
        parts = data.split("_")
        if len(parts) >= 3:
            try:
                target_index = int(parts[-1])
                game_id = "_".join(parts[2:-1])
                
                await handle_commissioner_target_selection(query, context, game_id, target_index)
            except (ValueError, IndexError) as e:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏", show_alert=True)
                logger.error(f"Error parsing commissioner target callback: {e}")
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê –¶–ï–õ–ò –ú–ê–ù–¨–Ø–ö–ê ===
    elif data.startswith("maniac_target_"):
        parts = data.split("_")
        if len(parts) >= 3:
            try:
                target_index = int(parts[-1])
                game_id = "_".join(parts[2:-1])
                
                await handle_maniac_target_selection(query, context, game_id, target_index)
            except (ValueError, IndexError) as e:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏", show_alert=True)
                logger.error(f"Error parsing maniac target callback: {e}")
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê –¶–ï–õ–ò –ü–£–¢–ê–ù–´ ===
    elif data.startswith("prostitute_target_"):
        parts = data.split("_")
        if len(parts) >= 3:
            try:
                target_index = int(parts[-1])
                game_id = "_".join(parts[2:-1])
                
                await handle_prostitute_target_selection(query, context, game_id, target_index)
            except (ValueError, IndexError) as e:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏", show_alert=True)
                logger.error(f"Error parsing prostitute target callback: {e}")
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –ü–†–û–ü–£–°–ö–ê –•–û–î–ê –î–û–ö–¢–û–†–ê ===
    elif data.startswith("doctor_skip_"):
        game_id = data[12:]  # –£–±–∏—Ä–∞–µ–º "doctor_skip_"
        await handle_doctor_skip(query, context, game_id)
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –ü–†–û–ü–£–°–ö–ê –•–û–î–ê –ú–ê–ù–¨–Ø–ö–ê ===
    elif data.startswith("maniac_skip_"):
        game_id = data[12:]  # –£–±–∏—Ä–∞–µ–º "maniac_skip_"
        await handle_maniac_skip(query, context, game_id)
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –ü–†–û–ü–£–°–ö–ê –•–û–î–ê –ü–£–¢–ê–ù–´ ===
    elif data.startswith("prostitute_skip_"):
        game_id = data[16:]  # –£–±–∏—Ä–∞–µ–º "prostitute_skip_"
        await handle_prostitute_skip(query, context, game_id)
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –†–ê–°–ö–†–´–¢–ò–Ø –†–û–õ–ò –£–ë–ò–¢–´–ú–ò ===
    elif data.startswith("reveal_role_") or data.startswith("hide_role_"):
        # –†–∞–∑–±–∏—Ä–∞–µ–º callback: reveal_role_{game_id}_{user_id} –∏–ª–∏ hide_role_{game_id}_{user_id}
        parts = data.split("_")
        if len(parts) >= 3:
            try:
                action = parts[0]  # reveal –∏–ª–∏ hide
                user_id = int(parts[-1])
                game_id = "_".join(parts[2:-1])
                
                await handle_role_reveal_choice(query, context, game_id, user_id, action == "reveal")
            except (ValueError, IndexError) as e:
                await query.answer("‚ùå –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —Ä–æ–ª–∏", show_alert=True)
                logger.error(f"Error parsing role reveal callback: {e}")
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –ü–ï–†–ï–•–û–î–ê –ö –î–ù–ï–í–ù–û–ú–£ –ì–û–õ–û–°–û–í–ê–ù–ò–Æ ===
    elif data.startswith("phase_next_day_"):
        game_id = data.replace("phase_next_day_", "")
        game_data = games.get(game_id)
        if not game_data:
            await query.answer("‚ùå –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
            return

        if game_data.get("state") != STATE_DAY:
            await query.answer("–°–µ–π—á–∞—Å –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–π—Ç–∏ –∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—é", show_alert=True)
            return

        # –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
        try:
            await query.edit_message_reply_markup(reply_markup=None)
        except Exception as e:
            logger.error(f"Error removing phase keyboard in game {game_id}: {e}")

        await start_day_voting(game_id, game_data, context)
    
    # === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ù–§–õ–ò–ö–¢–û–í –ò–ì–† ===
    
    elif data.startswith("leave_games_and_join_"):
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ—à–∏–ª –ø–æ–∫–∏–Ω—É—Ç—å —Ç–µ–∫—É—â–∏–µ –∏–≥—Ä—ã –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –Ω–æ–≤–æ–π
        target_game_id = data.replace("leave_games_and_join_", "")
        user_id = query.from_user.id
        
        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        active_sessions = await find_all_player_game_sessions(user_id)
        
        # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≤—Å–µ—Ö —Ç–µ–∫—É—â–∏—Ö –∏–≥—Ä
        left_games = []
        for session_game_id, _, _ in active_sessions:
            if session_game_id != target_game_id:  # –ù–µ —É–¥–∞–ª—è–µ–º –∏–∑ —Ü–µ–ª–µ–≤–æ–π –∏–≥—Ä—ã
                if await remove_player_from_game(user_id, session_game_id, context):
                    left_games.append(session_game_id)
        
        if left_games:
            left_game = left_games[0]  # –û–±—ã—á–Ω–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∏–≥—Ä–∞
            await query.edit_message_text(
                f"‚úÖ –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∏–≥—Ä—É: **{left_game}**\n\n"
                f"üé≠ –¢–µ–ø–µ—Ä—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∏–≥—Ä–µ **{target_game_id}**..."
            )
        
        # –¢–µ–ø–µ—Ä—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –Ω–æ–≤–æ–π –∏–≥—Ä–µ
        class FakeUpdate:
            def __init__(self, user):
                self.effective_user = user
                self.message = query.message
        
        fake_update = FakeUpdate(query.from_user)
        await join_game(fake_update, context, target_game_id)
    
    elif data == "cancel_join":
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ—à–∏–ª –æ—Å—Ç–∞—Ç—å—Å—è –≤ —Ç–µ–∫—É—â–µ–π –∏–≥—Ä–µ
        await query.edit_message_text(
            "‚úÖ –í—ã –æ—Å—Ç–∞–ª–∏—Å—å –≤ —Ç–µ–∫—É—â–µ–π –∏–≥—Ä–µ.\n\n"
            "üéÆ –î–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –Ω–æ–≤–æ–π –∏–≥—Ä–µ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ —É—á–∞—Å—Ç–∏–µ –≤ —Ç–µ–∫—É—â–µ–π."
        )
    
    # === –ö–û–ù–ï–¶ –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í ===
    
    else:
        await query.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞")

async def handle_vote_player(query, context: CallbackContext, game_id: str, player_index: int):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –∏–≥—Ä–æ–∫–∞ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º"""
    game_data = games.get(game_id)
    if not game_data or not game_data.get("voting_active"):
        await query.answer("–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ", show_alert=True)
        return
    
    voter_id = query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–æ–ª–æ—Å—É—é—â–∏–π —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∏–≥—Ä–µ
    voter_found = False
    voter_slot_index = None
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("user_id") == voter_id and slot.get("status") == STATUS_ACTIVE:
            voter_found = True
            voter_slot_index = i
            break
    
    if not voter_found:
        await query.answer("–í—ã –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–π –∏–≥—Ä–µ", show_alert=True)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¢–û–õ–¨–ö–û –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
    game_mode = game_data.get("game_mode", "human_host")
    if game_mode == "bot_host":
        voting_rights = game_data.get("day_voting_rights", {})
        player_key = f"player_{voter_slot_index}"
        has_voting_rights = voting_rights.get(player_key, True)
        
        if not has_voting_rights:
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–∞ –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –Ω–æ—á–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ", show_alert=True)
            return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –µ—â–µ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª
    if voter_id in game_data.get("votes", {}):
        await query.answer("–í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏", show_alert=True)
        return

    # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–≥—Ä–æ–∫–∞ –∑–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç—è—Ç –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å
    target_player_name = game_data["players_slots"][player_index]["fictional_name"]
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    current_votes = game_data.get("votes", {})
    vote_counts = {}
    for voted_for in current_votes.values():
        if voted_for == "skip":
            vote_counts["skip"] = vote_counts.get("skip", 0) + 1
        else:
            player_name = game_data["players_slots"][voted_for]["fictional_name"]
            vote_counts[player_name] = vote_counts.get(player_name, 0) + 1
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    confirmation_keyboard = [
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ", callback_data=f"confirm_vote_{game_id}_{player_index}")],
        [InlineKeyboardButton("üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É", callback_data=f"return_to_voting_{game_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(confirmation_keyboard)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
    confirmation_message = (
        f"üó≥Ô∏è **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è**\n\n"
        f"üéØ –í—ã –≤—ã–±—Ä–∞–ª–∏: **{target_player_name}**\n\n"
        f"üìä **–¢–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞:**\n"
    )
    
    if vote_counts:
        for candidate, votes in vote_counts.items():
            confirmation_message += f"‚Ä¢ {candidate}: {votes} –≥–æ–ª–æ—Å(–æ–≤)\n"
    else:
        confirmation_message += "‚Ä¢ –ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª\n"
    
    confirmation_message += f"\n‚ùì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–≤–æ–π –≤—ã–±–æ—Ä?"
    
    try:
        await query.edit_message_text(
            confirmation_message,
            reply_markup=reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error showing confirmation message: {e}")
        await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è")

async def handle_confirm_vote(query, context: CallbackContext, game_id: str, player_index: int):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞"""
    game_data = games.get(game_id)
    if not game_data or not game_data.get("voting_active"):
        await query.answer("–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ", show_alert=True)
        return
    
    voter_id = query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –µ—â–µ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª
    if voter_id in game_data.get("votes", {}):
        await query.answer("–í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏", show_alert=True)
        return

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≥–æ–ª–æ—Å
    if "votes" not in game_data:
        game_data["votes"] = {}
    game_data["votes"][voter_id] = player_index
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    if "voted_messages" not in game_data:
        game_data["voted_messages"] = {}
    game_data["voted_messages"][voter_id] = query.message.message_id
    
    games[game_id] = game_data
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–≥—Ä–æ–∫–∞ –∑–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏
    voted_player_name = game_data["players_slots"][player_index]["fictional_name"]
    
    # –°–æ–∑–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    current_votes = game_data.get("votes", {})
    voting_status = []
    
    # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    for v_id, v_for in current_votes.items():
        # –ù–∞—Ö–æ–¥–∏–º –∏–º—è –≥–æ–ª–æ—Å—É—é—â–µ–≥–æ
        v_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
        for slot in game_data["players_slots"]:
            if slot.get("user_id") == v_id:
                v_name = get_player_display_name(slot, context)
                break
        
        # –ù–∞—Ö–æ–¥–∏–º –∑–∞ –∫–æ–≥–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏  
        if v_for == "skip":
            v_for_name = "–ü—Ä–æ–ø—É—Å–∫"
        else:
            v_for_name = game_data["players_slots"][v_for]["fictional_name"]
        
        voting_status.append(f"‚Ä¢ {v_name} ‚Üí {v_for_name}")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –≥–æ–ª–æ—Å–∞
    voted_keyboard = [[InlineKeyboardButton("‚úÖ –ì–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω", callback_data=f"vote_confirmed_{game_id}")]]
    voted_reply_markup = InlineKeyboardMarkup(voted_keyboard)
    
    final_message = (
        f"‚úÖ **–í–∞—à –≥–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω!**\n\n"
        f"üéØ –í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞: **{voted_player_name}**\n\n"
        f"üìä **–¢–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞:**\n" + "\n".join(voting_status) + "\n\n"
        f"‚è±Ô∏è –û–∂–∏–¥–∞–µ–º –≥–æ–ª–æ—Å–æ–≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤..."
    )
    
    try:
        await query.edit_message_text(
            final_message,
            reply_markup=voted_reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating voted message: {e}")
    
    await query.answer(f"‚úÖ –í–∞—à –≥–æ–ª–æ—Å –∑–∞ {voted_player_name} –∑–∞—Å—á–∏—Ç–∞–Ω!")
    logger.info(f"Player {voter_id} voted for player {player_index} ({voted_player_name}) in game {game_id}")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è "–ì–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω" –¥–ª—è –í–°–ï–• –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
    await update_all_voted_messages(game_id, game_data, context)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ª–∏ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ —Å –ø—Ä–∞–≤–æ–º –≥–æ–ª–æ—Å–∞
    await check_if_all_voted_and_finish(game_id, game_data, context)

async def show_current_voting_status(user_id: int, game_id: str, game_data: dict, context: CallbackContext):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–µ–º—É –∏–≥—Ä–æ–∫—É"""
    current_votes = game_data.get("votes", {})
    active_players = [slot for slot in game_data["players_slots"] if slot.get("status") == STATUS_ACTIVE]
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≥–æ–ª–æ—Å–∞
    vote_counts = {}
    skip_votes = 0
    
    for voted_for in current_votes.values():
        if voted_for == "skip":
            skip_votes += 1
        else:
            player_name = game_data["players_slots"][voted_for]["fictional_name"]
            vote_counts[player_name] = vote_counts.get(player_name, 0) + 1
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º
    status_message = (
        f"üìä **–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:**\n\n"
    )
    
    if vote_counts or skip_votes > 0:
        status_message += "üó≥Ô∏è **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤:**\n"
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≥–æ–ª–æ—Å–æ–≤
        sorted_votes = sorted(vote_counts.items(), key=lambda x: x[1], reverse=True)
        for player_name, votes in sorted_votes:
            status_message += f"‚Ä¢ {player_name}: {votes} –≥–æ–ª–æ—Å(–æ–≤)\n"
        
        if skip_votes > 0:
            status_message += f"‚Ä¢ –ü—Ä–æ–ø—É—Å–∫: {skip_votes} –≥–æ–ª–æ—Å(–æ–≤)\n"
    else:
        status_message += "‚Ä¢ –ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –±–æ–ª—å—à–µ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª\n"
    
    total_voted = len(current_votes)
    total_players = len(active_players)
    status_message += f"\nüë• –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ: {total_voted}/{total_players} –∏–≥—Ä–æ–∫–æ–≤"
    
    try:
        await context.bot.send_message(
            user_id,
            status_message,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error sending voting status to player {user_id}: {e}")

async def handle_return_to_voting(query, context: CallbackContext, game_id: str):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è"""
    game_data = games.get(game_id)
    if not game_data or not game_data.get("voting_active"):
        await query.answer("–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ", show_alert=True)
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    active_players = []
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("status") == STATUS_ACTIVE:
            active_players.append((i, slot["fictional_name"]))

    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç–µ–∫—É—â–∏—Ö –≥–æ–ª–æ—Å–æ–≤
    current_votes = game_data.get("votes", {})
    vote_counts = {}
    for voted_for in current_votes.values():
        if voted_for != "skip":
            vote_counts[voted_for] = vote_counts.get(voted_for, 0) + 1
    
    keyboard = []
    for i, name in active_players:
        vote_count = vote_counts.get(i, 0)
        button_text = f"üó≥Ô∏è {name}" + (f" ({vote_count})" if vote_count > 0 else "")
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"vote_{game_id}_{i}")])
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≥–æ–ª–æ—Å–∞ –∑–∞ –ø—Ä–æ–ø—É—Å–∫
    skip_votes = list(current_votes.values()).count("skip")
    skip_text = f"‚≠ï –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ" + (f" ({skip_votes})" if skip_votes > 0 else "")
    keyboard.append([InlineKeyboardButton(skip_text, callback_data=f"vote_skip_{game_id}")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)

    voting_message = (
        f"üó≥Ô∏è **–î–Ω–µ–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ**\n\n"
        f"–û–±—Å—É–∂–¥–µ–Ω–∏–µ –æ–∫–æ–Ω—á–µ–Ω–æ. –í—Ä–µ–º—è –≤—ã–±—Ä–∞—Ç—å, –∫–æ–≥–æ –∏–∑–≥–Ω–∞—Ç—å –∏–∑ –≥–æ—Ä–æ–¥–∞!\n"
        f"–£ –∫–∞–∂–¥–æ–≥–æ –µ—Å—Ç—å 3 –º–∏–Ω—É—Ç—ã –Ω–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ."
    )
    
    try:
        await query.edit_message_text(
            voting_message,
            reply_markup=reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error returning to voting interface: {e}")

async def check_if_all_voted_and_finish(game_id: str, game_data: dict, context: CallbackContext):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ª–∏ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ —Å –ø—Ä–∞–≤–æ–º –≥–æ–ª–æ—Å–∞, –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ"""
    if not game_data.get("voting_active"):
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ —Å –ø—Ä–∞–≤–æ–º –≥–æ–ª–æ—Å–∞
    active_players_with_rights = []
    game_mode = game_data.get("game_mode", "human_host")
    voting_rights = game_data.get("day_voting_rights", {})
    
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("status") == STATUS_ACTIVE:
            player_key = f"player_{i}"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
            if game_mode == "bot_host":
                has_voting_rights = voting_rights.get(player_key, True)
            else:
                has_voting_rights = True  # –í —Ä–µ–∂–∏–º–µ —á–µ–ª–æ–≤–µ–∫-–≤–µ–¥—É—â–µ–≥–æ –≤—Å–µ –∏–º–µ—é—Ç –ø—Ä–∞–≤–æ –≥–æ–ª–æ—Å–∞
            
            if has_voting_rights and slot.get("user_id"):
                active_players_with_rights.append(slot.get("user_id"))
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ–ª–æ—Å–∞
    current_votes = game_data.get("votes", {})
    voted_players = set(current_votes.keys())
    players_with_rights_ids = set(active_players_with_rights)
    
    # –ï—Å–ª–∏ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ —Å –ø—Ä–∞–≤–æ–º –≥–æ–ª–æ—Å–∞ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ - –∑–∞–≤–µ—Ä—à–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
    if players_with_rights_ids.issubset(voted_players):
        logger.info(f"All players with voting rights have voted in game {game_id}, ending voting early")
        await process_voting_results(game_id, game_data, context)

async def update_all_voted_messages(game_id: str, game_data: dict, context: CallbackContext):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è '–ì–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω' –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"""
    current_votes = game_data.get("votes", {})
    voted_messages = game_data.get("voted_messages", {})
    
    if not current_votes:
        return
    
    # –°–æ–∑–¥–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    voting_status = []
    for v_id, v_for in current_votes.items():
        # –ù–∞—Ö–æ–¥–∏–º –∏–º—è –≥–æ–ª–æ—Å—É—é—â–µ–≥–æ
        v_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
        for slot in game_data["players_slots"]:
            if slot.get("user_id") == v_id:
                v_name = get_player_display_name(slot, context)
                break
        
        # –ù–∞—Ö–æ–¥–∏–º –∑–∞ –∫–æ–≥–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏  
        if v_for == "skip":
            v_for_name = "–ü—Ä–æ–ø—É—Å–∫"
        else:
            v_for_name = game_data["players_slots"][v_for]["fictional_name"]
        
        voting_status.append(f"‚Ä¢ {v_name} ‚Üí {v_for_name}")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–µ–≥–æ –∏–≥—Ä–æ–∫–∞
    for voter_id, vote_for in current_votes.items():
        message_id = voted_messages.get(voter_id)
        if not message_id:
            continue
            
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∑–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–ª —ç—Ç–æ—Ç –∏–≥—Ä–æ–∫
        if vote_for == "skip":
            voted_for_name = "–ü—Ä–æ–ø—É—Å–∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è"
        else:
            voted_for_name = game_data["players_slots"][vote_for]["fictional_name"]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        voted_keyboard = [[InlineKeyboardButton("‚úÖ –ì–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω", callback_data=f"vote_confirmed_{game_id}")]]
        voted_reply_markup = InlineKeyboardMarkup(voted_keyboard)
        
        updated_message = (
            f"‚úÖ **–í–∞—à –≥–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω!**\n\n"
            f"üéØ –í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞: **{voted_for_name}**\n\n"
            f"üìä **–¢–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞:**\n" + "\n".join(voting_status) + "\n\n"
            f"‚è±Ô∏è –û–∂–∏–¥–∞–µ–º –≥–æ–ª–æ—Å–æ–≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤..."
        )
        
        try:
            await context.bot.edit_message_text(
                text=updated_message,
                chat_id=voter_id,
                message_id=message_id,
                reply_markup=voted_reply_markup,
                parse_mode=ParseMode.MARKDOWN
            )
        except Exception as e:
            logger.error(f"Error updating voted message for player {voter_id}: {e}")

async def update_voting_status_for_other_players(game_id: str, game_data: dict, context: CallbackContext, exclude_user_id: int):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —É –∏–≥—Ä–æ–∫–æ–≤, –∫—Ä–æ–º–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ (–∫–æ—Ç–æ—Ä—ã–π —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª)"""
    current_votes = game_data.get("votes", {})
    active_players = []
    players_with_voting_rights = []
    voting_rights = game_data.get("day_voting_rights", {})
    game_mode = game_data.get("game_mode", "human_host")
    
    # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞—Ö
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("status") == STATUS_ACTIVE:
            player_key = f"player_{i}"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
            if game_mode == "bot_host":
                has_voting_rights = voting_rights.get(player_key, True)
            else:
                has_voting_rights = True
            
            display_name = get_player_display_name(slot, context)
            active_players.append((i, display_name))
            if has_voting_rights:
                players_with_voting_rights.append((i, display_name, slot.get("user_id")))
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≥–æ–ª–æ—Å–∞
    vote_counts = {}
    skip_votes = 0
    
    for voted_for in current_votes.values():
        if voted_for == "skip":
            skip_votes += 1
        else:
            player_name = game_data["players_slots"][voted_for]["fictional_name"]
            vote_counts[player_name] = vote_counts.get(player_name, 0) + 1
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    status_message = (
        f"üìä **–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:**\n\n"
    )
    
    if vote_counts or skip_votes > 0:
        status_message += "üó≥Ô∏è **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤:**\n"
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≥–æ–ª–æ—Å–æ–≤
        sorted_votes = sorted(vote_counts.items(), key=lambda x: x[1], reverse=True)
        for player_name, votes in sorted_votes:
            status_message += f"‚Ä¢ {player_name}: {votes} –≥–æ–ª–æ—Å(–æ–≤)\n"
        
        if skip_votes > 0:
            status_message += f"‚Ä¢ –ü—Ä–æ–ø—É—Å–∫: {skip_votes} –≥–æ–ª–æ—Å(–æ–≤)\n"
    else:
        status_message += "‚Ä¢ –ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª\n"
    
    total_voted = len(current_votes)
    total_players = len([slot for slot in game_data["players_slots"] if slot.get("status") == STATUS_ACTIVE])
    status_message += f"\nüë• –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ: {total_voted}/{total_players} –∏–≥—Ä–æ–∫–æ–≤"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –∫—Ä–æ–º–µ —Ç–æ–≥–æ, –∫—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª
    for i, display_name, user_id in players_with_voting_rights:
        if user_id and user_id != exclude_user_id and user_id not in current_votes:
            try:
                await context.bot.send_message(
                    user_id,
                    status_message,
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as e:
                logger.error(f"Error sending voting status update to player {user_id}: {e}")

async def update_voting_interface_for_all_players(game_id: str, game_data: dict, context: CallbackContext):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ç–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞"""
    current_votes = game_data.get("votes", {})
    active_players = []
    players_with_voting_rights = []
    voting_rights = game_data.get("day_voting_rights", {})
    game_mode = game_data.get("game_mode", "human_host")
    
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("status") == STATUS_ACTIVE:
            player_key = f"player_{i}"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
            if game_mode == "bot_host":
                has_voting_rights = voting_rights.get(player_key, True)
            else:
                has_voting_rights = True
            
            display_name = get_player_display_name(slot, context)
            active_players.append((i, display_name))
            if has_voting_rights:
                players_with_voting_rights.append((i, display_name, slot.get("user_id")))

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≥–æ–ª–æ—Å–∞
    vote_counts = {}
    skip_votes = 0
    for voted_for in current_votes.values():
        if voted_for == "skip":
            skip_votes += 1
        else:
            vote_counts[voted_for] = vote_counts.get(voted_for, 0) + 1

    # –°–æ–∑–¥–∞—ë–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    player_list = []
    for i, name in active_players:
        vote_count = vote_counts.get(i, 0)
        player_list.append(f"‚Ä¢ {name} - {vote_count} –≥–æ–ª–æ—Å(–æ–≤)")
    
    status_message = (
        f"üìä **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è**\n\n"
        f"üë• **–¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤:**\n" + "\n".join(player_list) + "\n"
        f"‚≠ï –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ - {skip_votes} –≥–æ–ª–æ—Å(–æ–≤)\n\n"
        f"üìä **–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ:** {len(current_votes)}/{len(players_with_voting_rights)} –∏–≥—Ä–æ–∫–æ–≤"
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º —Å –ø—Ä–∞–≤–æ–º –≥–æ–ª–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–µ –µ—â—ë –ù–ï –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏
    for _, _, user_id in players_with_voting_rights:
        if user_id not in current_votes:  # –¢–æ–ª—å–∫–æ —Ç–µ–º, –∫—Ç–æ –µ—â—ë –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª
            try:
                await context.bot.send_message(
                    user_id,
                    status_message,
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as e:
                logger.error(f"Error sending voting update to player {user_id}: {e}")

async def handle_vote_skip(query, context: CallbackContext, game_id: str):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º"""
    game_data = games.get(game_id)
    if not game_data or not game_data.get("voting_active"):
        await query.answer("–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ", show_alert=True)
        return
    
    voter_id = query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–æ–ª–æ—Å—É—é—â–∏–π —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∏–≥—Ä–µ
    voter_found = False
    voter_slot_index = None
    for i, slot in enumerate(game_data["players_slots"]):
        if slot.get("user_id") == voter_id and slot.get("status") == STATUS_ACTIVE:
            voter_found = True
            voter_slot_index = i
            break
    
    if not voter_found:
        await query.answer("–í—ã –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–π –∏–≥—Ä–µ", show_alert=True)
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¢–û–õ–¨–ö–û –≤ —Ä–µ–∂–∏–º–µ –±–æ—Ç-–≤–µ–¥—É—â–µ–≥–æ
    game_mode = game_data.get("game_mode", "human_host")
    if game_mode == "bot_host":
        voting_rights = game_data.get("day_voting_rights", {})
        player_key = f"player_{voter_slot_index}"
        has_voting_rights = voting_rights.get(player_key, True)
        
        if not has_voting_rights:
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤–∞ –≥–æ–ª–æ—Å–∞ –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –Ω–æ—á–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ", show_alert=True)
            return
        
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –µ—â–µ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª
    if voter_id in game_data.get("votes", {}):
        await query.answer("–í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏", show_alert=True)
        return

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    current_votes = game_data.get("votes", {})
    vote_counts = {}
    for voted_for in current_votes.values():
        if voted_for == "skip":
            vote_counts["skip"] = vote_counts.get("skip", 0) + 1
        else:
            player_name = game_data["players_slots"][voted_for]["fictional_name"]
            vote_counts[player_name] = vote_counts.get(player_name, 0) + 1
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–∞
    confirmation_keyboard = [
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫", callback_data=f"confirm_skip_{game_id}")],
        [InlineKeyboardButton("üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É", callback_data=f"return_to_voting_{game_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(confirmation_keyboard)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
    confirmation_message = (
        f"üó≥Ô∏è **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è**\n\n"
        f"‚≠ï –í—ã –≤—ã–±—Ä–∞–ª–∏: **–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ**\n\n"
        f"üìä **–¢–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞:**\n"
    )
    
    if vote_counts:
        for candidate, votes in vote_counts.items():
            confirmation_message += f"‚Ä¢ {candidate}: {votes} –≥–æ–ª–æ—Å(–æ–≤)\n"
    else:
        confirmation_message += "‚Ä¢ –ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª\n"
    
    confirmation_message += f"\n‚ùì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è?"
    
    try:
        await query.edit_message_text(
            confirmation_message,
            reply_markup=reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error showing skip confirmation message: {e}")
        await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è")

async def handle_confirm_skip(query, context: CallbackContext, game_id: str):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –ø—Ä–æ–ø—É—Å–∫"""
    game_data = games.get(game_id)
    if not game_data or not game_data.get("voting_active"):
        await query.answer("–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ", show_alert=True)
        return
    
    voter_id = query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ –µ—â–µ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª
    if voter_id in game_data.get("votes", {}):
        await query.answer("–í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏", show_alert=True)
        return

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≥–æ–ª–æ—Å –∑–∞ –ø—Ä–æ–ø—É—Å–∫
    if "votes" not in game_data:
        game_data["votes"] = {}
    game_data["votes"][voter_id] = "skip"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    if "voted_messages" not in game_data:
        game_data["voted_messages"] = {}
    game_data["voted_messages"][voter_id] = query.message.message_id
    
    games[game_id] = game_data
    
    # –°–æ–∑–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    current_votes = game_data.get("votes", {})
    voting_status = []
    
    # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    for v_id, v_for in current_votes.items():
        # –ù–∞—Ö–æ–¥–∏–º –∏–º—è –≥–æ–ª–æ—Å—É—é—â–µ–≥–æ
        v_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
        for slot in game_data["players_slots"]:
            if slot.get("user_id") == v_id:
                v_name = get_player_display_name(slot, context)
                break
        
        # –ù–∞—Ö–æ–¥–∏–º –∑–∞ –∫–æ–≥–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏  
        if v_for == "skip":
            v_for_name = "–ü—Ä–æ–ø—É—Å–∫"
        else:
            v_for_name = game_data["players_slots"][v_for]["fictional_name"]
        
        voting_status.append(f"‚Ä¢ {v_name} ‚Üí {v_for_name}")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –≥–æ–ª–æ—Å–∞
    voted_keyboard = [[InlineKeyboardButton("‚úÖ –ì–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω", callback_data=f"vote_confirmed_{game_id}")]]
    voted_reply_markup = InlineKeyboardMarkup(voted_keyboard)
    
    final_message = (
        f"‚úÖ **–í–∞—à –≥–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω!**\n\n"
        f"‚≠ï –í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞: **–ü—Ä–æ–ø—É—Å–∫ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è**\n\n"
        f"üìä **–¢–µ–∫—É—â–∏–µ –≥–æ–ª–æ—Å–∞:**\n" + "\n".join(voting_status) + "\n\n"
        f"‚è±Ô∏è –û–∂–∏–¥–∞–µ–º –≥–æ–ª–æ—Å–æ–≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤..."
    )
    
    try:
        await query.edit_message_text(
            final_message,
            reply_markup=voted_reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating skip voted message: {e}")
    
    await query.answer("‚úÖ –í–∞—à –≥–æ–ª–æ—Å –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –∑–∞—Å—á–∏—Ç–∞–Ω!")
    logger.info(f"Player {voter_id} voted to skip in game {game_id}")
    
    # –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–∂–µ –µ—Å—Ç—å –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤—ã—à–µ
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ª–∏ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ —Å –ø—Ä–∞–≤–æ–º –≥–æ–ª–æ—Å–∞
    await check_if_all_voted_and_finish(game_id, game_data, context)

async def handle_skip_first_day(query, context: CallbackContext, game_id: str):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è"""
    game_data = games.get(game_id)
    if not game_data:
        await query.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    
    if game_data.get("state") != STATE_DAY or game_data.get("current_day_number") != 1:
        await query.answer("–°–µ–π—á–∞—Å –Ω–µ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å", show_alert=True)
        return
    
    voter_id = query.from_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–æ–ª–æ—Å—É—é—â–∏–π —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –∏–≥—Ä–µ
    voter_found = False
    voter_name = None
    for slot in game_data["players_slots"]:
        if slot.get("user_id") == voter_id and slot.get("status") == STATUS_ACTIVE:
            voter_found = True
            voter_name = get_player_display_name(slot, context)
            break
    
    if not voter_found:
        await query.answer("–í—ã –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–π –∏–≥—Ä–µ", show_alert=True)
        return
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≥–æ–ª–æ—Å –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è
    if "first_day_skip_votes" not in game_data:
        game_data["first_day_skip_votes"] = set()
    
    if voter_id in game_data["first_day_skip_votes"]:
        await query.answer("–í—ã —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ –ø—Ä–æ–ø—É—Å–∫", show_alert=True)
        return
    
    game_data["first_day_skip_votes"].add(voter_id)
    games[game_id] = game_data
    
    # –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    total_players = len([slot for slot in game_data["players_slots"] if slot.get("status") == STATUS_ACTIVE])
    skip_votes = len(game_data["first_day_skip_votes"])
    remaining_votes = total_players - skip_votes
    
    # –°–æ–∑–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∑–µ–ª–µ–Ω–æ–π –≥–∞–ª–æ—á–∫–æ–π
    voted_keyboard = [[InlineKeyboardButton("‚úÖ –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞ –ø—Ä–æ–ø—É—Å–∫", callback_data=f"already_voted_skip_{game_id}")]]
    voted_reply_markup = InlineKeyboardMarkup(voted_keyboard)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
    updated_message = (
        f"‚úÖ **–í–∞—à –≥–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω!**\n\n"
        f"üó≥Ô∏è –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏: {skip_votes}/{total_players}\n"
        f"‚è≥ –û—Å—Ç–∞–ª–æ—Å—å –≥–æ–ª–æ—Å–æ–≤: {remaining_votes}\n\n"
        f"{'üéâ –í—Å–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–æ—á–∏...' if remaining_votes == 0 else '‚è±Ô∏è –û–∂–∏–¥–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤...'}"
    )
    
    try:
        await query.edit_message_text(
            updated_message, 
            reply_markup=voted_reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error updating skip vote message: {e}")
        await query.answer(f"‚úÖ –ì–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω! ({skip_votes}/{total_players})")
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    await update_skip_vote_status_for_all_players(game_id, game_data, context, voter_name, skip_votes, total_players)
    
    # –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ - —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –Ω–æ—á–∏
    if skip_votes >= total_players:
        logger.info(f"All participants voted to skip first day in game {game_id}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º
        final_message = "üéâ **–í—Å–µ –∏–≥—Ä–æ–∫–∏ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è!**\n\nüåô –ù–∞—Å—Ç—É–ø–∞–µ—Ç –ø–µ—Ä–≤–∞—è –Ω–æ—á—å..."
        for slot in game_data["players_slots"]:
            if slot.get("status") == STATUS_ACTIVE and slot.get("user_id") and slot.get("user_id") != voter_id:
                try:
                    await context.bot.send_message(
                        slot["user_id"],
                        final_message,
                        parse_mode=ParseMode.MARKDOWN
                    )
                except Exception as e:
                    logger.error(f"Error sending final skip message to player {slot.get('user_id')}: {e}")
        
        await start_first_night(game_id, game_data, context)

async def update_skip_vote_status_for_all_players(game_id: str, game_data: dict, context: CallbackContext, voter_name: str, skip_votes: int, total_players: int):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –¥–Ω—è –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤"""
    remaining_votes = total_players - skip_votes
    
    # –°–æ–∑–¥–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ù–ï –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
    keyboard = [[InlineKeyboardButton("‚≠ï –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å", callback_data=f"skip_first_day_{game_id}")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    updated_message = (
        f"üåû –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –≥–æ—Ä–æ–¥! –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –∏–≥—Ä—ã.\n\n"
        f"–°–µ–π—á–∞—Å —É –≤–∞—Å –µ—Å—Ç—å 10 –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –∏ –æ–±—Å—É–¥–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.\n"
        f"–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å, –µ—Å–ª–∏ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –≥–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ.\n\n"
        f"üìä **–°—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:**\n"
        f"üó≥Ô∏è –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏: {skip_votes}/{total_players}\n"
        f"‚è≥ –û—Å—Ç–∞–ª–æ—Å—å –≥–æ–ª–æ—Å–æ–≤: {remaining_votes}\n"
        f"üë§ –ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–ª–æ—Å: {voter_name}"
    )
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    if "first_day_messages" in game_data:
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —É–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–≤—à–∏—Ö
        voted_keyboard = [[InlineKeyboardButton("‚úÖ –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞ –ø—Ä–æ–ø—É—Å–∫", callback_data=f"already_voted_skip_{game_id}")]]
        voted_reply_markup = InlineKeyboardMarkup(voted_keyboard)
        
        for msg_info in game_data["first_day_messages"]:
            try:
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                chat_id = msg_info["chat_id"]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü —á–∞—Ç–∞
                user_voted = False
                for slot in game_data["players_slots"]:
                    if slot.get("user_id") == chat_id and slot.get("user_id") in game_data["first_day_skip_votes"]:
                        user_voted = True
                        break
                
                # –í—ã–±–∏—Ä–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                message_reply_markup = voted_reply_markup if user_voted else reply_markup
                
                await context.bot.edit_message_text(
                    chat_id=chat_id,
                    message_id=msg_info["message_id"],
                    text=updated_message,
                    reply_markup=message_reply_markup,
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as e:
                logger.error(f"Error updating first day message for chat {msg_info['chat_id']}: {e}")
    else:
        # –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        for slot in game_data["players_slots"]:
            if slot.get("status") == STATUS_ACTIVE and slot.get("user_id"):
                voter_id_from_slot = None
                for vote_user_id in game_data.get("first_day_skip_votes", set()):
                    if slot.get("user_id") == vote_user_id:
                        voter_id_from_slot = vote_user_id
                        break
                
                # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–º—É, –∫—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª
                if voter_id_from_slot:
                    continue
                    
                try:
                    await context.bot.send_message(
                        slot["user_id"],
                        f"üìä **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:**\n"
                        f"üë§ {voter_name} –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –¥–Ω—è\n"
                        f"üó≥Ô∏è –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏: {skip_votes}/{total_players}\n"
                        f"‚è≥ –û—Å—Ç–∞–ª–æ—Å—å –≥–æ–ª–æ—Å–æ–≤: {remaining_votes}",
                        parse_mode=ParseMode.MARKDOWN
                    )
                except Exception as e:
                    logger.error(f"Error sending vote update to player {slot.get('user_id')}: {e}")

def get_role_description(role_name: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏ –¥–ª—è –∏–≥—Ä–æ–∫–∞"""
    role_data = ROLES_DATA.get(role_name, {})
    if not role_data:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å"
    
    return (
        f"**{role_name}**\n\n"
        f"üìù **–û–ø–∏—Å–∞–Ω–∏–µ:** {role_data.get('description', '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}\n\n"
        f"üéØ **–¶–µ–ª—å:** {role_data.get('goal', '–¶–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞')}\n\n"
        f"‚ö° **–î–µ–π—Å—Ç–≤–∏—è:** {role_data.get('actions', '–î–µ–π—Å—Ç–≤–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω—ã')}"
    )

def get_full_rules_text() -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤—Å–µ—Ö —Ä–æ–ª–µ–π"""
    rules = (
        "üìñ **–ü–†–ê–í–ò–õ–ê –ò–ì–†–´ –ú–ê–§–ò–Ø**\n\n"
        
        "üéØ **–û–ë–©–ê–Ø –¶–ï–õ–¨ –ò–ì–†–´:**\n"
        "‚Ä¢ **–ú–∏—Ä–Ω—ã–µ –∂–∏—Ç–µ–ª–∏:** –Ω–∞–π—Ç–∏ –∏ –∏—Å–∫–ª—é—á–∏—Ç—å –≤—Å–µ—Ö –º–∞—Ñ–∏–æ–∑–∏\n"
        "‚Ä¢ **–ú–∞—Ñ–∏—è:** –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –≥–æ—Ä–æ–¥, —Å—Ç–∞–≤ —Ä–∞–≤–Ω–æ–π –∏–ª–∏ –ø—Ä–µ–≤—ã—à–∞—é—â–µ–π –ø–æ —á–∏—Å–ª—É –º–∏—Ä–Ω—ã—Ö\n"
        "‚Ä¢ **–ú–∞–Ω—å—è–∫:** –æ—Å—Ç–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º –≤—ã–∂–∏–≤—à–∏–º (–µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç)\n\n"
        
        "üïê **–§–ê–ó–´ –ò–ì–†–´:**\n\n"
        
        "üåô **–ù–û–ß–ù–ê–Ø –§–ê–ó–ê:**\n"
        "‚Ä¢ –í—Å–µ —Ä–æ–ª–∏ —Å –Ω–æ—á–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏ –¥–µ–π—Å—Ç–≤—É—é—Ç —Ç–∞–π–Ω–æ\n"
        "‚Ä¢ –ú–∞—Ñ–∏—è –≤—ã–±–∏—Ä–∞–µ—Ç –∂–µ—Ä—Ç–≤—É –¥–ª—è —É–±–∏–π—Å—Ç–≤–∞\n"
        "‚Ä¢ –î–æ–∫—Ç–æ—Ä –º–æ–∂–µ—Ç —Å–ø–∞—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞\n"
        "‚Ä¢ –ö–æ–º–∏—Å—Å–∞—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞\n"
        "‚Ä¢ –ú–∞–Ω—å—è–∫ —É–±–∏–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –∂–µ—Ä—Ç–≤—É\n"
        "‚Ä¢ –ü—É—Ç–∞–Ω–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏–≥—Ä–æ–∫–∞\n"
        "‚Ä¢ üí¨ **–ß–∞—Ç –º–∞—Ñ–∏–∏ –∞–∫—Ç–∏–≤–µ–Ω** –≤–æ –≤—Ä–µ–º—è –∏—Ö —Ö–æ–¥–∞\n\n"
        
        "‚òÄÔ∏è **–î–ù–ï–í–ù–ê–Ø –§–ê–ó–ê:**\n"
        "‚Ä¢ –û–±—ä—è–≤–ª—è—é—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–æ—á–∏\n"
        "‚Ä¢ –û—Ç–∫—Ä—ã—Ç—ã–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –º–µ–∂–¥—É –≤—Å–µ–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏\n"
        "‚Ä¢ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–µ–≤–∞–µ–º–æ–≥–æ\n"
        "‚Ä¢ –ò–≥—Ä–æ–∫ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≥–æ–ª–æ—Å–æ–≤ –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è\n"
        "‚Ä¢ üí¨ **–û–±—â–∏–π —á–∞—Ç –∞–∫—Ç–∏–≤–µ–Ω** –¥–ª—è –≤—Å–µ—Ö –∂–∏–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤\n\n"
        
        "üí¨ **–°–ò–°–¢–ï–ú–ê –ß–ê–¢–ê:**\n"
        "‚Ä¢ –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É - –æ–Ω–æ –¥–æ–π–¥–µ—Ç –¥–æ –Ω—É–∂–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤\n"
        "‚Ä¢ **–î–µ–Ω—å:** –í—Å–µ –∂–∏–≤—ã–µ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥—è—Ç –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è\n"
        "‚Ä¢ **–ù–æ—á—å:** –¢–æ–ª—å–∫–æ –º–∞—Ñ–∏—è –º–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è –≤–æ –≤—Ä–µ–º—è —Å–≤–æ–µ–≥–æ —Ö–æ–¥–∞\n"
        "‚Ä¢ –§–æ—Ä–º–∞—Ç: \"–ò–≥—Ä–æ–≤–æ–µ –∏–º—è | Telegram –∏–º—è: –≤–∞—à —Ç–µ–∫—Å—Ç\"\n\n"
        
        "üë• **–†–û–õ–ò –ò –ò–• –°–ü–û–°–û–ë–ù–û–°–¢–ò:**\n\n"
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
    for role_name, role_data in ROLES_DATA.items():
        rules += (
            f"**{role_name}:**\n"
            f"{role_data['description']}\n"
            f"*–¶–µ–ª—å:* {role_data['goal']}\n"
            f"*–î–µ–π—Å—Ç–≤–∏—è:* {role_data['actions']}\n\n"
        )
    
    rules += (
        "üèÜ **–£–°–õ–û–í–ò–Ø –ü–û–ë–ï–î–´:**\n\n"
        "**–ú–∏—Ä–Ω—ã–µ –ø–æ–±–µ–∂–¥–∞—é—Ç, –µ—Å–ª–∏:**\n"
        "‚Ä¢ –í—Å–µ –º–∞—Ñ–∏–æ–∑–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –∏–≥—Ä—ã\n"
        "‚Ä¢ –ú–∞–Ω—å—è–∫ –∏—Å–∫–ª—é—á–µ–Ω (–µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç)\n\n"
        
        "**–ú–∞—Ñ–∏—è –ø–æ–±–µ–∂–¥–∞–µ—Ç, –µ—Å–ª–∏:**\n"
        "‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ñ–∏–æ–∑–∏ ‚â• –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∏—Ä–Ω—ã—Ö\n\n"
        
        "**–ú–∞–Ω—å—è–∫ –ø–æ–±–µ–∂–¥–∞–µ—Ç, –µ—Å–ª–∏:**\n"
        "‚Ä¢ –û—Å—Ç–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º –≤—ã–∂–∏–≤—à–∏–º\n\n"
        
        "üéÆ **–†–ï–ñ–ò–ú–´ –ò–ì–†–´:**\n\n"
        "**üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º:**\n"
        "‚Ä¢ –î–æ 8 –∏–≥—Ä–æ–∫–æ–≤\n"
        "‚Ä¢ –í–µ–¥—É—â–∏–π - –≤—ã –∏–ª–∏ –±–æ—Ç\n"
        "‚Ä¢ –ë–∞–∑–æ–≤—ã–µ —Ä–æ–ª–∏\n\n"
        
        "**üíé –ü—Ä–µ–º–∏—É–º —Ä–µ–∂–∏–º:**\n"
        "‚Ä¢ –î–æ 20 –∏–≥—Ä–æ–∫–æ–≤\n"
        "‚Ä¢ –í–µ–¥—É—â–∏–π - –≤—ã –∏–ª–∏ –±–æ—Ç\n"
        "‚Ä¢ –í—Å–µ —Ä–æ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã\n"
        "‚Ä¢ –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π"
    )
    
    return rules

# –†–æ–ª–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ
FREE_ROLES = ["–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å", "–ú–∞—Ñ–∏–æ–∑–∏", "–ö–æ–º–∏—Å—Å–∞—Ä", "–î–æ–∫—Ç–æ—Ä"]

async def show_roles_selection_menu(query):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–µ–π"""
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üë• –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–æ–ª–µ–π", callback_data="show_all_roles")],
        [InlineKeyboardButton("üìñ –ü–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã", callback_data="show_full_rules")],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_main")]
    ])
    
    await query.edit_message_text(
        "üìö **–ü–†–ê–í–ò–õ–ê –ò –†–û–õ–ò**\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ",
        reply_markup=keyboard,
        parse_mode=ParseMode.MARKDOWN
    )

async def show_all_roles_with_buttons(query):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Ä–æ–ª–∏ –≤ –≤–∏–¥–µ –∫–Ω–æ–ø–æ–∫"""
    keyboard_rows = []
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
    for role_name in ROLES_DATA.keys():
        # –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è —Ä–æ–ª–∏
        if role_name == "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å":
            emoji = "üë®‚Äçüíº"
        elif role_name == "–ú–∞—Ñ–∏–æ–∑–∏":
            emoji = "üï¥Ô∏è"
        elif role_name == "–î–æ–Ω –ú–∞—Ñ–∏–∏":
            emoji = "üëë"
        elif role_name == "–ö–æ–º–∏—Å—Å–∞—Ä":
            emoji = "üïµÔ∏è"
        elif role_name == "–î–æ–∫—Ç–æ—Ä":
            emoji = "üë®‚Äç‚öïÔ∏è"
        elif role_name == "–ú–∞–Ω—å—è–∫":
            emoji = "üî™"
        elif role_name == "–ü—É—Ç–∞–Ω–∞":
            emoji = "üíÉ"
        else:
            emoji = "üé≠"
            
        keyboard_rows.append([InlineKeyboardButton(
            f"{emoji} {role_name}", 
            callback_data=f"role_detail_{role_name}"
        )])
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
    keyboard_rows.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –∫ –ø—Ä–∞–≤–∏–ª–∞–º", callback_data="rules")])
    
    keyboard = InlineKeyboardMarkup(keyboard_rows)
    
    await query.edit_message_text(
        "üë• **–°–ü–ò–°–û–ö –î–û–°–¢–£–ü–ù–´–• –†–û–õ–ï–ô**\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ—ë –æ–ø–∏—Å–∞–Ω–∏–µ\n\n"
        "üîπ **–ë–∞–∑–æ–≤—ã–µ —Ä–æ–ª–∏** (–¥–æ—Å—Ç—É–ø–Ω—ã –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ):\n"
        "üë®‚Äçüíº –ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å, üï¥Ô∏è –ú–∞—Ñ–∏–æ–∑–∏, üïµÔ∏è –ö–æ–º–∏—Å—Å–∞—Ä, üë®‚Äç‚öïÔ∏è –î–æ–∫—Ç–æ—Ä\n\n"
        "üî∏ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏** (—Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–º–∏—É–º —Ä–µ–∂–∏–º–µ):\n"
        "üëë –î–æ–Ω –ú–∞—Ñ–∏–∏, üî™ –ú–∞–Ω—å—è–∫, üíÉ –ü—É—Ç–∞–Ω–∞",
        reply_markup=keyboard,
        parse_mode=ParseMode.MARKDOWN
    )

async def show_role_details(query, role_name):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏"""
    role_data = ROLES_DATA.get(role_name, {})
    
    if not role_data:
        await query.answer("‚ùå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–æ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä–æ–ª–∏
    availability = "üÜì –î–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ" if role_name in FREE_ROLES else "üíé –¢–æ–ª—å–∫–æ –≤ –ø—Ä–µ–º–∏—É–º —Ä–µ–∂–∏–º–µ"
    
    # –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è —Ä–æ–ª–∏
    if role_name == "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å":
        emoji = "üë®‚Äçüíº"
    elif role_name == "–ú–∞—Ñ–∏–æ–∑–∏":
        emoji = "üï¥Ô∏è"
    elif role_name == "–î–æ–Ω –ú–∞—Ñ–∏–∏":
        emoji = "üëë"
    elif role_name == "–ö–æ–º–∏—Å—Å–∞—Ä":
        emoji = "üïµÔ∏è"
    elif role_name == "–î–æ–∫—Ç–æ—Ä":
        emoji = "üë®‚Äç‚öïÔ∏è"
    elif role_name == "–ú–∞–Ω—å—è–∫":
        emoji = "üî™"
    elif role_name == "–ü—É—Ç–∞–Ω–∞":
        emoji = "üíÉ"
    else:
        emoji = "üé≠"
    
    message_text = (
        f"{emoji} **{role_name}**\n\n"
        f"{availability}\n\n"
        f"üìù **–û–ø–∏—Å–∞–Ω–∏–µ:**\n{role_data['description']}\n\n"
        f"üéØ **–¶–µ–ª—å:**\n{role_data['goal']}\n\n"
        f"‚ö° **–î–µ–π—Å—Ç–≤–∏—è:**\n{role_data['actions']}"
    )
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üîô –ö —Å–ø–∏—Å–∫—É —Ä–æ–ª–µ–π", callback_data="show_all_roles")]
    ])
    
    await query.edit_message_text(
        message_text,
        reply_markup=keyboard,
        parse_mode=ParseMode.MARKDOWN
    )

async def show_full_rules_text_interface(query):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã"""
    rules_text = get_full_rules_text()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –∫ –ø—Ä–∞–≤–∏–ª–∞–º", callback_data="rules")]
    ])
    
    await query.edit_message_text(
        rules_text,
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=keyboard
    )

def get_role_config_keyboard(pending_setup: dict) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ–ª–µ–π"""
    current_roles = pending_setup.get('current_roles', {})
    total_players = pending_setup.get('total_players', 0)
    current_assigned = sum(current_roles.values())
    
    # –°–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    role_short_names = {
        "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å": "–ú–∏—Ä–Ω—ã–π",
        "–ú–∞—Ñ–∏–æ–∑–∏": "–ú–∞—Ñ–∏–æ–∑–∏", 
        "–î–æ–Ω –ú–∞—Ñ–∏–∏": "–î–æ–Ω",
        "–ö–æ–º–∏—Å—Å–∞—Ä": "–ö–æ–º–∏—Å—Å–∞—Ä",
        "–î–æ–∫—Ç–æ—Ä": "–î–æ–∫—Ç–æ—Ä",
        "–ú–∞–Ω—å—è–∫": "–ú–∞–Ω—å—è–∫",
        "–ü—É—Ç–∞–Ω–∞": "–ü—É—Ç–∞–Ω–∞"
    }
    
    buttons = []
    
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    for role in ALL_CONFIGURABLE_ROLES:
        count = current_roles.get(role, 0)
        short_name = role_short_names.get(role, role)
        # –ö–Ω–æ–ø–∫–∏ —É–º–µ–Ω—å—à–µ–Ω–∏—è –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
        role_row = [
            InlineKeyboardButton("-", callback_data=f"cfg_dec_{role}"),
            InlineKeyboardButton(f"{short_name}: {count}", callback_data=f"role_info_{role}"),
            InlineKeyboardButton("+", callback_data=f"cfg_inc_{role}")
        ]
        buttons.append(role_row)
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    buttons.append([InlineKeyboardButton(f"üìä –í—ã–±—Ä–∞–Ω–æ: {current_assigned}/{total_players}", callback_data="ignore")])
    
    # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    control_buttons = [
        [InlineKeyboardButton("üîÑ –°–±—Ä–æ—Å–∏—Ç—å", callback_data="cfg_reset")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cfg_cancel")]
    ]
    
    # –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–µ—Å–ª–∏ –≤—Å–µ —Ä–æ–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã)
    if current_assigned == total_players and total_players > 0:
        control_buttons.insert(0, [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data="cfg_confirm")])
    
    buttons.extend(control_buttons)
    
    return InlineKeyboardMarkup(buttons)

async def send_role_config_message(query_or_update, context: CallbackContext, is_edit: bool = False):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ–ª–µ–π"""
    pending_setup = context.user_data.get('pending_game_setup')
    if not pending_setup:
        return
    
    current_roles = pending_setup.get('current_roles', {})
    total_players = pending_setup.get('total_players', 0)
    current_assigned = sum(current_roles.values())
    
    message_text = (
        f"‚öôÔ∏è **–†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π**\n\n"
        f"üë• **–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:** {total_players}\n"
        f"üéØ **–ù–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–æ–ª–µ–π:** {current_assigned}/{total_players}\n\n"
        f"üìù **–¢–µ–∫—É—â–∏–π —Å–æ—Å—Ç–∞–≤:**\n"
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–æ—Å—Ç–∞–≤ —Ä–æ–ª–µ–π
    for role in ALL_CONFIGURABLE_ROLES:
        count = current_roles.get(role, 0)
        if count > 0:
            message_text += f"‚Ä¢ {role}: {count}\n"
    
    if current_assigned == 0:
        message_text += "*–†–æ–ª–∏ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã*\n"
    
    message_text += (
        f"\nüí° **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ + –∏ - –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏.**\n"
        f"üìã –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."
    )
    
    keyboard = get_role_config_keyboard(pending_setup)
    
    if is_edit and hasattr(query_or_update, 'edit_message_text'):
        await query_or_update.edit_message_text(
            message_text,
            reply_markup=keyboard,
            parse_mode=ParseMode.MARKDOWN
        )
    else:
        if hasattr(query_or_update, 'message'):
            await query_or_update.message.reply_text(
                message_text,
                reply_markup=keyboard,
                parse_mode=ParseMode.MARKDOWN
            )
        else:
            await query_or_update.reply_text(
                message_text,
                reply_markup=keyboard,
                parse_mode=ParseMode.MARKDOWN
            )

async def create_game_with_manual_roles(query, context: CallbackContext, setup_data: dict, roles_list: list):
    """–°–æ–∑–¥–∞–µ—Ç –∏–≥—Ä—É —Å —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ä–æ–ª–µ–π"""
    try:
        user = query.from_user
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∏–≥—Ä—ã
        game_id = "mafia_" + generate_id(6)
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏–º–µ–Ω–∞ –∏ –¥–µ–ª–∞
        available_fictional_names = fictional_names_list.copy()
        random.shuffle(available_fictional_names)
        available_personal_cases = personal_cases.copy()
        random.shuffle(available_personal_cases)
        
        # –°–æ–∑–¥–∞–µ–º —Å–ª–æ—Ç—ã –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤ (—Ä–æ–ª–∏ —É–∂–µ –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã –≤ roles_list)
        players_slots = []
        for i in range(len(roles_list)):
            player_role = roles_list[i]  # –†–æ–ª–∏ —É–∂–µ –≤ —Å–ª—É—á–∞–π–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
            player_name = available_fictional_names[i % len(available_fictional_names)]
            player_case = available_personal_cases[i % len(available_personal_cases)]
            
            slot = {
                "role": player_role,
                "description": player_case,
                "fictional_name": player_name,
                "user_id": None,
                "_user_first_name": None,
                "status": STATUS_ACTIVE,
                "original_slot_index": i
            }
            players_slots.append(slot)
        
        # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∏–≥—Ä—ã
        game_data = {
            'host_id': user.id,
            'host_name': user.full_name or "–ê–Ω–æ–Ω–∏–º",
            'state': STATE_ROLES_DISTRIBUTED,
            'players_slots': players_slots,
            'num_players': len(roles_list),
            'game_mode': setup_data.get('game_mode', 'human_host'),
            'game_version': setup_data.get('game_version', 'paid'),
            'created_at': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            'current_night_number': 0,
            'current_day_number': 0,
            'roles_manually_configured': True
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É
        games[game_id] = game_data
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –±–æ—Ç–∞ –¥–ª—è —Å—Å—ã–ª–∫–∏
        try:
            bot_info = await context.bot.get_me()
            bot_username = bot_info.username
            logger.info(f"[DEBUG] –ü–æ–ª—É—á–µ–Ω–æ –∏–º—è –±–æ—Ç–∞ –∏–∑ API –¥–ª—è —Ä—É—á–Ω–æ–π –∏–≥—Ä—ã: @{bot_username}")
        except Exception as e:
            logger.error(f"[ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–æ—Ç–µ –¥–ª—è —Ä—É—á–Ω–æ–π –∏–≥—Ä—ã: {e}")
            bot_username = "Mafia_IRL_Bot"
            logger.info(f"[DEBUG] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∏–º—è –±–æ—Ç–∞ –¥–ª—è —Ä—É—á–Ω–æ–π –∏–≥—Ä—ã: @{bot_username}")

        join_game_link = f"https://t.me/{bot_username}?start=join_{game_id}"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ –∏–≥—Ä—ã
        version = setup_data.get('game_version', 'paid')
        game_mode = setup_data.get('game_mode', 'human_host')
        
        if version == 'free':
            game_type_description = "üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞"
        else:
            if game_mode == 'human_host':
                game_type_description = "üíé –ü–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞ (–í–µ–¥—É—â–∏–π - –Ø)"
            else:
                game_type_description = "ü§ñüíé –ü–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞ (–í–µ–¥—É—â–∏–π - –ë–æ—Ç)"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ
        roles_summary = {}
        for role in roles_list:
            roles_summary[role] = roles_summary.get(role, 0) + 1
        
        roles_text = "\n".join([f"‚Ä¢ {role}: {count}" for role, count in roles_summary.items()])
        
        message_text = (
            f"üé≤ **–ù–æ–≤–∞—è –∏–≥—Ä–∞ –≤ –ú–∞—Ñ–∏—é —Å–æ–∑–¥–∞–Ω–∞!**\n\n"
            f"üÜî **ID –∏–≥—Ä—ã:** `{game_id}`\n"
            f"üéÆ **–¢–∏–ø –∏–≥—Ä—ã:** {game_type_description}\n"
            f"üë§ **–í–µ–¥—É—â–∏–π:** {user.first_name}\n"
            f"üë• **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:** {len(roles_list)}\n"
            f"‚öôÔ∏è **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π:** –†—É—á–Ω–∞—è\n\n"
            f"üé≠ **–°–æ—Å—Ç–∞–≤ —Ä–æ–ª–µ–π:**\n{roles_text}\n\n"
            f"üîó **–°–°–´–õ–ö–ê –î–õ–Ø –ò–ì–†–û–ö–û–í:**\n"
            f"`{join_game_link}`\n\n"
            f"üì§ –†–∞–∑–æ—à–ª–∏—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.\n"
            f"üé≠ –ò–≥—Ä–æ–∫–∏ –ø–æ–ª—É—á–∞—Ç —Ä–æ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
        )
        
        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üéÆ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è", callback_data=f"join_game_{game_id}")],
            [InlineKeyboardButton("üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–≥—Ä–æ–π", callback_data=f"copy_link_{game_id}")]
        ])
        
        await query.edit_message_text(
            message_text,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=keyboard
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Ä–æ–ª–µ–π –≤–µ–¥—É—â–µ–º—É (–µ—Å–ª–∏ –Ω–µ –±–æ—Ç-–≤–µ–¥—É—â–∏–π)
        if game_mode != 'bot_host':
            roles_details = ["üïµÔ∏è **–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ —Ä–æ–ª–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏:**"]
            for i, slot in enumerate(players_slots):
                roles_details.append(
                    f"**–°–ª–æ—Ç {i+1}:** {slot['fictional_name']} - {slot['role']} *(–û–∂–∏–¥–∞–µ—Ç –∏–≥—Ä–æ–∫–∞)*"
                )
            
            await context.bot.send_message(
                user.id,
                "\n".join(roles_details),
                parse_mode=ParseMode.MARKDOWN
            )
        
        # –û—á–∏—â–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        if 'pending_game_setup' in context.user_data:
            del context.user_data['pending_game_setup']
        
        logger.info(f"[DEBUG] –ò–≥—Ä–∞ —Å —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ä–æ–ª–µ–π —Å–æ–∑–¥–∞–Ω–∞ —Å ID: {game_id}")
        return game_id
        
    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–≥—Ä—ã —Å —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π: {str(e)}\n{error_details}")
        await query.edit_message_text(
            f"‚ùå **–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–≥—Ä—ã.**\n\n"
            f"**–°–æ–æ–±—â–µ–Ω–∏–µ:** {str(e)}",
            parse_mode=ParseMode.MARKDOWN
        )
        # –û—á–∏—â–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        if 'pending_game_setup' in context.user_data:
            del context.user_data['pending_game_setup']
        return None

async def handle_player_count_input(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã"""
    
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä
    if await handle_math_answer(update, context):
        return  # –≠—Ç–æ –±—ã–ª –æ—Ç–≤–µ—Ç –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
    
    user = update.effective_user
    message_text = update.message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
    if context.user_data.get('game_setup_state') != 'waiting_player_count':
        return  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ –≤–≤–æ–¥–∞
    
    try:
        num_players = int(message_text)
    except ValueError:
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –∏–≥—Ä–æ–∫–æ–≤.\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: `6`",
            parse_mode=ParseMode.MARKDOWN
        )
        return

    game_type = context.user_data.get('game_type', 'free')
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
    if game_type == 'free':
        if not (4 <= num_players <= 8):
            await update.message.reply_text(
                f"‚ùå –í –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ –¥–æ—Å—Ç—É–ø–Ω–æ –æ—Ç 4 –¥–æ 8 –∏–≥—Ä–æ–∫–æ–≤.\n"
                f"–í—ã –≤–≤–µ–ª–∏: {num_players}\n\n"
                f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 4 –¥–æ 8."
            )
            return
        
        # –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –≤–µ–¥—É—â–µ–≥–æ
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton(f"üë§ –Ø –≤–µ–¥—É—â–∏–π", 
                                callback_data=f"host_type_human_{num_players}_free")],
            [InlineKeyboardButton(f"ü§ñ –ë–æ—Ç-–≤–µ–¥—É—â–∏–π", 
                                callback_data=f"host_type_bot_{num_players}_free")],

            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="game_type_free")]
        ])
        
        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–≤–æ–¥–∞
        context.user_data['game_setup_state'] = None
        
        await update.message.reply_text(
            f"üÜì **–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞ –Ω–∞ {num_players} –∏–≥—Ä–æ–∫–æ–≤**\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–µ–¥—É—â–µ–≥–æ:\n\n"
            f"üîπ **–ë–∞–∑–æ–≤—ã–µ —Ä–æ–ª–∏:** –ú–∞—Ñ–∏–æ–∑–∏, –ö–æ–º–∏—Å—Å–∞—Ä, –î–æ–∫—Ç–æ—Ä, –ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å\n"
            f"üîπ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π**",
            reply_markup=keyboard,
            parse_mode=ParseMode.MARKDOWN
        )
            
    elif game_type == 'premium':
        if not (4 <= num_players <= 20):
            await update.message.reply_text(
                f"‚ùå –í –ø—Ä–µ–º–∏—É–º —Ä–µ–∂–∏–º–µ –¥–æ—Å—Ç—É–ø–Ω–æ –æ—Ç 4 –¥–æ 20 –∏–≥—Ä–æ–∫–æ–≤.\n"
                f"–í—ã –≤–≤–µ–ª–∏: {num_players}\n\n"
                f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 4 –¥–æ 20."
            )
            return
        
        # –î–ª—è –ø—Ä–µ–º–∏—É–º —Ä–µ–∂–∏–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –≤–µ–¥—É—â–µ–≥–æ
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton(f"üë§ –Ø –≤–µ–¥—É—â–∏–π", 
                                callback_data=f"host_type_human_{num_players}")],
            [InlineKeyboardButton(f"ü§ñ –ë–æ—Ç-–≤–µ–¥—É—â–∏–π", 
                                callback_data=f"host_type_bot_{num_players}")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="game_type_premium")]
        ])
        
        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–≤–æ–¥–∞
        context.user_data['game_setup_state'] = None
        
        await update.message.reply_text(
            f"üíé **–ü—Ä–µ–º–∏—É–º –∏–≥—Ä–∞ –Ω–∞ {num_players} –∏–≥—Ä–æ–∫–æ–≤**\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–µ–¥—É—â–µ–≥–æ:",
            reply_markup=keyboard,
            parse_mode=ParseMode.MARKDOWN
        )
            
    else:
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∏–≥—Ä—ã")
        context.user_data['game_setup_state'] = None

# === –°–ò–°–¢–ï–ú–ê –í–ù–£–¢–†–ò–ò–ì–†–û–í–û–ì–û –ß–ê–¢–ê ===

async def find_player_game_session(user_id: int) -> tuple:
    """–ù–∞—Ö–æ–¥–∏—Ç –∞–∫—Ç–∏–≤–Ω—É—é –∏–≥—Ä–æ–≤—É—é —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    for game_id, game_data in games.items():
        if game_data.get('state') == 'finished':
            continue
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —ç—Ç–æ–π –∏–≥—Ä–µ
        for slot in game_data.get('players_slots', []):
            if slot.get('user_id') == user_id:
                return game_id, game_data, slot
    
    return None, None, None

async def find_all_player_game_sessions(user_id: int) -> list:
    """–ù–∞—Ö–æ–¥–∏—Ç –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    active_sessions = []
    for game_id, game_data in games.items():
        if game_data.get('state') == 'finished':
            continue
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—á–∞—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —ç—Ç–æ–π –∏–≥—Ä–µ
        for slot in game_data.get('players_slots', []):
            if slot.get('user_id') == user_id:
                active_sessions.append((game_id, game_data, slot))
                break
    
    return active_sessions

async def remove_player_from_game(user_id: int, game_id: str, context: CallbackContext):
    """–£–¥–∞–ª—è–µ—Ç –∏–≥—Ä–æ–∫–∞ –∏–∑ –∏–≥—Ä—ã"""
    if game_id not in games:
        return False
    
    game_data = games[game_id]
    player_removed = False
    
    # –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º –∏–≥—Ä–æ–∫–∞
    for slot in game_data.get('players_slots', []):
        if slot.get('user_id') == user_id:
            slot['user_id'] = None
            slot['_user_first_name'] = None
            slot['real_name'] = None
            player_removed = True
            break
    
    if player_removed:
        # –£–≤–µ–¥–æ–º–ª—è–µ–º —Ö–æ—Å—Ç–∞ (–µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∂–∏–º human_host)
        if game_data.get('game_mode') == 'human_host':
            try:
                await context.bot.send_message(
                    game_data['host_id'],
                    f"‚ö†Ô∏è –ò–≥—Ä–æ–∫ –ø–æ–∫–∏–Ω—É–ª –∏–≥—Ä—É {game_id}\n"
                    f"–û—Å–≤–æ–±–æ–¥–∏–ª—Å—è —Å–ª–æ—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞."
                )
            except:
                pass
    
    return player_removed

def can_player_send_message(game_data: dict, player_slot: dict) -> tuple:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –∏–≥—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç"""
    # –ú–µ—Ä—Ç–≤—ã–µ –∏–≥—Ä–æ–∫–∏ –Ω–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å, –Ω–æ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —á–∞—Ç
    if player_slot.get('status') != STATUS_ACTIVE:
        return False, "üíÄ –ú–µ—Ä—Ç–≤—ã–µ –∏–≥—Ä–æ–∫–∏ –Ω–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç, –Ω–æ –º–æ–≥—É—Ç –Ω–∞–±–ª—é–¥–∞—Ç—å"
    
    game_state = game_data.get('state')
    player_role = player_slot.get('role')
    
    # –î–Ω–µ–≤–Ω–∞—è —Ñ–∞–∑–∞ - –≤—Å–µ –∂–∏–≤—ã–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å
    if game_state == STATE_DAY:
        return True, None
    
    # –ù–æ—á–Ω–∞—è —Ñ–∞–∑–∞ - —Ç–æ–ª—å–∫–æ –º–∞—Ñ–∏—è –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å
    if game_state == STATE_NIGHT:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–≥—Ä–æ–∫ –º–∞—Ñ–∏–µ–π
        if player_role not in [ROLE_MAFIA_DON, ROLE_MAFIA]:
            return False, "üåô –ù–æ—á—å—é –º–æ–≥—É—Ç –æ–±—â–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ —á–ª–µ–Ω—ã –º–∞—Ñ–∏–∏"
        
        # –ú–∞—Ñ–∏—è –º–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è –≤—Å—é –Ω–æ—á—å (–Ω–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ö–æ–¥—É)
        return True, None
    
    # –î—Ä—É–≥–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
    if game_state in [STATE_ROLES_DISTRIBUTED]:
        return False, "‚è≥ –ß–∞—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã"
    
    return False, "‚ùå –ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∏–≥—Ä—ã"

def format_chat_message(player_slot: dict, user: object, message_text: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —á–∞—Ç–µ"""
    fictional_name = player_slot.get('fictional_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')
    telegram_name = user.first_name
    if user.last_name:
        telegram_name += f" {user.last_name}"
    
    # –î–æ–±–∞–≤–ª—è–µ–º username –µ—Å–ª–∏ –µ—Å—Ç—å
    username_part = f" (@{user.username})" if user.username else ""
    
    # –£–±–∏—Ä–∞–µ–º markdown —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
    return f"üí¨ {fictional_name} | {telegram_name}{username_part}:\n{message_text}"

async def send_message_to_game_participants(game_id: str, game_data: dict, formatted_message: str, sender_user_id: int, context: CallbackContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∏–≥—Ä—ã"""
    game_state = game_data.get('state')
    sender_role = None
    
    # –ù–∞—Ö–æ–¥–∏–º —Ä–æ–ª—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    for slot in game_data.get('players_slots', []):
        if slot.get('user_id') == sender_user_id:
            sender_role = slot.get('role')
            break
    
    recipients = []
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∑—ã –∏–≥—Ä—ã
    if game_state == STATE_DAY:
        # –î–µ–Ω—å - –≤—Å–µ –∏–≥—Ä–æ–∫–∏ (–∂–∏–≤—ã–µ + –º–µ—Ä—Ç–≤—ã–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–∏)
        recipients = [slot for slot in game_data.get('players_slots', []) 
                     if slot.get('user_id')]
    
    elif game_state == STATE_NIGHT and sender_role in [ROLE_MAFIA_DON, ROLE_MAFIA]:
        # –ù–æ—á—å - —Ç–æ–ª—å–∫–æ —á–ª–µ–Ω—ã –º–∞—Ñ–∏–∏
        recipients = [slot for slot in game_data.get('players_slots', []) 
                     if (slot.get('user_id') and 
                         slot.get('status') == STATUS_ACTIVE and 
                         slot.get('role') in [ROLE_MAFIA_DON, ROLE_MAFIA])]
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º (–∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
    for slot in recipients:
        user_id = slot.get('user_id')
        if user_id != sender_user_id:  # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ
            try:
                await context.bot.send_message(
                    chat_id=user_id,
                    text=formatted_message,
                    parse_mode=None  # –£–±–∏—Ä–∞–µ–º markdown –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫
                )
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

async def handle_game_chat_message(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏–≥—Ä–æ–≤–æ–º —á–∞—Ç–µ"""
    user_id = update.effective_user.id
    message_text = update.message.text
    
    # –ù–∞—Ö–æ–¥–∏–º –∏–≥—Ä–æ–≤—É—é —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    game_id, game_data, player_slot = await find_player_game_session(user_id)
    
    if not game_data:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ –∏–≥—Ä–µ, –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
        await handle_player_count_input(update, context)
        return
        
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ç–∞–π–º–µ—Ä-–∏–≥—Ä–µ (–æ–∂–∏–¥–∞–µ—Ç —Å—Ç–∞—Ä—Ç–∞)
    if game_data.get('state') == STATE_TIMER_WAITING:
        await update.message.reply_text(
            "‚è∞ –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä-–∏–≥—Ä—ã!\n\n"
            "–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É, —Å–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∏–Ω—å—Ç–µ —Ç–µ–∫—É—â—É—é.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –∏ –≤—ã–±–µ—Ä–∏—Ç–µ '–ü–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É'."
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –∏–≥—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
    can_send, error_message = can_player_send_message(game_data, player_slot)
    
    # –û—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –º–µ—Ä—Ç–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–¥—Å–º–µ—Ä—Ç–Ω—É—é –∑–∞–ø–∏—Å–∫—É
    if not can_send and player_slot.get('status') != STATUS_ACTIVE:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ –ø—Ä–µ–¥—Å–º–µ—Ä—Ç–Ω—É—é –∑–∞–ø–∏—Å–∫—É
        if not player_slot.get('death_note_sent', False):
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—Å–º–µ—Ä—Ç–Ω—É—é –∑–∞–ø–∏—Å–∫—É
            player_slot['death_note_sent'] = True
            games[game_id] = game_data
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            fictional_name = player_slot.get('fictional_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')
            telegram_name = update.effective_user.first_name
            if update.effective_user.last_name:
                telegram_name += f" {update.effective_user.last_name}"
            username_part = f" (@{update.effective_user.username})" if update.effective_user.username else ""
            
            death_note_message = (
                f"üíÄüìú **–ü–†–ï–î–°–ú–ï–†–¢–ù–ê–Ø –ó–ê–ü–ò–°–ö–ê**\n\n"
                f"–û—Ç: {fictional_name} | {telegram_name}{username_part}\n\n"
                f"'{message_text}'\n\n"
                f"üïäÔ∏è _–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–≥—Ä–æ–±–Ω–æ–≥–æ –º–∏—Ä–∞..._"
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∂–∏–≤—ã–º –∏–≥—Ä–æ–∫–∞–º
            for slot in game_data.get('players_slots', []):
                if (slot.get('user_id') and 
                    slot.get('status') == STATUS_ACTIVE and 
                    slot.get('user_id') != user_id):
                    try:
                        await context.bot.send_message(
                            slot['user_id'],
                            death_note_message,
                            parse_mode=ParseMode.MARKDOWN
                        )
                    except Exception as e:
                        logger.error(f"Error sending death note to player {slot['user_id']}: {e}")
            
            # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
            await update.message.reply_text(
                "üìú **–ü—Ä–µ–¥—Å–º–µ—Ä—Ç–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!**\n\n"
                "–í–∞—à–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –∂–∏–≤—ã–º –∏–≥—Ä–æ–∫–∞–º.\n"
                "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –∏–≥—Ä–æ–π."
            )
            return
        else:
            await update.message.reply_text(
                "üíÄ –í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –ø—Ä–µ–¥—Å–º–µ—Ä—Ç–Ω—É—é –∑–∞–ø–∏—Å–∫—É.\n"
                "–ú–µ—Ä—Ç–≤—ã–µ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –∏–≥—Ä–æ–π."
            )
            return
    
    if not can_send:
        await update.message.reply_text(error_message)
        return
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    formatted_message = format_chat_message(player_slot, update.effective_user, message_text)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º (–±–µ–∑ —Ñ–∞–∑–æ–≤–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞)
    await send_message_to_game_participants(game_id, game_data, formatted_message, user_id, context)
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
    game_state = game_data.get('state')
    if game_state == STATE_DAY:
        confirmation_text = "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –∂–∏–≤—ã–º –∏–≥—Ä–æ–∫–∞–º"
    elif game_state == STATE_NIGHT:
        confirmation_text = "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–ª–µ–Ω–∞–º –º–∞—Ñ–∏–∏"
    else:
        confirmation_text = "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —É–¥–∞–ª—è–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    confirmation_message = await update.message.reply_text(confirmation_text)
    
    # –ü–ª–∞–Ω–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    async def delete_confirmation():
        import asyncio
        await asyncio.sleep(2)
        try:
            await context.bot.delete_message(
                chat_id=confirmation_message.chat_id,
                message_id=confirmation_message.message_id
            )
        except:
            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è (—Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –º–æ–≥–ª–æ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω–æ)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ
    import asyncio
    asyncio.create_task(delete_confirmation())

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    print("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Telegram-–±–æ—Ç–∞ –ú–∞—Ñ–∏—è...")
    print("‚úÖ –¢–æ–∫–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–æ–∫—Å–∏
    # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—Ä–æ–∫—Å–∏, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏:
    # proxy_url = "http://your-proxy-server:port"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –ø—Ä–æ–∫—Å–∏
    # application = ApplicationBuilder().token(TOKEN).proxy_url(proxy_url).build()
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–µ–∑ –ø—Ä–æ–∫—Å–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    application = ApplicationBuilder().token(TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("manage", manage_game_command))
    application.add_handler(CommandHandler("premium", premium_command))
    application.add_handler(CommandHandler("premium_admin", premium_admin_command))
    application.add_handler(CommandHandler("demo", activate_demo_command))
    application.add_handler(CallbackQueryHandler(button_callback_handler))
    
    # –í–ê–ñ–ù–û: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —á–∞—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–û –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_game_chat_message))
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
    application.add_handler(PreCheckoutQueryHandler(precheckout_callback))
    application.add_handler(MessageHandler(filters.SUCCESSFUL_PAYMENT, successful_payment_callback))
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    print("üé≠ –ë–æ—Ç –ú–∞—Ñ–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print("üí¨ –°–∏—Å—Ç–µ–º–∞ –≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–æ–≥–æ —á–∞—Ç–∞ –∞–∫—Ç–∏–≤–Ω–∞!")
    application.run_polling()

async def check_bot_info():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ –ø–æ —Ç–æ–∫–µ–Ω—É"""
    try:
        import aiohttp
        async with aiohttp.ClientSession() as session:
            url = f"https://api.telegram.org/bot{TOKEN}/getMe"
            async with session.get(url) as response:
                if response.status == 200:
                    data = await response.json()
                    bot_info = data.get('result', {})
                    print(f"ü§ñ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ:")
                    print(f"   ID: {bot_info.get('id')}")
                    print(f"   –ò–º—è: {bot_info.get('first_name')}")
                    print(f"   Username: @{bot_info.get('username')}")
                    print(f"   –≠—Ç–æ –±–æ—Ç: {bot_info.get('is_bot')}")
                    return bot_info.get('username')
                else:
                    print(f"‚ùå –û—à–∏–±–∫–∞ API: {response.status}")
                    return None
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–æ—Ç–∞: {e}")
        return None

# === –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –ß–ï–õ–û–í–ï–ö–ê-–í–ï–î–£–©–ï–ì–û ===

def get_main_control_keyboard(game_id: str) -> InlineKeyboardMarkup:
    """–û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ"""
    keyboard = [
        [InlineKeyboardButton("üåÉ –û–±—ä—è–≤–∏—Ç—å –ù–æ—á—å", callback_data=f"night_{game_id}"),
         InlineKeyboardButton("‚òÄÔ∏è –û–±—ä—è–≤–∏—Ç—å –î–µ–Ω—å", callback_data=f"day_{game_id}")],
        [InlineKeyboardButton("üî™ –ò—Å–∫–ª—é—á–∏—Ç—å –ò–≥—Ä–æ–∫–∞", callback_data=f"show_elim_list_{game_id}")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç—É—Å –ò–≥—Ä—ã", callback_data=f"status_{game_id}"),
         InlineKeyboardButton("üõë –ó–∞–≤–µ—Ä—à–∏—Ç—å –ò–≥—Ä—É", callback_data=f"end_{game_id}")]
    ]
    return InlineKeyboardMarkup(keyboard)

def get_player_elimination_keyboard(game_id: str, game_data: dict) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è"""
    active_players = [slot for slot in game_data.get('players_slots', []) 
                     if slot.get('user_id') and slot.get('status') == STATUS_ACTIVE]
    
    buttons = []
    for slot in sorted(active_players, key=lambda x: x.get('player_number_for_host', 0)):
        player_num = slot.get('player_number_for_host', 0)
        name = get_player_display_name(slot)
        buttons.append(InlineKeyboardButton(f"{player_num}. {name}", 
                                          callback_data=f"elim_{game_id}_{player_num}"))
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ 2 –≤ —Ä—è–¥—É
    keyboard_rows = []
    for i in range(0, len(buttons), 2):
        keyboard_rows.append(buttons[i:i+2])
    
    keyboard_rows.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é", callback_data=f"manage_{game_id}")])
    return InlineKeyboardMarkup(keyboard_rows)

def get_night_host_keyboard(game_id: str, game_data: dict) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–æ—á–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏"""
    keyboard_rows = []
    night_data = game_data.get("night_data", {})
    roles_to_act = night_data.get("roles_to_act", [])
    acted_roles = night_data.get("acted_roles", set())
    actions_taken = night_data.get("actions_taken_by_role", {})

    role_display_names = {
        "–ú–∞—Ñ–∏—è": "–ú–∞—Ñ–∏—è", "–î–æ–∫—Ç–æ—Ä": "–î–æ–∫—Ç–æ—Ä", "–ö–æ–º–∏—Å—Å–∞—Ä": "–ö–æ–º–∏—Å—Å–∞—Ä", 
        "–ú–∞–Ω—å—è–∫": "–ú–∞–Ω—å—è–∫", "–ü—É—Ç–∞–Ω–∞": "–ü—É—Ç–∞–Ω–∞"
    }

    buttons_for_roles = []
    for role_key in roles_to_act:
        display_name = role_display_names.get(role_key, role_key)
        if role_key in acted_roles:
            target_num = actions_taken.get(role_key)
            target_name = ""
            if target_num is not None:
                for slot in game_data.get("players_slots", []):
                    if slot.get("player_number_for_host") == target_num:
                        target_name = f" ({slot.get('fictional_name', '')})"
                        break
            buttons_for_roles.append(
                InlineKeyboardButton(f"‚úÖ {display_name} (–≤—ã–±—Ä–∞–ª {target_num}{target_name})", 
                                   callback_data=f"night_info_{game_id}_{role_key}")
            )
        else:
            buttons_for_roles.append(
                InlineKeyboardButton(f"‚û°Ô∏è –•–æ–¥: {display_name}", 
                                   callback_data=f"night_role_turn_{game_id}_{role_key}")
            )

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ 2 –≤ —Ä—è–¥—É
    for i in range(0, len(buttons_for_roles), 2):
        keyboard_rows.append(buttons_for_roles[i:i+2])

    keyboard_rows.append([InlineKeyboardButton("‚òÄÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å –Ω–æ—á—å –∏ –Ω–∞—á–∞—Ç—å –¥–µ–Ω—å", callback_data=f"night_end_{game_id}")])
    return InlineKeyboardMarkup(keyboard_rows)

def get_player_selection_keyboard_for_night_action(game_id: str, game_data: dict, acting_role_key: str) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏ –Ω–æ—á–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è"""
    keyboard_rows = []
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    active_players = [slot for slot in game_data.get('players_slots', []) 
                     if slot.get('user_id') and slot.get('status') == STATUS_ACTIVE]
    
    # –ù–∞—Ö–æ–¥–∏–º –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∞–º–æ–≤—ã–±–æ—Ä–∞)
    acting_player = None
    for slot in active_players:
        if acting_role_key == "–ú–∞—Ñ–∏—è" and slot.get('role') in ["–î–æ–Ω –ú–∞—Ñ–∏–∏", "–ú–∞—Ñ–∏–æ–∑–∏"]:
            acting_player = slot
            break
        elif slot.get('role') == acting_role_key:
            acting_player = slot
            break
    
    buttons = []
    for slot in sorted(active_players, key=lambda x: x.get('player_number_for_host', 0)):
        player_num = slot.get('player_number_for_host', 0)
        name = get_player_display_name(slot)
        
        # –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–æ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –≤—ã–±–∏—Ä–∞—Ç—å —Å–µ–±—è
        if (acting_player and 
            player_num == acting_player.get('player_number_for_host') and 
            acting_role_key in ["–ú–∞—Ñ–∏—è", "–ü—É—Ç–∞–Ω–∞", "–ú–∞–Ω—å—è–∫"]):
            continue
            
        buttons.append(InlineKeyboardButton(f"{player_num}. {name}", 
                                          callback_data=f"night_action_{game_id}_{acting_role_key}_{player_num}"))
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ 2 –≤ —Ä—è–¥—É
    for i in range(0, len(buttons), 2):
        keyboard_rows.append(buttons[i:i+2])
    
    keyboard_rows.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Ä–æ–ª–∏", callback_data=f"night_return_to_main_{game_id}")])
    return InlineKeyboardMarkup(keyboard_rows)

async def manage_game_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /manage –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π"""
    user_id = update.effective_user.id
    game_id_arg = context.args[0] if context.args else None
    
    # –ò—â–µ–º –∏–≥—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    host_games = [gid for gid, gdata in games.items() 
                  if gdata.get('host_id') == user_id and gdata.get('state') != 'finished']
    
    if not host_games:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É —á–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.")
        return
    
    if len(host_games) > 1 and not game_id_arg:
        games_list = "\n".join([f"‚Ä¢ {gid}" for gid in host_games])
        await update.message.reply_text(f"–£ –≤–∞—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä:\n{games_list}\n\n–£–∫–∞–∂–∏—Ç–µ ID: /manage <ID_–∏–≥—Ä—ã>")
        return
    
    game_id = game_id_arg or host_games[0]
    
    if game_id not in games:
        await update.message.reply_text(f"–ò–≥—Ä–∞ {game_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return
    
    game_data = games[game_id]
    
    if game_data.get('host_id') != user_id:
        await update.message.reply_text("–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –≤–µ–¥—É—â–∏–º —ç—Ç–æ–π –∏–≥—Ä—ã.")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –∏–≥—Ä—ã
    if game_data.get('game_mode') == 'bot_host':
        await update.message.reply_text("‚ùå –í —Ä–µ–∂–∏–º–µ '–ë–æ—Ç-–≤–µ–¥—É—â–∏–π' —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.")
        return
    
    await update.message.reply_text(f"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π {game_id}:", 
                                  reply_markup=get_main_control_keyboard(game_id))

async def set_night_action(game_id: str, game_data: dict, query, context: CallbackContext):
    """–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –Ω–æ—á–Ω—É—é —Ñ–∞–∑—É"""
    game_data["current_night_number"] = game_data.get("current_night_number", 0) + 1
    game_data["state"] = STATE_NIGHT
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    active_roles = set()
    for slot in game_data.get("players_slots", []):
        if slot.get("user_id") and slot.get("status") == STATUS_ACTIVE:
            role = slot["role"]
            if role in ["–î–æ–Ω –ú–∞—Ñ–∏–∏", "–ú–∞—Ñ–∏–æ–∑–∏"]:
                active_roles.add("–ú–∞—Ñ–∏—è")
            elif role in ["–î–æ–∫—Ç–æ—Ä", "–ö–æ–º–∏—Å—Å–∞—Ä", "–ú–∞–Ω—å—è–∫", "–ü—É—Ç–∞–Ω–∞"]:
                active_roles.add(role)
    
    game_data["night_data"] = {
        "actions_taken_by_role": {},
        "roles_to_act": list(active_roles),
        "acted_roles": set(),
        "commissioner_check_result": None,
    }
    
    games[game_id] = game_data
    
    message = f"üåÉ –ù–æ—á—å {game_data['current_night_number']} –≤ –∏–≥—Ä–µ {game_id}. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π:"
    await query.edit_message_text(text=message, reply_markup=get_night_host_keyboard(game_id, game_data))

async def set_day_action(game_id: str, game_data: dict, query, context: CallbackContext):
    """–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –¥–Ω–µ–≤–Ω—É—é —Ñ–∞–∑—É"""
    if game_data.get('state') == STATE_DAY:
        await query.answer('–ò–≥—Ä–∞ —É–∂–µ –≤ –¥–Ω–µ–≤–Ω–æ–π —Ñ–∞–∑–µ.', show_alert=True)
        return
    
    game_data['state'] = STATE_DAY
    game_data["current_day_number"] = game_data.get("current_day_number", 0) + 1
    games[game_id] = game_data
    
    await query.edit_message_text(f'‚òÄÔ∏è –î–µ–Ω—å {game_data["current_day_number"]} –æ–±—ä—è–≤–ª–µ–Ω –≤ –∏–≥—Ä–µ {game_id}.', 
                                reply_markup=get_main_control_keyboard(game_id))
    await query.answer('–î–µ–Ω—å –æ–±—ä—è–≤–ª–µ–Ω.')

async def eliminate_player_action(game_id: str, game_data: dict, player_number: int, query, context: CallbackContext):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞"""
    for slot in game_data.get("players_slots", []):
        if slot.get("player_number_for_host") == player_number and slot.get("user_id"):
            if slot.get("status") == STATUS_ELIMINATED:
                await query.answer(f"–ò–≥—Ä–æ–∫ {player_number} —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω.", show_alert=True)
                return False
            
            slot["status"] = STATUS_ELIMINATED
            name = slot.get('fictional_name', f'–ò–≥—Ä–æ–∫ {player_number}')
            role = slot.get('role', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
            
            # –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏
            elimination_message = f"üî™ {name} (—Ä–æ–ª—å: {role}) –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ –∏–≥—Ä—ã {game_id}."
            await context.bot.send_message(chat_id=query.message.chat.id, text=elimination_message)
            
            games[game_id] = game_data
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é
            await query.edit_message_text(f"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π {game_id}:", 
                                        reply_markup=get_main_control_keyboard(game_id))
            return True
    
    await query.answer("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
    return False

async def game_status_action(game_id: str, game_data: dict, query, context: CallbackContext):
    """–ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã"""
    active_count = len([s for s in game_data.get('players_slots', []) 
                       if s.get('user_id') and s.get('status') == STATUS_ACTIVE])
    total_count = game_data.get('num_players', 0)
    
    status_message = (f"üìä –°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã {game_id}\n"
                     f"–°–æ—Å—Ç–æ—è–Ω–∏–µ: {game_data.get('state', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
                     f"–î–µ–Ω—å: {game_data.get('current_day_number', 0)}\n"
                     f"–ù–æ—á—å: {game_data.get('current_night_number', 0)}\n"
                     f"–ê–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: {active_count}/{total_count}\n\n"
                     f"–ò–≥—Ä–æ–∫–∏:\n")
    
    for slot in sorted(game_data.get('players_slots', []), 
                      key=lambda x: x.get('player_number_for_host', 0)):
        if slot.get('user_id'):
            num = slot.get('player_number_for_host', 0)
            name = slot.get('fictional_name', f'–ò–≥—Ä–æ–∫ {num}')
            role = slot.get('role', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
            status = "üü¢" if slot.get('status') == STATUS_ACTIVE else "üî¥"
            status_message += f"{status} {num}. {name} - {role}\n"
    
    await query.answer(status_message, show_alert=True)

async def end_game_action(game_id: str, game_data: dict, query, context: CallbackContext):
    """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã"""
    game_data['state'] = 'finished'
    games[game_id] = game_data
    
    await query.edit_message_text(f"üõë –ò–≥—Ä–∞ {game_id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤–µ–¥—É—â–∏–º.")
    await query.answer("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

async def get_detailed_night_summary_for_host(game_id: str, game_data: dict, actions: dict) -> str:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –∫—Ä–∞—Å–∏–≤—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω—É—é —Å–≤–æ–¥–∫—É –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ"""
    night_number = game_data.get("current_night_number", 0)
    summary = f"üåÉ **–ù–û–ß–ù–ê–Ø –•–†–û–ù–ò–ö–ê #{night_number}**\n\n"
    
    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –∏–≥—Ä–æ–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É
    def get_player_name_by_number(player_num):
        for slot in game_data.get("players_slots", []):
            if slot.get("player_number_for_host") == player_num:
                return slot.get('fictional_name', f'–ò–≥—Ä–æ–∫ {player_num}')
        return f"–ò–≥—Ä–æ–∫ {player_num}"
    
    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–∏ –∏–≥—Ä–æ–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É
    def get_player_role_by_number(player_num):
        for slot in game_data.get("players_slots", []):
            if slot.get("player_number_for_host") == player_num:
                return slot.get('role', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    
    night_events = []
    
    # –î–µ–π—Å—Ç–≤–∏—è –ú–∞—Ñ–∏–∏ - –¥—Ä–∞–º–∞—Ç–∏—á–Ω–æ
    if "–ú–∞—Ñ–∏—è" in actions:
        target_num = actions["–ú–∞—Ñ–∏—è"]
        target_name = get_player_name_by_number(target_num)
        night_events.append(
            f"üî™ **–í —Ç–µ–º–Ω—ã—Ö –ø–µ—Ä–µ—É–ª–∫–∞—Ö –≥–æ—Ä–æ–¥–∞ —Ä–∞–∑–¥–∞–ª–∏—Å—å —Ç–∏—Ö–∏–µ —à–∞–≥–∏...**\n"
            f"   –ú–∞—Ñ–∏—è –≤—ã–±—Ä–∞–ª–∞ —Å–≤–æ—é –∂–µ—Ä—Ç–≤—É: **{target_name}** (#{target_num})\n"
            f"   *–•–æ–ª–æ–¥–Ω—ã–π –º–µ—Ç–∞–ª–ª –±–ª–µ—Å–Ω—É–ª –≤ –ª—É–Ω–Ω–æ–º —Å–≤–µ—Ç–µ...*"
        )
    
    # –î–µ–π—Å—Ç–≤–∏—è –î–æ–∫—Ç–æ—Ä–∞ - –≥–µ—Ä–æ–∏—á–Ω–æ
    if "–î–æ–∫—Ç–æ—Ä" in actions:
        target_num = actions["–î–æ–∫—Ç–æ—Ä"]
        target_name = get_player_name_by_number(target_num)
        night_events.append(
            f"üè• **–°–∫–≤–æ–∑—å –Ω–æ—á–Ω—É—é —Ç–∏—à–∏–Ω—É –ø—Ä–æ–∫—Ä–∞–ª–∏—Å—å —Å–ø–∞—Å–∏—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏...**\n"
            f"   –î–æ–∫—Ç–æ—Ä –∑–∞—â–∏—Ç–∏–ª: **{target_name}** (#{target_num})\n"
            f"   *–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å—É–º–∫–∞ —Ç–∏—Ö–æ –∑–≤—è–∫–Ω—É–ª–∞ –≤ —Ç–µ–º–Ω–æ—Ç–µ...*"
        )
    
    # –î–µ–π—Å—Ç–≤–∏—è –ö–æ–º–∏—Å—Å–∞—Ä–∞ - –¥–µ—Ç–µ–∫—Ç–∏–≤–Ω–æ
    if "–ö–æ–º–∏—Å—Å–∞—Ä" in actions:
        target_num = actions["–ö–æ–º–∏—Å—Å–∞—Ä"]
        target_name = get_player_name_by_number(target_num)
        target_role = get_player_role_by_number(target_num)
        is_mafia = target_role in ["–î–æ–Ω –ú–∞—Ñ–∏–∏", "–ú–∞—Ñ–∏–æ–∑–∏"]
        result = "üî¥ –ú–ê–§–ò–Ø" if is_mafia else "üü¢ –ú–ò–†–ù–´–ô –ñ–ò–¢–ï–õ–¨"
        night_events.append(
            f"üïµÔ∏è **–î–µ—Ç–µ–∫—Ç–∏–≤ –≤–µ–ª —Å–≤–æ–µ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤ –Ω–æ—á–Ω–æ–π —Ç–µ–Ω–∏...**\n"
            f"   –ö–æ–º–∏—Å—Å–∞—Ä –ø—Ä–æ–≤–µ—Ä–∏–ª: **{target_name}** (#{target_num})\n"
            f"   *–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è: {result}*\n"
            f"   *–ë–ª–æ–∫–Ω–æ—Ç –¥–µ—Ç–µ–∫—Ç–∏–≤–∞ –ø–æ–ø–æ–ª–Ω–∏–ª—Å—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å—å—é...*"
        )
    
    # –î–µ–π—Å—Ç–≤–∏—è –ú–∞–Ω—å—è–∫–∞ - –∑–ª–æ–≤–µ—â–µ
    if "–ú–∞–Ω—å—è–∫" in actions:
        target_num = actions["–ú–∞–Ω—å—è–∫"]
        target_name = get_player_name_by_number(target_num)
        night_events.append(
            f"üî• **–ë–µ–∑—É–º–Ω—ã–π —Å–º–µ—Ö –ø—Ä–æ–∑–≤—É—á–∞–ª –≤ –Ω–æ—á–Ω–æ–π —Ç–∏—à–∏–Ω–µ...**\n"
            f"   –ú–∞–Ω—å—è–∫ –≤—ã–±—Ä–∞–ª —Å–≤–æ—é –∂–µ—Ä—Ç–≤—É: **{target_name}** (#{target_num})\n"
            f"   *–•–∞–æ—Å –∏ –±–µ–∑—É–º–∏–µ –≤–æ—Ü–∞—Ä–∏–ª–∏—Å—å –≤ —Ç–µ–º–Ω—ã—Ö —É–ª–∏—Ü–∞—Ö...*"
        )
    
    # –î–µ–π—Å—Ç–≤–∏—è –ü—É—Ç–∞–Ω—ã - –∑–∞–≥–∞–¥–æ—á–Ω–æ
    if "–ü—É—Ç–∞–Ω–∞" in actions:
        target_num = actions["–ü—É—Ç–∞–Ω–∞"]
        target_name = get_player_name_by_number(target_num)
        target_role = get_player_role_by_number(target_num)
        night_events.append(
            f"üö´ **–ß–∞—Ä—É—é—â–∏–π —Å–∏–ª—É—ç—Ç —Å–∫–æ–ª—å–∑–Ω—É–ª –ø–æ –Ω–æ—á–Ω—ã–º —É–ª–∏—Ü–∞–º...**\n"
            f"   –ü—É—Ç–∞–Ω–∞ –æ—á–∞—Ä–æ–≤–∞–ª–∞: **{target_name}** (#{target_num})\n"
            f"   *–†–æ–ª—å –∂–µ—Ä—Ç–≤—ã: {target_role}*\n"
            f"   *–ú–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∞—Ä—ã –Ω–∞ —ç—Ç—É –Ω–æ—á—å –ª–∏—à–∏–ª–∏ —Ü–µ–ª—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π...*"
        )
    
    if night_events:
        summary += "\n\n".join(night_events)
        summary += "\n\n" + "‚îÄ" * 30
        summary += "\n\nüé≠ **–î–õ–Ø –ó–ê–ß–ò–¢–´–í–ê–ù–ò–Ø –ò–ì–†–û–ö–ê–ú:**\n"
        summary += "*–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã*"
    else:
        summary += "üåô **–ù–æ—á—å –æ–∫—É—Ç–∞–ª–∞ –≥–æ—Ä–æ–¥ –ø–æ–∫—Ä–æ–≤–æ–º —Ç–∏—à–∏–Ω—ã...**\n"
        summary += "üò¥ *–ù–∏–∫—Ç–æ –Ω–µ —Ä–µ—à–∏–ª—Å—è –Ω–∞—Ä—É—à–∏—Ç—å –º–∏—Ä–Ω—ã–π —Å–æ–Ω –∂–∏—Ç–µ–ª–µ–π.*\n\n"
        summary += "üé≠ **–î–õ–Ø –ó–ê–ß–ò–¢–´–í–ê–ù–ò–Ø:** '–ù–æ—á—å –ø—Ä–æ—à–ª–∞ —Å–ø–æ–∫–æ–π–Ω–æ...'"
    
    summary += "\n\nüìã **–≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—Å –∫–∞–∫ –≤–µ–¥—É—â–µ–≥–æ.**"
    
    return summary

async def resolve_night_actions_and_announce_day(game_id: str, game_data: dict, query, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–æ—á–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ –¥–Ω—é –≤ —Ä–µ–∂–∏–º–µ —á–µ–ª–æ–≤–µ–∫–∞-–≤–µ–¥—É—â–µ–≥–æ"""
    night_data = game_data.get("night_data", {})
    actions = night_data.get("actions_taken_by_role", {})
    
    # –°–ù–ê–ß–ê–õ–ê –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é —Å–≤–æ–¥–∫—É –≤–µ–¥—É—â–µ–º—É
    try:
        detailed_summary = await get_detailed_night_summary_for_host(game_id, game_data, actions)
        await context.bot.send_message(
            chat_id=query.from_user.id,
            text=detailed_summary,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Error sending detailed night summary to host: {e}")
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è
    killed_players = []
    saved_players = []
    commissioner_result = ""
    
    # –£–±–∏–π—Å—Ç–≤–∞ (–ú–∞—Ñ–∏—è, –ú–∞–Ω—å—è–∫)
    if "–ú–∞—Ñ–∏—è" in actions:
        killed_players.append(actions["–ú–∞—Ñ–∏—è"])
    if "–ú–∞–Ω—å—è–∫" in actions:
        killed_players.append(actions["–ú–∞–Ω—å—è–∫"])
    
    # –°–ø–∞—Å–µ–Ω–∏–µ –¥–æ–∫—Ç–æ—Ä–æ–º
    if "–î–æ–∫—Ç–æ—Ä" in actions:
        doctor_target = actions["–î–æ–∫—Ç–æ—Ä"]
        if doctor_target in killed_players:
            killed_players.remove(doctor_target)
            saved_players.append(doctor_target)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∏—Å—Å–∞—Ä–∞
    if "–ö–æ–º–∏—Å—Å–∞—Ä" in actions:
        commissioner_target = actions["–ö–æ–º–∏—Å—Å–∞—Ä"]
        target_slot = None
        for slot in game_data.get("players_slots", []):
            if slot.get("player_number_for_host") == commissioner_target:
                target_slot = slot
                break
        
        if target_slot:
            target_name = target_slot.get('fictional_name', f'–ò–≥—Ä–æ–∫ {commissioner_target}')
            target_role = target_slot.get('role', '')
            is_mafia = target_role in ["–î–æ–Ω –ú–∞—Ñ–∏–∏", "–ú–∞—Ñ–∏–æ–∑–∏"]
            commissioner_result = f"–ö–æ–º–∏—Å—Å–∞—Ä –ø—Ä–æ–≤–µ—Ä–∏–ª {target_name}: {'–ú–∞—Ñ–∏—è' if is_mafia else '–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å'}"
    
    # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—É—Ç–∞–Ω–æ–π (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
    blocked_info = ""
    if "–ü—É—Ç–∞–Ω–∞" in actions:
        blocked_target = actions["–ü—É—Ç–∞–Ω–∞"]
        for slot in game_data.get("players_slots", []):
            if slot.get("player_number_for_host") == blocked_target:
                blocked_name = slot.get('fictional_name', f'–ò–≥—Ä–æ–∫ {blocked_target}')
                blocked_info = f"–ü—É—Ç–∞–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ {blocked_name}"
                break
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —É–±–∏–π—Å—Ç–≤–∞
    for player_num in killed_players:
        for slot in game_data.get("players_slots", []):
            if slot.get("player_number_for_host") == player_num:
                slot["status"] = STATUS_ELIMINATED
                break
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–Ω—é
    game_data["state"] = STATE_DAY
    game_data["current_day_number"] = game_data.get("current_day_number", 0) + 1
    
    # –û—á–∏—â–∞–µ–º –Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if "night_data" in game_data:
        del game_data["night_data"]
    
    games[game_id] = game_data
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –Ω–æ—á–∏
    results_message = f"‚òÄÔ∏è –ù–∞—Å—Ç—É–ø–∏–ª –¥–µ–Ω—å {game_data['current_day_number']} –≤ –∏–≥—Ä–µ {game_id}!\n\n"
    
    if killed_players:
        results_message += "üíÄ –≠—Ç–æ–π –Ω–æ—á—å—é –ø–æ–≥–∏–±–ª–∏:\n"
        for player_num in killed_players:
            for slot in game_data.get("players_slots", []):
                if slot.get("player_number_for_host") == player_num:
                    name = slot.get('fictional_name', f'–ò–≥—Ä–æ–∫ {player_num}')
                    role = slot.get('role', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                    results_message += f"‚Ä¢ {name} (—Ä–æ–ª—å: {role})\n"
        results_message += "\n"
    else:
        results_message += "üõ°Ô∏è –≠—Ç–æ–π –Ω–æ—á—å—é –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–≥–∏–±.\n\n"
    
    if saved_players:
        results_message += "üè• –î–æ–∫—Ç–æ—Ä —Å–ø–∞—Å –∏–≥—Ä–æ–∫–∞ –æ—Ç —Å–º–µ—Ä—Ç–∏!\n\n"
    
    if commissioner_result:
        results_message += f"üïµÔ∏è {commissioner_result}\n\n"
    
    if blocked_info:
        results_message += f"üö´ {blocked_info}\n\n"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–¥—É—â–µ–º—É
    await query.edit_message_text(results_message + "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π:", 
                                reply_markup=get_main_control_keyboard(game_id))
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –æ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –¥–Ω—è (–û–ë–ï–ó–õ–ò–ß–ï–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø)
    public_message = f"‚òÄÔ∏è –ù–∞—Å—Ç—É–ø–∏–ª –¥–µ–Ω—å {game_data['current_day_number']}!\n\n"
    
    if killed_players:
        # –û–±–µ–∑–ª–∏—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É–±–∏–π—Å—Ç–≤–∞—Ö
        death_count = len(killed_players)
        if death_count == 1:
            public_message += "üíÄ –≠—Ç–æ–π –Ω–æ—á—å—é –∫—Ç–æ-—Ç–æ –±—ã–ª –∂–µ—Å—Ç–æ–∫–æ —É–±–∏—Ç...\n"
            public_message += "üîç –ñ–∏—Ç–µ–ª–∏ –≥–æ—Ä–æ–¥–∞ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ —Ç–µ–ª–æ –Ω–∞ —Ä–∞—Å—Å–≤–µ—Ç–µ."
        else:
            public_message += f"üíÄ –≠—Ç–æ–π –Ω–æ—á—å—é {death_count} —á–µ–ª–æ–≤–µ–∫–∞ –ø–æ–≥–∏–±–ª–∏...\n"
            public_message += "üò± –ì–æ—Ä–æ–¥ –æ—Ö–≤–∞—Ç–∏–ª —É–∂–∞—Å –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É–±–∏–π—Å—Ç–≤."
    elif saved_players:
        # –ï—Å–ª–∏ –¥–æ–∫—Ç–æ—Ä —Å–ø–∞—Å, –Ω–æ –Ω–∏–∫—Ç–æ –Ω–µ —É–º–µ—Ä
        public_message += "üåÖ –ù–æ—á—å –ø—Ä–æ—à–ª–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ...\n"
        public_message += "üè• –ö—Ç–æ-—Ç–æ —Å–ª—ã—à–∞–ª —à–∞–≥–∏ –≤—Ä–∞—á–∞ –≤ —Ç–µ–º–Ω–æ—Ç–µ."
    else:
        # –ù–∏–∫—Ç–æ –Ω–µ —É–º–µ—Ä –∏ –Ω–∏–∫–æ–≥–æ –Ω–µ —Å–ø–∞—Å–∞–ª–∏
        mysterious_messages = [
            "üåô –ù–æ—á—å –ø—Ä–æ—à–ª–∞ –≤ —Ç—Ä–µ–≤–æ–∂–Ω–æ–º –º–æ–ª—á–∞–Ω–∏–∏...",
            "üò¥ –ì–æ—Ä–æ–¥ —Å–ø–∞–ª –±–µ—Å–ø–æ–∫–æ–π–Ω—ã–º —Å–Ω–æ–º...", 
            "üå´Ô∏è –í —Ç—É–º–∞–Ω–µ –Ω–æ—á–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ...",
            "ü¶â –¢–æ–ª—å–∫–æ —Å–æ–≤—ã –±—ã–ª–∏ —Å–≤–∏–¥–µ—Ç–µ–ª—è–º–∏ —Ç–∞–π–Ω —ç—Ç–æ–π –Ω–æ—á–∏...",
            "‚≠ê –ó–≤–µ–∑–¥—ã —Ö—Ä–∞–Ω—è—Ç —Å–µ–∫—Ä–µ—Ç—ã –ø—Ä–æ—à–µ–¥—à–µ–π –Ω–æ—á–∏..."
        ]
        import random
        public_message += random.choice(mysterious_messages)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º
    for slot in game_data.get("players_slots", []):
        if slot.get("user_id"):
            try:
                await context.bot.send_message(slot["user_id"], public_message)
            except:
                pass

    # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–Ω–µ–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã
    import asyncio
    asyncio.create_task(start_day_voting_after_delay(game_id, context))

    games[game_id] = game_data

# === –ö–û–ù–ï–¶ –°–ò–°–¢–ï–ú–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ===

async def handle_premium_purchase(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∫—É–ø–∫–∏ –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø–∞"""
    user = update.effective_user
    query = update.callback_query if update.callback_query else None
    
    # –°–æ–∑–¥–∞–µ–º –∏–Ω–≤–æ–π—Å –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø—Ä–µ–º–∏—É–º–∞
    title = "üíé –ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –ú–∞—Ñ–∏—è"
    description = (
        "üéÆ –î–æ 20 –∏–≥—Ä–æ–∫–æ–≤\n"
        "ü§ñ –í–µ–¥—É—â–∏–π-–±–æ—Ç\n" 
        "üé≠ –í—Å–µ —Ä–æ–ª–∏\n"
        "‚öôÔ∏è –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞\n"
        "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
    )
    
    payload = f"premium_user_{user.id}"
    currency = "RUB"
    prices = [LabeledPrice("–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø", PREMIUM_PRICE_KOPECKS)]
    
    try:
        await context.bot.send_invoice(
            chat_id=user.id,
            title=title,
            description=description,
            payload=payload,
            provider_token=PAYMENT_PROVIDER_TOKEN,
            currency=currency,
            prices=prices,
            start_parameter="premium_purchase",
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            need_email=False,
            need_phone_number=False,
            need_shipping_address=False,
            send_phone_number_to_provider=False,
            send_email_to_provider=False,
            is_flexible=False
        )
        
        if query:
            await query.answer("–ò–Ω–≤–æ–π—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è!")
            
    except Exception as e:
        logger.error(f"Error sending invoice: {e}")
        if query:
            await query.answer("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞", show_alert=True)

async def precheckout_callback(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞"""
    query = update.pre_checkout_query
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º payload
    if query.invoice_payload.startswith("premium_user_"):
        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂
        await query.answer(ok=True)
        logger.info(f"Pre-checkout approved for user {query.from_user.id}")
    else:
        # –û—Ç–∫–ª–æ–Ω—è–µ–º –ø–ª–∞—Ç–µ–∂
        await query.answer(ok=False, error_message="–ù–µ–≤–µ—Ä–Ω—ã–π payload –ø–ª–∞—Ç–µ–∂–∞")
        logger.error(f"Invalid payload in pre-checkout: {query.invoice_payload}")

async def successful_payment_callback(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
    user = update.effective_user
    payment = update.message.successful_payment
    
    logger.info(f"Successful payment from user {user.id}: {payment.total_amount} {payment.currency}")
    
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–µ–º–∏—É–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (30 –¥–Ω–µ–π)
    success = premium_db.add_premium_user(
        user.id, 
        transaction_id=payment.telegram_payment_charge_id,
        duration_days=30
    )
    
    if success:
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–µ
        user_info = premium_db.get_user_info(user.id)
        expire_date = user_info.get("expires_at", "")
        if expire_date:
            from datetime import datetime
            try:
                expire_dt = datetime.fromisoformat(expire_date)
                expire_str = expire_dt.strftime("%d.%m.%Y")
            except:
                expire_str = "30 –¥–Ω–µ–π"
        else:
            expire_str = "30 –¥–Ω–µ–π"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        await update.message.reply_text(
            f"üéâ **–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–∫—É–ø–∫–æ–π –ø—Ä–µ–º–∏—É–º–∞!**\n\n"
            f"üíé –¢–µ–ø–µ—Ä—å –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:\n"
            f"‚Ä¢ üéÆ –ò–≥—Ä—ã –¥–æ 20 –∏–≥—Ä–æ–∫–æ–≤\n"
            f"‚Ä¢ ü§ñ –í–µ–¥—É—â–∏–π-–±–æ—Ç\n" 
            f"‚Ä¢ üé≠ –í—Å–µ —Ä–æ–ª–∏\n"
            f"‚Ä¢ ‚öôÔ∏è –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π\n\n"
            f"üìÖ **–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ**: {expire_str}\n"
            f"üìÑ **–ß–µ–∫ –ø–ª–∞—Ç–µ–∂–∞**: `{payment.telegram_payment_charge_id}`",
            parse_mode=ParseMode.MARKDOWN
        )
    else:
        await update.message.reply_text(
            "‚ùå **–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–µ–º–∏—É–º–∞**\n\n"
            "–ü–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω, –Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏. "
            "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã.",
            parse_mode=ParseMode.MARKDOWN
        )

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∞–º–∏
from premium_database import premium_db

def check_premium_status(user_id: int):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏—Å–ø–æ–ª—å–∑—É—è –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö)"""
    return premium_db.check_premium_status(user_id)

async def activate_demo_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ 14-–¥–Ω–µ–≤–Ω–æ–π –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–µ–º–æ
    if not premium_db.can_activate_demo(user_id):
        is_premium, status = premium_db.check_premium_status(user_id)
        user_data = premium_db.get_user_info(user_id)
        
        if user_data and user_data.get("demo_used", False):
            await update.message.reply_text(
                "‚ùå **–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—é —Ä–∞–Ω–µ–µ**\n\n"
                "üíé –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–µ–º–∏—É–º-—Ñ—É–Ω–∫—Ü–∏—è–º –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π /premium",
                parse_mode='Markdown'
            )
        elif is_premium:
            if status == "demo":
                expire_str = user_data.get("expires_at") if user_data else None
                if expire_str:
                    try:
                        from datetime import datetime
                        expire_time = datetime.fromisoformat(expire_str)
                        await update.message.reply_text(
                            f"üéØ **–£ –≤–∞—Å —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è**\n\n"
                            f"‚è∞ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {expire_time.strftime('%d.%m.%Y –≤ %H:%M')}\n\n"
                            f"üíé –î–ª—è –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /premium",
                            parse_mode='Markdown'
                        )
                    except ValueError:
                        await update.message.reply_text("‚ùå –£ –≤–∞—Å —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è")
                else:
                    await update.message.reply_text("‚ùå –£ –≤–∞—Å —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è")
            else:
                await update.message.reply_text("üíé **–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∞!**")
        return
    
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –¥–µ–º–æ
    success, message = premium_db.activate_demo(user_id)
    
    if success:
        await update.message.reply_text(
            f"{message}\n\n"
            "üéÆ **–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ–º–∏—É–º-—Ñ—É–Ω–∫—Ü–∏–∏:**\n"
            "‚Ä¢ –ò–≥—Ä—ã –æ—Ç 4 –¥–æ 20 –∏–≥—Ä–æ–∫–æ–≤\n"
            "‚Ä¢ –í—Å–µ —Ä–æ–ª–∏ (–ú–∞–Ω—å—è–∫, –ö–æ–º–∏—Å—Å–∞—Ä, –ü—Ä–æ—Å—Ç–∏—Ç—É—Ç–∫–∞ –∏ –¥—Ä.)\n"
            "‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
            "‚Ä¢ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n\n"
            "üí° **–°–æ–≤–µ—Ç:** –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É –Ω–∞ 10+ –∏–≥—Ä–æ–∫–æ–≤ —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Ä–æ–ª–µ–π!\n\n"
            "üíé –ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å? –ü–æ–ª—É—á–∏—Ç–µ –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø: /premium",
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text(message)

async def premium_admin_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–æ–∫"""
    user_id = update.effective_user.id
    
    # –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ ID)
    ADMIN_IDS = [627786969]  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à Telegram ID
    
    if user_id not in ADMIN_IDS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
        return
    
    args = context.args
    if not args:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats = premium_db.get_stats()
        
        message = (
            f"üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫**\n\n"
            f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: **{stats['total_users']}**\n"
            f"üíé –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–º–∏—É–º: **{stats['active_premium']}**\n"
            f"üéØ –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–º–æ: **{stats['active_demo']}**\n"
            f"üß™ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –¥–µ–º–æ: **{stats['demo_used_total']}**\n"
            f"‚è∞ –ò—Å—Ç–µ–∫—à–∏–µ: **{stats['expired_premium']}**\n"
            f"üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ: **{stats['free_users']}**\n\n"
            f"**–ö–æ–º–∞–Ω–¥—ã:**\n"
            f"`/premium_admin add USER_ID DAYS` - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É\n"
            f"`/premium_admin demo USER_ID` - –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –¥–µ–º–æ\n"
            f"`/premium_admin extend USER_ID DAYS` - –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É\n"
            f"`/premium_admin check USER_ID` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å\n"
            f"`/premium_admin cleanup` - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–µ–∫—à–∏–µ\n"
            f"`/premium_admin stats` - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
        )
        
        await update.message.reply_text(message, parse_mode=ParseMode.MARKDOWN)
        return
    
    command = args[0].lower()
    
    if command == "add" and len(args) >= 3:
        try:
            target_user_id = int(args[1])
            days = int(args[2])
            success = premium_db.add_premium_user(target_user_id, duration_days=days)
            
            if success:
                await update.message.reply_text(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user_id} –Ω–∞ {days} –¥–Ω–µ–π")
            else:
                await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user_id}")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /premium_admin add USER_ID DAYS")
    
    elif command == "demo" and len(args) >= 2:
        try:
            target_user_id = int(args[1])
            success, message = premium_db.activate_demo(target_user_id)
            
            if success:
                await update.message.reply_text(f"‚úÖ –î–µ–º–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è {target_user_id}\n{message}")
            else:
                await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –¥–µ–º–æ: {message}")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    
    elif command == "extend" and len(args) >= 3:
        try:
            target_user_id = int(args[1])
            days = int(args[2])
            success = premium_db.extend_premium(target_user_id, days)
            
            if success:
                await update.message.reply_text(f"‚úÖ –ü—Ä–æ–¥–ª–µ–Ω–∞ –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user_id} –Ω–∞ {days} –¥–Ω–µ–π")
            else:
                await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {target_user_id}")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /premium_admin extend USER_ID DAYS")
    
    elif command == "check" and len(args) >= 2:
        try:
            target_user_id = int(args[1])
            user_info = premium_db.get_user_info(target_user_id)
            
            if user_info:
                is_premium, status = premium_db.check_premium_status(target_user_id)
                expire_date = user_info.get("expires_at", "")
                activated_date = user_info.get("activated_at", "")
                transaction_id = user_info.get("transaction_id", "N/A")
                demo_used = user_info.get("demo_used", False)
                is_demo = user_info.get("is_demo", False)
                
                status_text = {
                    "premium": "üíé –ü—Ä–µ–º–∏—É–º",
                    "demo": "üéØ –î–µ–º–æ-–≤–µ—Ä—Å–∏—è", 
                    "free": "üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π",
                    "expired": "‚è∞ –ò—Å—Ç—ë–∫"
                }.get(status, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π")
                
                message = (
                    f"üë§ **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ {target_user_id}**\n\n"
                    f"üî∏ –°—Ç–∞—Ç—É—Å: **{status_text}**\n"
                    f"üî∏ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –¥–µ–º–æ: **{'–î–∞' if demo_used else '–ù–µ—Ç'}**\n"
                    f"üìÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: **{activated_date.split('T')[0] if activated_date else 'N/A'}**\n"
                    f"‚è∞ –ò—Å—Ç–µ–∫–∞–µ—Ç: **{expire_date.split('T')[0] if expire_date else 'N/A'}**\n"
                    f"üßæ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: **{transaction_id}**"
                )
                
                await update.message.reply_text(message, parse_mode=ParseMode.MARKDOWN)
            else:
                await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /premium_admin check USER_ID")
    
    elif command == "cleanup":
        cleaned = premium_db.cleanup_expired()
        await update.message.reply_text(f"üßπ –û—á–∏—â–µ–Ω–æ {cleaned} –∏—Å—Ç–µ–∫—à–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫")
    
    elif command == "stats":
        stats = premium_db.get_stats()
        total_active = stats['active_premium'] + stats['active_demo']
        conversion_rate = total_active / max(stats['total_users'], 1) * 100
        demo_to_premium = stats['active_premium'] / max(stats['demo_used_total'], 1) * 100 if stats['demo_used_total'] > 0 else 0
        
        message = (
            f"üìä **–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**\n\n"
            f"üë• –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: **{stats['total_users']}**\n"
            f"üíé –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–º–∏—É–º: **{stats['active_premium']}**\n"
            f"üéØ –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–µ–º–æ: **{stats['active_demo']}**\n"
            f"üß™ –í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –¥–µ–º–æ: **{stats['demo_used_total']}**\n"
            f"‚è∞ –ò—Å—Ç–µ–∫—à–∏–µ: **{stats['expired_premium']}**\n"
            f"üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ: **{stats['free_users']}**\n\n"
            f"üìà **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:**\n"
            f"üí∞ –û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è: **{conversion_rate:.1f}%**\n"
            f"üéØ –ö–æ–Ω–≤–µ—Ä—Å–∏—è –¥–µ–º–æ‚Üí–ø—Ä–µ–º–∏—É–º: **{demo_to_premium:.1f}%**"
        )
        await update.message.reply_text(message, parse_mode=ParseMode.MARKDOWN)
    
    else:
        await update.message.reply_text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤")

async def premium_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /premium - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–º–∏—É–º–µ –∏ –∫–Ω–æ–ø–∫—É –ø–æ–∫—É–ø–∫–∏"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    is_premium, status = premium_db.check_premium_status(user_id)
    
    if is_premium:
        user_data = premium_db.get_user_info(user_id)
        expire_str = user_data.get("expires_at") if user_data else None
        
        if status == "demo":
            if expire_str:
                try:
                    from datetime import datetime
                    expire_time = datetime.fromisoformat(expire_str)
                    await update.message.reply_text(
                        f"üéØ **–£ –≤–∞—Å –∞–∫—Ç–∏–≤–Ω–∞ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è**\n\n"
                        f"‚è∞ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {expire_time.strftime('%d.%m.%Y –≤ %H:%M')}\n\n"
                        f"üíé –•–æ—Ç–∏—Ç–µ –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø? –ö—É–ø–∏—Ç–µ –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é!",
                        parse_mode='Markdown',
                        reply_markup=InlineKeyboardMarkup([
                            [InlineKeyboardButton("üí≥ –ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º (299‚ÇΩ)", callback_data="buy_premium")],
                            [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
                        ])
                    )
                except ValueError:
                    await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏")
            else:
                await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏")
        else:  # full premium
            if expire_str:
                try:
                    from datetime import datetime
                    expire_time = datetime.fromisoformat(expire_str)
                    await update.message.reply_text(
                        f"üíé **–£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∞!**\n\n"
                        f"‚è∞ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {expire_time.strftime('%d.%m.%Y –≤ %H:%M')}\n\n"
                        f"üéÆ –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –≤—Å–µ–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏!",
                        parse_mode='Markdown',
                        reply_markup=InlineKeyboardMarkup([
                            [InlineKeyboardButton("üéÆ –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É", callback_data="create_game")],
                            [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
                        ])
                    )
                except ValueError:
                    await update.message.reply_text("üíé **–£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∞!**")
            else:
                await update.message.reply_text("üíé **–£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–µ–º–∏—É–º-–ø–æ–¥–ø–∏—Å–∫–∞!**")
    else:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –ø—Ä–µ–º–∏—É–º–∞
        await update.message.reply_text(
            "üíé **–ü—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–∏:**\n\n"
            "‚Ä¢ **üé≠ –í—Å–µ —Ä–æ–ª–∏** (–î–æ–Ω –ú–∞—Ñ–∏–∏, –ú–∞–Ω—å—è–∫, –ü—É—Ç–∞–Ω–∞ –∏ –¥—Ä.)\n"
            "‚Ä¢ **üë• –î–æ 20 –∏–≥—Ä–æ–∫–æ–≤** –≤ –æ–¥–Ω–æ–π –∏–≥—Ä–µ (–≤–º–µ—Å—Ç–æ 8)\n"
            "‚Ä¢ **‚öôÔ∏è –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ–ª–µ–π**\n"
            "‚Ä¢ **üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**\n\n"
            "üí° **–ë–æ—Ç-–≤–µ–¥—É—â–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω –ë–ï–°–ü–õ–ê–¢–ù–û!**\n\n"
            f"**–¶–µ–Ω–∞: {PREMIUM_PRICE_RUBLES}‚ÇΩ**",
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üí≥ –ö—É–ø–∏—Ç—å –ø—Ä–µ–º–∏—É–º (299‚ÇΩ)", callback_data="buy_premium")],
                [InlineKeyboardButton("üéØ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–µ–º–æ (14 –¥–Ω–µ–π)", callback_data="activate_demo")],
                [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main")]
            ])
        )

if __name__ == '__main__':
    main() 